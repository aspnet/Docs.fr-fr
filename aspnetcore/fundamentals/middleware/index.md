---
title: Intergiciel (middleware) ASP.NET Core
author: rick-anderson
description: Découvrez l’intergiciel (middleware) ASP.NET Core et le pipeline de requête.
monikerRange: '>= aspnetcore-2.1'
ms.author: riande
ms.custom: mvc
ms.date: 07/15/2020
no-loc:
- 'appsettings.json'
- 'ASP.NET Core Identity'
- 'cookie'
- 'Cookie'
- 'Blazor'
- 'Blazor Server'
- 'Blazor WebAssembly'
- 'Identity'
- "Let's Encrypt"
- 'Razor'
- 'SignalR'
uid: fundamentals/middleware/index
ms.openlocfilehash: 06f55647ba2bb41152e16bb054e098abbe157cb8
ms.sourcegitcommit: ca34c1ac578e7d3daa0febf1810ba5fc74f60bbf
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 10/30/2020
ms.locfileid: "93059362"
---
# <a name="aspnet-core-middleware"></a><span data-ttu-id="e318c-103">Intergiciel (middleware) ASP.NET Core</span><span class="sxs-lookup"><span data-stu-id="e318c-103">ASP.NET Core Middleware</span></span>

::: moniker range=">= aspnetcore-3.0"

<span data-ttu-id="e318c-104">De [Rick Anderson](https://twitter.com/RickAndMSFT) et [Steve Smith](https://ardalis.com/)</span><span class="sxs-lookup"><span data-stu-id="e318c-104">By [Rick Anderson](https://twitter.com/RickAndMSFT) and [Steve Smith](https://ardalis.com/)</span></span>

<span data-ttu-id="e318c-105">Un middleware est un logiciel qui est assemblé dans un pipeline d’application pour gérer les requêtes et les réponses.</span><span class="sxs-lookup"><span data-stu-id="e318c-105">Middleware is software that's assembled into an app pipeline to handle requests and responses.</span></span> <span data-ttu-id="e318c-106">Chaque composant :</span><span class="sxs-lookup"><span data-stu-id="e318c-106">Each component:</span></span>

* <span data-ttu-id="e318c-107">Choisit de passer la requête au composant suivant dans le pipeline.</span><span class="sxs-lookup"><span data-stu-id="e318c-107">Chooses whether to pass the request to the next component in the pipeline.</span></span>
* <span data-ttu-id="e318c-108">Peut travailler avant et après le composant suivant dans le pipeline.</span><span class="sxs-lookup"><span data-stu-id="e318c-108">Can perform work before and after the next component in the pipeline.</span></span>

<span data-ttu-id="e318c-109">Les délégués de requête sont utilisés pour créer le pipeline de requête.</span><span class="sxs-lookup"><span data-stu-id="e318c-109">Request delegates are used to build the request pipeline.</span></span> <span data-ttu-id="e318c-110">Les délégués de requête gèrent chaque requête HTTP.</span><span class="sxs-lookup"><span data-stu-id="e318c-110">The request delegates handle each HTTP request.</span></span>

<span data-ttu-id="e318c-111">Les délégués de requête sont configurés à l’aide des méthodes d’extension <xref:Microsoft.AspNetCore.Builder.RunExtensions.Run%2A>, <xref:Microsoft.AspNetCore.Builder.MapExtensions.Map%2A> et <xref:Microsoft.AspNetCore.Builder.UseExtensions.Use%2A>.</span><span class="sxs-lookup"><span data-stu-id="e318c-111">Request delegates are configured using <xref:Microsoft.AspNetCore.Builder.RunExtensions.Run%2A>, <xref:Microsoft.AspNetCore.Builder.MapExtensions.Map%2A>, and <xref:Microsoft.AspNetCore.Builder.UseExtensions.Use%2A> extension methods.</span></span> <span data-ttu-id="e318c-112">Chaque délégué de requête peut être spécifié inline comme méthode anonyme (appelée intergiciel inline) ou peut être défini dans une classe réutilisable.</span><span class="sxs-lookup"><span data-stu-id="e318c-112">An individual request delegate can be specified in-line as an anonymous method (called in-line middleware), or it can be defined in a reusable class.</span></span> <span data-ttu-id="e318c-113">Ces classes réutilisables et les méthodes anonymes inline sont des *middlewares* , également appelés *composants de middleware* .</span><span class="sxs-lookup"><span data-stu-id="e318c-113">These reusable classes and in-line anonymous methods are *middleware* , also called *middleware components* .</span></span> <span data-ttu-id="e318c-114">Chaque composant de middleware du pipeline de requête est chargé d’appeler le composant suivant du pipeline ou de court-circuiter le pipeline.</span><span class="sxs-lookup"><span data-stu-id="e318c-114">Each middleware component in the request pipeline is responsible for invoking the next component in the pipeline or short-circuiting the pipeline.</span></span> <span data-ttu-id="e318c-115">Lorsqu’un middleware effectue un court-circuit, on parle de *middleware terminal* , car il empêche tout autre middleware de traiter la requête.</span><span class="sxs-lookup"><span data-stu-id="e318c-115">When a middleware short-circuits, it's called a *terminal middleware* because it prevents further middleware from processing the request.</span></span>

<span data-ttu-id="e318c-116"><xref:migration/http-modules> explique la différence entre les pipelines de requêtes dans ASP.NET Core et ASP.NET 4.x, puis fournit d’autres exemples de middlewares.</span><span class="sxs-lookup"><span data-stu-id="e318c-116"><xref:migration/http-modules> explains the difference between request pipelines in ASP.NET Core and ASP.NET 4.x and provides additional middleware samples.</span></span>

## <a name="create-a-middleware-pipeline-with-iapplicationbuilder"></a><span data-ttu-id="e318c-117">Créer un pipeline de middleware avec IApplicationBuilder</span><span class="sxs-lookup"><span data-stu-id="e318c-117">Create a middleware pipeline with IApplicationBuilder</span></span>

<span data-ttu-id="e318c-118">Le pipeline de requête ASP.NET Core est composé d’une séquence de délégués de requête, appelés l’un après l’autre.</span><span class="sxs-lookup"><span data-stu-id="e318c-118">The ASP.NET Core request pipeline consists of a sequence of request delegates, called one after the other.</span></span> <span data-ttu-id="e318c-119">Le diagramme suivant illustre le concept.</span><span class="sxs-lookup"><span data-stu-id="e318c-119">The following diagram demonstrates the concept.</span></span> <span data-ttu-id="e318c-120">Le thread d’exécution suit les flèches noires.</span><span class="sxs-lookup"><span data-stu-id="e318c-120">The thread of execution follows the black arrows.</span></span>

![Modèle de traitement des requêtes montrant une requête qui arrive et qui est traitée par trois middlewares, puis la réponse qui quitte l’application.](index/_static/request-delegate-pipeline.png)

<span data-ttu-id="e318c-124">Chaque délégué peut effectuer des opérations avant et après le délégué suivant.</span><span class="sxs-lookup"><span data-stu-id="e318c-124">Each delegate can perform operations before and after the next delegate.</span></span> <span data-ttu-id="e318c-125">Les délégués de gestion des exceptions doivent être appelés tôt dans le pipeline pour qu’ils puissent intercepter les exceptions qui se produisent dans les phases ultérieures du pipeline.</span><span class="sxs-lookup"><span data-stu-id="e318c-125">Exception-handling delegates should be called early in the pipeline, so they can catch exceptions that occur in later stages of the pipeline.</span></span>

<span data-ttu-id="e318c-126">L’application ASP.NET Core la plus simple possible définit un seul délégué de requête qui gère toutes les requêtes.</span><span class="sxs-lookup"><span data-stu-id="e318c-126">The simplest possible ASP.NET Core app sets up a single request delegate that handles all requests.</span></span> <span data-ttu-id="e318c-127">Ce cas ne fait pas appel à un pipeline de requête réel.</span><span class="sxs-lookup"><span data-stu-id="e318c-127">This case doesn't include an actual request pipeline.</span></span> <span data-ttu-id="e318c-128">À la place, une seule fonction anonyme est appelée en réponse à chaque requête HTTP.</span><span class="sxs-lookup"><span data-stu-id="e318c-128">Instead, a single anonymous function is called in response to every HTTP request.</span></span>

[!code-csharp[](index/snapshot/Middleware/Startup.cs)]

<span data-ttu-id="e318c-129">Chaînez plusieurs délégués de requête avec <xref:Microsoft.AspNetCore.Builder.UseExtensions.Use%2A>.</span><span class="sxs-lookup"><span data-stu-id="e318c-129">Chain multiple request delegates together with <xref:Microsoft.AspNetCore.Builder.UseExtensions.Use%2A>.</span></span> <span data-ttu-id="e318c-130">Le paramètre `next` représente le délégué suivant dans le pipeline.</span><span class="sxs-lookup"><span data-stu-id="e318c-130">The `next` parameter represents the next delegate in the pipeline.</span></span> <span data-ttu-id="e318c-131">Vous pouvez court-circuiter le pipeline en n’appelant *pas* le paramètre *next* .</span><span class="sxs-lookup"><span data-stu-id="e318c-131">You can short-circuit the pipeline by *not* calling the *next* parameter.</span></span> <span data-ttu-id="e318c-132">Vous pouvez généralement effectuer des actions à la fois avant et après le délégué suivant, comme illustré dans cet exemple :</span><span class="sxs-lookup"><span data-stu-id="e318c-132">You can typically perform actions both before and after the next delegate, as the following example demonstrates:</span></span>

[!code-csharp[](index/snapshot/Chain/Startup.cs?highlight=5-10)]

<span data-ttu-id="e318c-133">Quand un délégué ne passe pas une requête au délégué suivant, on parle alors de *court-circuit du pipeline de requête* .</span><span class="sxs-lookup"><span data-stu-id="e318c-133">When a delegate doesn't pass a request to the next delegate, it's called *short-circuiting the request pipeline* .</span></span> <span data-ttu-id="e318c-134">Un court-circuit est souvent souhaitable car il évite le travail inutile.</span><span class="sxs-lookup"><span data-stu-id="e318c-134">Short-circuiting is often desirable because it avoids unnecessary work.</span></span> <span data-ttu-id="e318c-135">Par exemple, le [middleware Fichier statique](xref:fundamentals/static-files) peut agir en tant que *middleware terminal* en traitant une requête pour un fichier statique et en court-circuitant le reste du pipeline.</span><span class="sxs-lookup"><span data-stu-id="e318c-135">For example, [Static File Middleware](xref:fundamentals/static-files) can act as a *terminal middleware* by processing a request for a static file and short-circuiting the rest of the pipeline.</span></span> <span data-ttu-id="e318c-136">Le middleware ajouté au pipeline avant de le middleware qui met fin à la poursuite du traitement traite tout de même le code après les instructions `next.Invoke`.</span><span class="sxs-lookup"><span data-stu-id="e318c-136">Middleware added to the pipeline before the middleware that terminates further processing still processes code after their `next.Invoke` statements.</span></span> <span data-ttu-id="e318c-137">Toutefois, consultez l’avertissement suivant à propos de la tentative d’écriture sur une réponse qui a déjà été envoyée.</span><span class="sxs-lookup"><span data-stu-id="e318c-137">However, see the following warning about attempting to write to a response that has already been sent.</span></span>

> [!WARNING]
> <span data-ttu-id="e318c-138">N’appelez pas `next.Invoke` une fois que la réponse a été envoyée au client.</span><span class="sxs-lookup"><span data-stu-id="e318c-138">Don't call `next.Invoke` after the response has been sent to the client.</span></span> <span data-ttu-id="e318c-139">Les changements apportés à <xref:Microsoft.AspNetCore.Http.HttpResponse> après le démarrage de la réponse lèvent une exception.</span><span class="sxs-lookup"><span data-stu-id="e318c-139">Changes to <xref:Microsoft.AspNetCore.Http.HttpResponse> after the response has started throw an exception.</span></span> <span data-ttu-id="e318c-140">Par exemple, [la définition d’en-têtes et d’un code d’État lève une exception](xref:performance/performance-best-practices#do-not-modify-the-status-code-or-headers-after-the-response-body-has-started).</span><span class="sxs-lookup"><span data-stu-id="e318c-140">For example, [setting headers and a status code throw an exception](xref:performance/performance-best-practices#do-not-modify-the-status-code-or-headers-after-the-response-body-has-started).</span></span> <span data-ttu-id="e318c-141">Écrire dans le corps de la réponse après avoir appelé `next` :</span><span class="sxs-lookup"><span data-stu-id="e318c-141">Writing to the response body after calling `next`:</span></span>
>
> * <span data-ttu-id="e318c-142">Peut entraîner une violation de protocole.</span><span class="sxs-lookup"><span data-stu-id="e318c-142">May cause a protocol violation.</span></span> <span data-ttu-id="e318c-143">Par exemple, écrire plus que le `Content-Length` indiqué.</span><span class="sxs-lookup"><span data-stu-id="e318c-143">For example, writing more than the stated `Content-Length`.</span></span>
> * <span data-ttu-id="e318c-144">Peut altérer le format du corps.</span><span class="sxs-lookup"><span data-stu-id="e318c-144">May corrupt the body format.</span></span> <span data-ttu-id="e318c-145">Par exemple, l’écriture d’un pied de page HTML dans un fichier CSS.</span><span class="sxs-lookup"><span data-stu-id="e318c-145">For example, writing an HTML footer to a CSS file.</span></span>
>
> <span data-ttu-id="e318c-146"><xref:Microsoft.AspNetCore.Http.HttpResponse.HasStarted%2A> est un indice utile pour indiquer si les en-têtes ont été envoyés ou si le corps a fait l’objet d’écritures.</span><span class="sxs-lookup"><span data-stu-id="e318c-146"><xref:Microsoft.AspNetCore.Http.HttpResponse.HasStarted%2A> is a useful hint to indicate if headers have been sent or the body has been written to.</span></span>

<span data-ttu-id="e318c-147"><xref:Microsoft.AspNetCore.Builder.RunExtensions.Run%2A> les délégués ne reçoivent pas de `next` paramètre.</span><span class="sxs-lookup"><span data-stu-id="e318c-147"><xref:Microsoft.AspNetCore.Builder.RunExtensions.Run%2A> delegates don't receive a `next` parameter.</span></span> <span data-ttu-id="e318c-148">Le premier `Run` délégué est toujours terminal et met fin au pipeline.</span><span class="sxs-lookup"><span data-stu-id="e318c-148">The first `Run` delegate is always terminal and terminates the pipeline.</span></span> <span data-ttu-id="e318c-149">`Run` est une convention.</span><span class="sxs-lookup"><span data-stu-id="e318c-149">`Run` is a convention.</span></span> <span data-ttu-id="e318c-150">Certains composants de l’intergiciel (middleware) peuvent exposer des `Run[Middleware]` méthodes qui s’exécutent à la fin du pipeline :</span><span class="sxs-lookup"><span data-stu-id="e318c-150">Some middleware components may expose `Run[Middleware]` methods that run at the end of the pipeline:</span></span>

[!code-csharp[](index/snapshot/Chain/Startup.cs?highlight=12-15)]
[!INCLUDE[about the series](~/includes/code-comments-loc.md)]

<span data-ttu-id="e318c-151">Dans l’exemple précédent, le `Run` délégué écrit `"Hello from 2nd delegate."` dans la réponse, puis termine le pipeline.</span><span class="sxs-lookup"><span data-stu-id="e318c-151">In the preceding example, the `Run` delegate writes `"Hello from 2nd delegate."` to the response and then terminates the pipeline.</span></span> <span data-ttu-id="e318c-152">Si un `Use` autre `Run` délégué ou est ajouté après le `Run` délégué, il n’est pas appelé.</span><span class="sxs-lookup"><span data-stu-id="e318c-152">If another `Use` or `Run` delegate is added after the `Run` delegate, it's not called.</span></span>

<a name="order"></a>

## <a name="middleware-order"></a><span data-ttu-id="e318c-153">Ordre des intergiciels (middleware)</span><span class="sxs-lookup"><span data-stu-id="e318c-153">Middleware order</span></span>

<span data-ttu-id="e318c-154">Le diagramme suivant illustre le pipeline de traitement des demandes complet pour ASP.NET Core les applications MVC et Razor pages.</span><span class="sxs-lookup"><span data-stu-id="e318c-154">The following diagram shows the complete request processing pipeline for ASP.NET Core MVC and Razor Pages apps.</span></span> <span data-ttu-id="e318c-155">Vous pouvez voir comment, dans une application classique, les intergiciels existants sont triés et où les intergiciels personnalisés sont ajoutés.</span><span class="sxs-lookup"><span data-stu-id="e318c-155">You can see how, in a typical app, existing middlewares are ordered and where custom middlewares are added.</span></span> <span data-ttu-id="e318c-156">Vous avez le contrôle total sur la manière de réorganiser les intergiciels existants ou d’injecter de nouvelles intergiciels personnalisées si nécessaire pour vos scénarios.</span><span class="sxs-lookup"><span data-stu-id="e318c-156">You have full control over how to reorder existing middlewares or inject new custom middlewares as necessary for your scenarios.</span></span>

![Pipeline de l’intergiciel (middleware) ASP.NET Core](index/_static/middleware-pipeline.svg)

<span data-ttu-id="e318c-158">L’intergiciel (middleware) du **point de terminaison** dans le diagramme précédent exécute le pipeline de filtre pour le type d’application correspondant &mdash; MVC ou les Razor pages.</span><span class="sxs-lookup"><span data-stu-id="e318c-158">The **Endpoint** middleware in the preceding diagram executes the filter pipeline for the corresponding app type&mdash;MVC or Razor Pages.</span></span>

![Pipeline de filtre ASP.NET Core](index/_static/mvc-endpoint.svg)

<span data-ttu-id="e318c-160">L’ordre dans lequel les composants de middleware sont ajoutés dans la méthode `Startup.Configure` définit l’ordre dans lequel ils sont appelés sur les requêtes et l’ordre inverse pour la réponse.</span><span class="sxs-lookup"><span data-stu-id="e318c-160">The order that middleware components are added in the `Startup.Configure` method defines the order in which the middleware components are invoked on requests and the reverse order for the response.</span></span> <span data-ttu-id="e318c-161">L’ordre est **essentiel** pour la sécurité, les performances et les fonctionnalités.</span><span class="sxs-lookup"><span data-stu-id="e318c-161">The order is **critical** for security, performance, and functionality.</span></span>

<span data-ttu-id="e318c-162">La `Startup.Configure` méthode suivante ajoute des composants d’intergiciel (middleware) liés à la sécurité dans l’ordre recommandé :</span><span class="sxs-lookup"><span data-stu-id="e318c-162">The following `Startup.Configure` method adds security-related middleware components in the recommended order:</span></span>

[!code-csharp[](index/snapshot/StartupAll3.cs?name=snippet)]

<span data-ttu-id="e318c-163">Dans le code précédent :</span><span class="sxs-lookup"><span data-stu-id="e318c-163">In the preceding code:</span></span>

* <span data-ttu-id="e318c-164">Les intergiciels (middleware) qui ne sont pas ajoutés lors de la création d’une nouvelle application Web avec des [comptes d’utilisateurs individuels](xref:security/authentication/identity) sont commentés.</span><span class="sxs-lookup"><span data-stu-id="e318c-164">Middleware that is not added when creating a new web app with [individual users accounts](xref:security/authentication/identity) is commented out.</span></span>
* <span data-ttu-id="e318c-165">Tous les intergiciels (middleware) ne doivent pas être placés dans cet ordre exact, mais beaucoup d’entre eux.</span><span class="sxs-lookup"><span data-stu-id="e318c-165">Not every middleware needs to go in this exact order, but many do.</span></span> <span data-ttu-id="e318c-166">Exemple :</span><span class="sxs-lookup"><span data-stu-id="e318c-166">For example:</span></span>
  * <span data-ttu-id="e318c-167">`UseCors`, `UseAuthentication` et `UseAuthorization` doivent être placés dans l’ordre indiqué.</span><span class="sxs-lookup"><span data-stu-id="e318c-167">`UseCors`, `UseAuthentication`, and `UseAuthorization` must go in the order shown.</span></span>
  * <span data-ttu-id="e318c-168">`UseCors``UseResponseCaching`la valeur doit être antérieure à [la suite de ce bogue](https://github.com/dotnet/aspnetcore/issues/23218).</span><span class="sxs-lookup"><span data-stu-id="e318c-168">`UseCors` currently must go before `UseResponseCaching` due to [this bug](https://github.com/dotnet/aspnetcore/issues/23218).</span></span>

<span data-ttu-id="e318c-169">La méthode `Startup.Configure` suivante ajoute des composants middleware utiles pour les scénarios d’application courants :</span><span class="sxs-lookup"><span data-stu-id="e318c-169">The following `Startup.Configure` method adds middleware components for common app scenarios:</span></span>

1. <span data-ttu-id="e318c-170">Gestion des erreurs/exceptions</span><span class="sxs-lookup"><span data-stu-id="e318c-170">Exception/error handling</span></span>
   * <span data-ttu-id="e318c-171">Quand l’application s’exécute dans l’environnement de développement :</span><span class="sxs-lookup"><span data-stu-id="e318c-171">When the app runs in the Development environment:</span></span>
     * <span data-ttu-id="e318c-172">Le middleware Page d’exceptions du développeur (<xref:Microsoft.AspNetCore.Builder.DeveloperExceptionPageExtensions.UseDeveloperExceptionPage%2A>) signale des erreurs de runtime de l’application.</span><span class="sxs-lookup"><span data-stu-id="e318c-172">Developer Exception Page Middleware (<xref:Microsoft.AspNetCore.Builder.DeveloperExceptionPageExtensions.UseDeveloperExceptionPage%2A>) reports app runtime errors.</span></span>
     * <span data-ttu-id="e318c-173">L’intergiciel (middleware) de page d’erreur de base de données signale des erreurs d’exécution.</span><span class="sxs-lookup"><span data-stu-id="e318c-173">Database Error Page Middleware reports database runtime errors.</span></span>
   * <span data-ttu-id="e318c-174">Quand l’application s’exécute dans l’environnement de production :</span><span class="sxs-lookup"><span data-stu-id="e318c-174">When the app runs in the Production environment:</span></span>
     * <span data-ttu-id="e318c-175">Le middleware Gestionnaire d'exceptions (<xref:Microsoft.AspNetCore.Builder.ExceptionHandlerExtensions.UseExceptionHandler%2A>) intercepte des exceptions levées dans les middlewares suivants.</span><span class="sxs-lookup"><span data-stu-id="e318c-175">Exception Handler Middleware (<xref:Microsoft.AspNetCore.Builder.ExceptionHandlerExtensions.UseExceptionHandler%2A>) catches exceptions thrown in the following middlewares.</span></span>
     * <span data-ttu-id="e318c-176">Le middleware Protocole HSTS (HTTP Strict Transport Security) (<xref:Microsoft.AspNetCore.Builder.HstsBuilderExtensions.UseHsts%2A>) ajoute l’en-tête `Strict-Transport-Security`.</span><span class="sxs-lookup"><span data-stu-id="e318c-176">HTTP Strict Transport Security Protocol (HSTS) Middleware (<xref:Microsoft.AspNetCore.Builder.HstsBuilderExtensions.UseHsts%2A>) adds the `Strict-Transport-Security` header.</span></span>
1. <span data-ttu-id="e318c-177">Le middleware Redirection HTTPS (<xref:Microsoft.AspNetCore.Builder.HttpsPolicyBuilderExtensions.UseHttpsRedirection%2A>) redirige les requêtes HTTP vers HTTPS.</span><span class="sxs-lookup"><span data-stu-id="e318c-177">HTTPS Redirection Middleware (<xref:Microsoft.AspNetCore.Builder.HttpsPolicyBuilderExtensions.UseHttpsRedirection%2A>) redirects HTTP requests to HTTPS.</span></span>
1. <span data-ttu-id="e318c-178">Le middleware Fichier statique (<xref:Microsoft.AspNetCore.Builder.StaticFileExtensions.UseStaticFiles%2A>) retourne des fichiers statiques et court-circuite tout traitement supplémentaire de la requête.</span><span class="sxs-lookup"><span data-stu-id="e318c-178">Static File Middleware (<xref:Microsoft.AspNetCore.Builder.StaticFileExtensions.UseStaticFiles%2A>) returns static files and short-circuits further request processing.</span></span>
1. <span data-ttu-id="e318c-179">Cookie L’intergiciel ( <xref:Microsoft.AspNetCore.Builder.CookiePolicyAppBuilderExtensions.UseCookiePolicy%2A> ) de stratégie convertit l’application en RGPD (union Règlement général sur la protection des données européenne).</span><span class="sxs-lookup"><span data-stu-id="e318c-179">Cookie Policy Middleware (<xref:Microsoft.AspNetCore.Builder.CookiePolicyAppBuilderExtensions.UseCookiePolicy%2A>) conforms the app to the EU General Data Protection Regulation (GDPR) regulations.</span></span>
1. <span data-ttu-id="e318c-180">Intergiciel (middleware <xref:Microsoft.AspNetCore.Builder.EndpointRoutingApplicationBuilderExtensions.UseRouting%2A> ) de routage () pour acheminer les demandes.</span><span class="sxs-lookup"><span data-stu-id="e318c-180">Routing Middleware (<xref:Microsoft.AspNetCore.Builder.EndpointRoutingApplicationBuilderExtensions.UseRouting%2A>) to route requests.</span></span>
1. <span data-ttu-id="e318c-181">Le middleware Authentification (<xref:Microsoft.AspNetCore.Builder.AuthAppBuilderExtensions.UseAuthentication%2A>) tente d’authentifier l’utilisateur avant qu’il ne soit autorisé à accéder aux ressources sécurisées.</span><span class="sxs-lookup"><span data-stu-id="e318c-181">Authentication Middleware (<xref:Microsoft.AspNetCore.Builder.AuthAppBuilderExtensions.UseAuthentication%2A>) attempts to authenticate the user before they're allowed access to secure resources.</span></span>
1. <span data-ttu-id="e318c-182">L’intergiciel () d’autorisation <xref:Microsoft.AspNetCore.Builder.AuthorizationAppBuilderExtensions.UseAuthorization%2A> autorise un utilisateur à accéder à des ressources sécurisées.</span><span class="sxs-lookup"><span data-stu-id="e318c-182">Authorization Middleware (<xref:Microsoft.AspNetCore.Builder.AuthorizationAppBuilderExtensions.UseAuthorization%2A>) authorizes a user to access secure resources.</span></span>
1. <span data-ttu-id="e318c-183">Le middleware Session (<xref:Microsoft.AspNetCore.Builder.SessionMiddlewareExtensions.UseSession%2A>) établit et maintient l’état de la session.</span><span class="sxs-lookup"><span data-stu-id="e318c-183">Session Middleware (<xref:Microsoft.AspNetCore.Builder.SessionMiddlewareExtensions.UseSession%2A>) establishes and maintains session state.</span></span> <span data-ttu-id="e318c-184">Si l’application utilise l’état de session, appelez l’intergiciel (middleware) de session après l’intergiciel (middleware) Cookie de stratégie et avant l’intergiciel (middleware) Mvc.</span><span class="sxs-lookup"><span data-stu-id="e318c-184">If the app uses session state, call Session Middleware after Cookie Policy Middleware and before MVC Middleware.</span></span>
1. <span data-ttu-id="e318c-185">Intergiciel (middleware) de routage des points de terminaison ( <xref:Microsoft.AspNetCore.Builder.EndpointRoutingApplicationBuilderExtensions.UseEndpoints%2A> avec <xref:Microsoft.AspNetCore.Builder.RazorPagesEndpointRouteBuilderExtensions.MapRazorPages%2A> ) pour ajouter des Razor points de terminaison de pages au pipeline de requête.</span><span class="sxs-lookup"><span data-stu-id="e318c-185">Endpoint Routing Middleware (<xref:Microsoft.AspNetCore.Builder.EndpointRoutingApplicationBuilderExtensions.UseEndpoints%2A> with <xref:Microsoft.AspNetCore.Builder.RazorPagesEndpointRouteBuilderExtensions.MapRazorPages%2A>) to add Razor Pages endpoints to the request pipeline.</span></span>

<!--

FUTURE UPDATE

On the next topic overhaul/release update, add API crosslink to "Database Error Page Middleware" in Item 1 of the list ...

Microsoft.AspNetCore.Builder.DatabaseErrorPageExtensions.UseDatabaseErrorPage*

... when available via the API docs.

-->

```csharp
public void Configure(IApplicationBuilder app, IWebHostEnvironment env)
{
    if (env.IsDevelopment())
    {
        app.UseDeveloperExceptionPage();
        app.UseDatabaseErrorPage();
    }
    else
    {
        app.UseExceptionHandler("/Error");
        app.UseHsts();
    }

    app.UseHttpsRedirection();
    app.UseStaticFiles();
    app.UseCookiePolicy();
    app.UseRouting();
    app.UseAuthentication();
    app.UseAuthorization();
    app.UseSession();

    app.UseEndpoints(endpoints =>
    {
        endpoints.MapRazorPages();
    });
}
```

<span data-ttu-id="e318c-186">Dans l’exemple de code précédent, chaque méthode d’extension d’intergiciel (middleware) est exposée sur <xref:Microsoft.AspNetCore.Builder.IApplicationBuilder> à travers l’espace de noms <xref:Microsoft.AspNetCore.Builder?displayProperty=fullName>.</span><span class="sxs-lookup"><span data-stu-id="e318c-186">In the preceding example code, each middleware extension method is exposed on <xref:Microsoft.AspNetCore.Builder.IApplicationBuilder> through the <xref:Microsoft.AspNetCore.Builder?displayProperty=fullName> namespace.</span></span>

<span data-ttu-id="e318c-187"><xref:Microsoft.AspNetCore.Builder.ExceptionHandlerExtensions.UseExceptionHandler%2A> est le premier composant d’intergiciel ajouté au pipeline.</span><span class="sxs-lookup"><span data-stu-id="e318c-187"><xref:Microsoft.AspNetCore.Builder.ExceptionHandlerExtensions.UseExceptionHandler%2A> is the first middleware component added to the pipeline.</span></span> <span data-ttu-id="e318c-188">Par conséquent, le middleware Gestion des exceptions intercepte toutes les exceptions qui se produisent dans les appels ultérieurs.</span><span class="sxs-lookup"><span data-stu-id="e318c-188">Therefore, the Exception Handler Middleware catches any exceptions that occur in later calls.</span></span>

<span data-ttu-id="e318c-189">Le middleware Fichier statique est appelé tôt dans le pipeline pour qu’il puisse gérer les requêtes et procéder au court-circuit sans passer par les composants restants.</span><span class="sxs-lookup"><span data-stu-id="e318c-189">Static File Middleware is called early in the pipeline so that it can handle requests and short-circuit without going through the remaining components.</span></span> <span data-ttu-id="e318c-190">Le middleware de fichiers statiques **ne fournit aucune** vérification d’autorisation.</span><span class="sxs-lookup"><span data-stu-id="e318c-190">The Static File Middleware provides **no** authorization checks.</span></span> <span data-ttu-id="e318c-191">Tous les fichiers pris en charge par l’intergiciel (middleware) de fichiers statiques, y compris ceux qui se trouvent sous *wwwroot* , sont disponibles publiquement.</span><span class="sxs-lookup"><span data-stu-id="e318c-191">Any files served by Static File Middleware, including those under *wwwroot* , are publicly available.</span></span> <span data-ttu-id="e318c-192">Pour obtenir une approche permettant de sécuriser les fichiers statiques, consultez <xref:fundamentals/static-files>.</span><span class="sxs-lookup"><span data-stu-id="e318c-192">For an approach to secure static files, see <xref:fundamentals/static-files>.</span></span>

<span data-ttu-id="e318c-193">Si la requête n’est pas gérée par le middleware Fichier statique, elle est transmise au middleware Authentification (<xref:Microsoft.AspNetCore.Builder.AuthAppBuilderExtensions.UseAuthentication%2A>), qui effectue l’authentification.</span><span class="sxs-lookup"><span data-stu-id="e318c-193">If the request isn't handled by the Static File Middleware, it's passed on to the Authentication Middleware (<xref:Microsoft.AspNetCore.Builder.AuthAppBuilderExtensions.UseAuthentication%2A>), which performs authentication.</span></span> <span data-ttu-id="e318c-194">Le middleware Authentification ne court-circuite pas les requêtes non authentifiées.</span><span class="sxs-lookup"><span data-stu-id="e318c-194">Authentication doesn't short-circuit unauthenticated requests.</span></span> <span data-ttu-id="e318c-195">Bien que l’intergiciel d’authentification authentifie les demandes, l’autorisation (et le rejet) se produit uniquement lorsque MVC sélectionne une Razor page ou un contrôleur MVC et une action spécifiques.</span><span class="sxs-lookup"><span data-stu-id="e318c-195">Although Authentication Middleware authenticates requests, authorization (and rejection) occurs only after MVC selects a specific Razor Page or MVC controller and action.</span></span>

<span data-ttu-id="e318c-196">L’exemple suivant montre un ordre de middlewares où les requêtes pour les fichiers statiques sont gérées par le middleware Fichier statique avant le middleware Compression de la réponse.</span><span class="sxs-lookup"><span data-stu-id="e318c-196">The following example demonstrates a middleware order where requests for static files are handled by Static File Middleware before Response Compression Middleware.</span></span> <span data-ttu-id="e318c-197">Les fichiers statiques ne sont pas compressés avec cet ordre de middlewares.</span><span class="sxs-lookup"><span data-stu-id="e318c-197">Static files aren't compressed with this middleware order.</span></span> <span data-ttu-id="e318c-198">Les Razor réponses de pages peuvent être compressées.</span><span class="sxs-lookup"><span data-stu-id="e318c-198">The Razor Pages responses can be compressed.</span></span>

```csharp
public void Configure(IApplicationBuilder app)
{
    // Static files aren't compressed by Static File Middleware.
    app.UseStaticFiles();

    app.UseResponseCompression();

    app.UseEndpoints(endpoints =>
    {
        endpoints.MapRazorPages();
    });
}
```

<span data-ttu-id="e318c-199">Pour les applications à page unique (SPAs), l’intergiciel (middleware) SPA <xref:Microsoft.Extensions.DependencyInjection.SpaStaticFilesExtensions.UseSpaStaticFiles%2A> vient généralement en dernier dans le pipeline de l’intergiciel (middleware).</span><span class="sxs-lookup"><span data-stu-id="e318c-199">For Single Page Applications (SPAs), the SPA middleware <xref:Microsoft.Extensions.DependencyInjection.SpaStaticFilesExtensions.UseSpaStaticFiles%2A> usually comes last in the middleware pipeline.</span></span> <span data-ttu-id="e318c-200">L’intergiciel (middleware) SPA est le dernier :</span><span class="sxs-lookup"><span data-stu-id="e318c-200">The SPA middleware comes last:</span></span>

* <span data-ttu-id="e318c-201">Pour permettre à tous les autres intergiciels de répondre d’abord aux demandes correspondantes.</span><span class="sxs-lookup"><span data-stu-id="e318c-201">To allow all other middlewares to respond to matching requests first.</span></span>
* <span data-ttu-id="e318c-202">Pour autoriser l’exécution de la fonction de routage de l’application serveur pour tous les itinéraires non reconnus par l’application serveur.</span><span class="sxs-lookup"><span data-stu-id="e318c-202">To allow SPAs with client-side routing to run for all routes that are unrecognized by the server app.</span></span>

<span data-ttu-id="e318c-203">Pour plus d’informations sur les modèles de projet [rereact](xref:spa/react) et [angulaire](xref:spa/angular) , consultez les guides.</span><span class="sxs-lookup"><span data-stu-id="e318c-203">For more details on SPAs, see the guides for the [React](xref:spa/react) and [Angular](xref:spa/angular) project templates.</span></span>

### <a name="forwarded-headers-middleware-order"></a><span data-ttu-id="e318c-204">Ordre intergiciel des en-têtes transférés</span><span class="sxs-lookup"><span data-stu-id="e318c-204">Forwarded Headers Middleware order</span></span>

[!INCLUDE[](~/includes/ForwardedHeaders.md)]

## <a name="branch-the-middleware-pipeline"></a><span data-ttu-id="e318c-205">Créer une branche pour le pipeline de l’intergiciel</span><span class="sxs-lookup"><span data-stu-id="e318c-205">Branch the middleware pipeline</span></span>

<span data-ttu-id="e318c-206">Les extensions <xref:Microsoft.AspNetCore.Builder.MapExtensions.Map%2A> sont utilisées comme convention pour créer une branche dans le pipeline.</span><span class="sxs-lookup"><span data-stu-id="e318c-206"><xref:Microsoft.AspNetCore.Builder.MapExtensions.Map%2A> extensions are used as a convention for branching the pipeline.</span></span> <span data-ttu-id="e318c-207">`Map` crée une branche dans le pipeline de requête en fonction des correspondances du chemin de requête donné.</span><span class="sxs-lookup"><span data-stu-id="e318c-207">`Map` branches the request pipeline based on matches of the given request path.</span></span> <span data-ttu-id="e318c-208">Si le chemin de requête commence par le chemin donné, la branche est exécutée.</span><span class="sxs-lookup"><span data-stu-id="e318c-208">If the request path starts with the given path, the branch is executed.</span></span>

[!code-csharp[](index/snapshot/Chain/StartupMap.cs)]

<span data-ttu-id="e318c-209">Le tableau suivant présente les requêtes et les réponses de `http://localhost:1234` avec le code précédent.</span><span class="sxs-lookup"><span data-stu-id="e318c-209">The following table shows the requests and responses from `http://localhost:1234` using the previous code.</span></span>

| <span data-ttu-id="e318c-210">Requête</span><span class="sxs-lookup"><span data-stu-id="e318c-210">Request</span></span>             | <span data-ttu-id="e318c-211">response</span><span class="sxs-lookup"><span data-stu-id="e318c-211">Response</span></span>                     |
| ------------------- | ---------------------------- |
| <span data-ttu-id="e318c-212">localhost:1234</span><span class="sxs-lookup"><span data-stu-id="e318c-212">localhost:1234</span></span>      | <span data-ttu-id="e318c-213">Hello from non-Map delegate.</span><span class="sxs-lookup"><span data-stu-id="e318c-213">Hello from non-Map delegate.</span></span> |
| <span data-ttu-id="e318c-214">localhost:1234/map1</span><span class="sxs-lookup"><span data-stu-id="e318c-214">localhost:1234/map1</span></span> | <span data-ttu-id="e318c-215">Map Test 1</span><span class="sxs-lookup"><span data-stu-id="e318c-215">Map Test 1</span></span>                   |
| <span data-ttu-id="e318c-216">localhost:1234/map2</span><span class="sxs-lookup"><span data-stu-id="e318c-216">localhost:1234/map2</span></span> | <span data-ttu-id="e318c-217">Map Test 2</span><span class="sxs-lookup"><span data-stu-id="e318c-217">Map Test 2</span></span>                   |
| <span data-ttu-id="e318c-218">localhost:1234/map3</span><span class="sxs-lookup"><span data-stu-id="e318c-218">localhost:1234/map3</span></span> | <span data-ttu-id="e318c-219">Hello from non-Map delegate.</span><span class="sxs-lookup"><span data-stu-id="e318c-219">Hello from non-Map delegate.</span></span> |

<span data-ttu-id="e318c-220">Quand `Map` est utilisé, les segments de chemin mis en correspondance sont supprimés de `HttpRequest.Path` et ajoutés à `HttpRequest.PathBase` pour chaque requête.</span><span class="sxs-lookup"><span data-stu-id="e318c-220">When `Map` is used, the matched path segments are removed from `HttpRequest.Path` and appended to `HttpRequest.PathBase` for each request.</span></span>

<span data-ttu-id="e318c-221">`Map` prend en charge l’imbrication, par exemple :</span><span class="sxs-lookup"><span data-stu-id="e318c-221">`Map` supports nesting, for example:</span></span>

```csharp
app.Map("/level1", level1App => {
    level1App.Map("/level2a", level2AApp => {
        // "/level1/level2a" processing
    });
    level1App.Map("/level2b", level2BApp => {
        // "/level1/level2b" processing
    });
});
```

<span data-ttu-id="e318c-222">`Map` peut également faire correspondre plusieurs segments à la fois :</span><span class="sxs-lookup"><span data-stu-id="e318c-222">`Map` can also match multiple segments at once:</span></span>

[!code-csharp[](index/snapshot/Chain/StartupMultiSeg.cs?highlight=13)]

<span data-ttu-id="e318c-223"><xref:Microsoft.AspNetCore.Builder.MapWhenExtensions.MapWhen%2A> crée une branche dans le pipeline de requête en fonction du résultat du prédicat donné.</span><span class="sxs-lookup"><span data-stu-id="e318c-223"><xref:Microsoft.AspNetCore.Builder.MapWhenExtensions.MapWhen%2A> branches the request pipeline based on the result of the given predicate.</span></span> <span data-ttu-id="e318c-224">Un prédicat de type `Func<HttpContext, bool>` peut être utilisé pour mapper les requêtes à une nouvelle branche du pipeline.</span><span class="sxs-lookup"><span data-stu-id="e318c-224">Any predicate of type `Func<HttpContext, bool>` can be used to map requests to a new branch of the pipeline.</span></span> <span data-ttu-id="e318c-225">Dans l’exemple suivant, un prédicat est utilisé pour détecter la présence d’une variable de chaîne de requête `branch` :</span><span class="sxs-lookup"><span data-stu-id="e318c-225">In the following example, a predicate is used to detect the presence of a query string variable `branch`:</span></span>

[!code-csharp[](index/snapshot/Chain/StartupMapWhen.cs?highlight=14-15)]

<span data-ttu-id="e318c-226">Le tableau suivant présente les requêtes et les réponses de `http://localhost:1234` avec le code précédent :</span><span class="sxs-lookup"><span data-stu-id="e318c-226">The following table shows the requests and responses from `http://localhost:1234` using the previous code:</span></span>

| <span data-ttu-id="e318c-227">Requête</span><span class="sxs-lookup"><span data-stu-id="e318c-227">Request</span></span>                       | <span data-ttu-id="e318c-228">response</span><span class="sxs-lookup"><span data-stu-id="e318c-228">Response</span></span>                     |
| ----------------------------- | ---------------------------- |
| <span data-ttu-id="e318c-229">localhost:1234</span><span class="sxs-lookup"><span data-stu-id="e318c-229">localhost:1234</span></span>                | <span data-ttu-id="e318c-230">Hello from non-Map delegate.</span><span class="sxs-lookup"><span data-stu-id="e318c-230">Hello from non-Map delegate.</span></span> |
| <span data-ttu-id="e318c-231">localhost:1234/?branch=master</span><span class="sxs-lookup"><span data-stu-id="e318c-231">localhost:1234/?branch=master</span></span> | <span data-ttu-id="e318c-232">Branch used = master</span><span class="sxs-lookup"><span data-stu-id="e318c-232">Branch used = master</span></span>         |

<span data-ttu-id="e318c-233"><xref:Microsoft.AspNetCore.Builder.UseWhenExtensions.UseWhen%2A> branche également le pipeline de requêtes en fonction du résultat du prédicat donné.</span><span class="sxs-lookup"><span data-stu-id="e318c-233"><xref:Microsoft.AspNetCore.Builder.UseWhenExtensions.UseWhen%2A> also branches the request pipeline based on the result of the given predicate.</span></span> <span data-ttu-id="e318c-234">Contrairement à `MapWhen` , cette branche est rejointe au pipeline principal s’il n’y a pas de court-circuit ou qu’il contient un intergiciel (middleware) de terminal :</span><span class="sxs-lookup"><span data-stu-id="e318c-234">Unlike with `MapWhen`, this branch is rejoined to the main pipeline if it doesn't short-circuit or contain a terminal middleware:</span></span>

[!code-csharp[](index/snapshot/Chain/StartupUseWhen.cs?highlight=25-26)]

<span data-ttu-id="e318c-235">Dans l’exemple précédent, une réponse « hello from principal pipeline ».</span><span class="sxs-lookup"><span data-stu-id="e318c-235">In the preceding example, a response of "Hello from main pipeline."</span></span> <span data-ttu-id="e318c-236">est écrit pour toutes les demandes.</span><span class="sxs-lookup"><span data-stu-id="e318c-236">is written for all requests.</span></span> <span data-ttu-id="e318c-237">Si la requête comprend une variable de chaîne de requête `branch` , sa valeur est consignée avant que le pipeline principal soit rejoint.</span><span class="sxs-lookup"><span data-stu-id="e318c-237">If the request includes a query string variable `branch`, its value is logged before the main pipeline is rejoined.</span></span>

## <a name="built-in-middleware"></a><span data-ttu-id="e318c-238">Intergiciels (middleware) intégrés</span><span class="sxs-lookup"><span data-stu-id="e318c-238">Built-in middleware</span></span>

<span data-ttu-id="e318c-239">ASP.NET Core est fourni avec les composants de middleware suivant.</span><span class="sxs-lookup"><span data-stu-id="e318c-239">ASP.NET Core ships with the following middleware components.</span></span> <span data-ttu-id="e318c-240">La colonne *Ordre* fournit des notes sur l’emplacement du middleware dans le pipeline de traitement de la requête et sur les conditions dans lesquelles le middleware peut mettre fin au traitement de la requête.</span><span class="sxs-lookup"><span data-stu-id="e318c-240">The *Order* column provides notes on middleware placement in the request processing pipeline and under what conditions the middleware may terminate request processing.</span></span> <span data-ttu-id="e318c-241">Lorsqu’un middleware court-circuite le pipeline de traitement de la requête et empêche tout middleware en aval de traiter une requête, on parle de *middleware terminal* .</span><span class="sxs-lookup"><span data-stu-id="e318c-241">When a middleware short-circuits the request processing pipeline and prevents further downstream middleware from processing a request, it's called a *terminal middleware* .</span></span> <span data-ttu-id="e318c-242">Pour plus d’informations sur le court-circuit, consultez la section [Créer un pipeline de middlewares avec IApplicationBuilder](#create-a-middleware-pipeline-with-iapplicationbuilder).</span><span class="sxs-lookup"><span data-stu-id="e318c-242">For more information on short-circuiting, see the [Create a middleware pipeline with IApplicationBuilder](#create-a-middleware-pipeline-with-iapplicationbuilder) section.</span></span>

| <span data-ttu-id="e318c-243">Middleware</span><span class="sxs-lookup"><span data-stu-id="e318c-243">Middleware</span></span> | <span data-ttu-id="e318c-244">Description</span><span class="sxs-lookup"><span data-stu-id="e318c-244">Description</span></span> | <span data-ttu-id="e318c-245">JSON</span><span class="sxs-lookup"><span data-stu-id="e318c-245">Order</span></span> |
| ---------- | ----------- | ----- |
| [<span data-ttu-id="e318c-246">Authentification</span><span class="sxs-lookup"><span data-stu-id="e318c-246">Authentication</span></span>](xref:security/authentication/identity) | <span data-ttu-id="e318c-247">Prend en charge l’authentification.</span><span class="sxs-lookup"><span data-stu-id="e318c-247">Provides authentication support.</span></span> | <span data-ttu-id="e318c-248">Avant que `HttpContext.User` ne soit nécessaire.</span><span class="sxs-lookup"><span data-stu-id="e318c-248">Before `HttpContext.User` is needed.</span></span> <span data-ttu-id="e318c-249">Terminal pour les rappels OAuth.</span><span class="sxs-lookup"><span data-stu-id="e318c-249">Terminal for OAuth callbacks.</span></span> |
| [<span data-ttu-id="e318c-250">Autorisation</span><span class="sxs-lookup"><span data-stu-id="e318c-250">Authorization</span></span>](xref:Microsoft.AspNetCore.Builder.AuthorizationAppBuilderExtensions.UseAuthorization%2A) | <span data-ttu-id="e318c-251">Fournit la prise en charge des autorisations.</span><span class="sxs-lookup"><span data-stu-id="e318c-251">Provides authorization support.</span></span> | <span data-ttu-id="e318c-252">Immédiatement après l’intergiciel (middleware) d’authentification.</span><span class="sxs-lookup"><span data-stu-id="e318c-252">Immediately after the Authentication Middleware.</span></span> |
| [<span data-ttu-id="e318c-253">Cookie Renvoi</span><span class="sxs-lookup"><span data-stu-id="e318c-253">Cookie Policy</span></span>](xref:security/gdpr) | <span data-ttu-id="e318c-254">Effectue le suivi du consentement des utilisateurs pour le stockage des informations personnelles et applique les normes minimales pour les cookie champs, tels que `secure` et `SameSite` .</span><span class="sxs-lookup"><span data-stu-id="e318c-254">Tracks consent from users for storing personal information and enforces minimum standards for cookie fields, such as `secure` and `SameSite`.</span></span> | <span data-ttu-id="e318c-255">Avant l’intergiciel (middleware) qui émet cookie s.</span><span class="sxs-lookup"><span data-stu-id="e318c-255">Before middleware that issues cookies.</span></span> <span data-ttu-id="e318c-256">Exemples : authentification, session, MVC (TempData).</span><span class="sxs-lookup"><span data-stu-id="e318c-256">Examples: Authentication, Session, MVC (TempData).</span></span> |
| [<span data-ttu-id="e318c-257">CORS</span><span class="sxs-lookup"><span data-stu-id="e318c-257">CORS</span></span>](xref:security/cors) | <span data-ttu-id="e318c-258">Configure le partage des ressources cross-origin (CORS).</span><span class="sxs-lookup"><span data-stu-id="e318c-258">Configures Cross-Origin Resource Sharing.</span></span> | <span data-ttu-id="e318c-259">Avant les composants qui utilisent CORS.</span><span class="sxs-lookup"><span data-stu-id="e318c-259">Before components that use CORS.</span></span> <span data-ttu-id="e318c-260">`UseCors``UseResponseCaching`la valeur doit être antérieure à [la suite de ce bogue](https://github.com/dotnet/aspnetcore/issues/23218).</span><span class="sxs-lookup"><span data-stu-id="e318c-260">`UseCors` currently must go before `UseResponseCaching` due to [this bug](https://github.com/dotnet/aspnetcore/issues/23218).</span></span>|
| [<span data-ttu-id="e318c-261">Diagnostics</span><span class="sxs-lookup"><span data-stu-id="e318c-261">Diagnostics</span></span>](xref:fundamentals/error-handling) | <span data-ttu-id="e318c-262">Plusieurs intergiciels distincts qui fournissent une page d’exception de développeur, la gestion des exceptions, les pages de codes d’État et la page Web par défaut pour les nouvelles applications.</span><span class="sxs-lookup"><span data-stu-id="e318c-262">Several separate middlewares that provide a developer exception page, exception handling, status code pages, and the default web page for new apps.</span></span> | <span data-ttu-id="e318c-263">Avant les composants qui génèrent des erreurs.</span><span class="sxs-lookup"><span data-stu-id="e318c-263">Before components that generate errors.</span></span> <span data-ttu-id="e318c-264">Terminal pour les exceptions ou service de la page Web par défaut pour les nouvelles applications.</span><span class="sxs-lookup"><span data-stu-id="e318c-264">Terminal for exceptions or serving the default web page for new apps.</span></span> |
| [<span data-ttu-id="e318c-265">En-têtes transférés</span><span class="sxs-lookup"><span data-stu-id="e318c-265">Forwarded Headers</span></span>](xref:host-and-deploy/proxy-load-balancer) | <span data-ttu-id="e318c-266">Transfère les en-têtes en proxy vers la requête actuelle.</span><span class="sxs-lookup"><span data-stu-id="e318c-266">Forwards proxied headers onto the current request.</span></span> | <span data-ttu-id="e318c-267">Avant les composants qui consomment les champs mis à jour.</span><span class="sxs-lookup"><span data-stu-id="e318c-267">Before components that consume the updated fields.</span></span> <span data-ttu-id="e318c-268">Exemples : schéma, hôte, IP du client, méthode.</span><span class="sxs-lookup"><span data-stu-id="e318c-268">Examples: scheme, host, client IP, method.</span></span> |
| [<span data-ttu-id="e318c-269">Contrôle d’intégrité</span><span class="sxs-lookup"><span data-stu-id="e318c-269">Health Check</span></span>](xref:host-and-deploy/health-checks) | <span data-ttu-id="e318c-270">Contrôle l’intégrité d’une application ASP.NET Core et de ses dépendances, notamment la disponibilité de la base de données.</span><span class="sxs-lookup"><span data-stu-id="e318c-270">Checks the health of an ASP.NET Core app and its dependencies, such as checking database availability.</span></span> | <span data-ttu-id="e318c-271">Terminal si une requête correspond à un point de terminaison de contrôle d’intégrité.</span><span class="sxs-lookup"><span data-stu-id="e318c-271">Terminal if a request matches a health check endpoint.</span></span> |
| [<span data-ttu-id="e318c-272">Propagation d’en-tête</span><span class="sxs-lookup"><span data-stu-id="e318c-272">Header Propagation</span></span>](xref:fundamentals/http-requests#header-propagation-middleware) | <span data-ttu-id="e318c-273">Propage les en-têtes HTTP de la demande entrante aux demandes du client HTTP sortantes.</span><span class="sxs-lookup"><span data-stu-id="e318c-273">Propagates HTTP headers from the incoming request to the outgoing HTTP Client requests.</span></span> |
| [<span data-ttu-id="e318c-274">Remplacement de la méthode HTTP</span><span class="sxs-lookup"><span data-stu-id="e318c-274">HTTP Method Override</span></span>](xref:Microsoft.AspNetCore.Builder.HttpMethodOverrideExtensions) | <span data-ttu-id="e318c-275">Autorise une requête POST entrante à remplacer la méthode.</span><span class="sxs-lookup"><span data-stu-id="e318c-275">Allows an incoming POST request to override the method.</span></span> | <span data-ttu-id="e318c-276">Avant les composants qui consomment la méthode mise à jour.</span><span class="sxs-lookup"><span data-stu-id="e318c-276">Before components that consume the updated method.</span></span> |
| [<span data-ttu-id="e318c-277">Redirection HTTPs</span><span class="sxs-lookup"><span data-stu-id="e318c-277">HTTPS Redirection</span></span>](xref:security/enforcing-ssl#require-https) | <span data-ttu-id="e318c-278">Redirige toutes les requêtes HTTP vers HTTPS.</span><span class="sxs-lookup"><span data-stu-id="e318c-278">Redirect all HTTP requests to HTTPS.</span></span> | <span data-ttu-id="e318c-279">Avant les composants qui consomment l’URL.</span><span class="sxs-lookup"><span data-stu-id="e318c-279">Before components that consume the URL.</span></span> |
| [<span data-ttu-id="e318c-280">HSTS (HTTP Strict Transport Security)</span><span class="sxs-lookup"><span data-stu-id="e318c-280">HTTP Strict Transport Security (HSTS)</span></span>](xref:security/enforcing-ssl#http-strict-transport-security-protocol-hsts) | <span data-ttu-id="e318c-281">Middleware d’amélioration de la sécurité qui ajoute un en-tête de réponse spécial.</span><span class="sxs-lookup"><span data-stu-id="e318c-281">Security enhancement middleware that adds a special response header.</span></span> | <span data-ttu-id="e318c-282">Avant l’envoi des réponses et après les composants qui modifient les requêtes.</span><span class="sxs-lookup"><span data-stu-id="e318c-282">Before responses are sent and after components that modify requests.</span></span> <span data-ttu-id="e318c-283">Exemples : en-têtes transférés, réécriture d’URL.</span><span class="sxs-lookup"><span data-stu-id="e318c-283">Examples: Forwarded Headers, URL Rewriting.</span></span> |
| [<span data-ttu-id="e318c-284">MVC</span><span class="sxs-lookup"><span data-stu-id="e318c-284">MVC</span></span>](xref:mvc/overview) | <span data-ttu-id="e318c-285">Traite les demandes avec MVC/ Razor pages.</span><span class="sxs-lookup"><span data-stu-id="e318c-285">Processes requests with MVC/Razor Pages.</span></span> | <span data-ttu-id="e318c-286">Terminal si une requête correspond à un itinéraire.</span><span class="sxs-lookup"><span data-stu-id="e318c-286">Terminal if a request matches a route.</span></span> |
| [<span data-ttu-id="e318c-287">OWIN</span><span class="sxs-lookup"><span data-stu-id="e318c-287">OWIN</span></span>](xref:fundamentals/owin) | <span data-ttu-id="e318c-288">Interopérabilité avec le middleware, les serveurs et les applications OWIN.</span><span class="sxs-lookup"><span data-stu-id="e318c-288">Interop with OWIN-based apps, servers, and middleware.</span></span> | <span data-ttu-id="e318c-289">Terminal si le middleware OWIN traite entièrement la requête.</span><span class="sxs-lookup"><span data-stu-id="e318c-289">Terminal if the OWIN Middleware fully processes the request.</span></span> |
| [<span data-ttu-id="e318c-290">Mise en cache des réponses</span><span class="sxs-lookup"><span data-stu-id="e318c-290">Response Caching</span></span>](xref:performance/caching/middleware) | <span data-ttu-id="e318c-291">Prend en charge la mise en cache des réponses.</span><span class="sxs-lookup"><span data-stu-id="e318c-291">Provides support for caching responses.</span></span> | <span data-ttu-id="e318c-292">Avant les composants qui nécessitent la mise en cache.</span><span class="sxs-lookup"><span data-stu-id="e318c-292">Before components that require caching.</span></span> <span data-ttu-id="e318c-293">`UseCORS` doit être antérieur `UseResponseCaching` .</span><span class="sxs-lookup"><span data-stu-id="e318c-293">`UseCORS` must come before `UseResponseCaching`.</span></span>|
| [<span data-ttu-id="e318c-294">Compression de la réponse</span><span class="sxs-lookup"><span data-stu-id="e318c-294">Response Compression</span></span>](xref:performance/response-compression) | <span data-ttu-id="e318c-295">Prend en charge la compression des réponses.</span><span class="sxs-lookup"><span data-stu-id="e318c-295">Provides support for compressing responses.</span></span> | <span data-ttu-id="e318c-296">Avant les composants qui nécessitent la compression.</span><span class="sxs-lookup"><span data-stu-id="e318c-296">Before components that require compression.</span></span> |
| [<span data-ttu-id="e318c-297">Localisation des requêtes</span><span class="sxs-lookup"><span data-stu-id="e318c-297">Request Localization</span></span>](xref:fundamentals/localization) | <span data-ttu-id="e318c-298">Prend en charge la localisation.</span><span class="sxs-lookup"><span data-stu-id="e318c-298">Provides localization support.</span></span> | <span data-ttu-id="e318c-299">Avant la localisation des composants sensibles.</span><span class="sxs-lookup"><span data-stu-id="e318c-299">Before localization sensitive components.</span></span> |
| [<span data-ttu-id="e318c-300">Routage de point de terminaison</span><span class="sxs-lookup"><span data-stu-id="e318c-300">Endpoint Routing</span></span>](xref:fundamentals/routing) | <span data-ttu-id="e318c-301">Définit et contraint des routes de requête.</span><span class="sxs-lookup"><span data-stu-id="e318c-301">Defines and constrains request routes.</span></span> | <span data-ttu-id="e318c-302">Terminal pour les routes correspondantes.</span><span class="sxs-lookup"><span data-stu-id="e318c-302">Terminal for matching routes.</span></span> |
| [<span data-ttu-id="e318c-303">SPA</span><span class="sxs-lookup"><span data-stu-id="e318c-303">SPA</span></span>](xref:Microsoft.AspNetCore.Builder.SpaApplicationBuilderExtensions.UseSpa%2A) | <span data-ttu-id="e318c-304">Gère toutes les demandes à partir de ce point dans la chaîne de l’intergiciel (middleware) en retournant la page par défaut pour l’application à page unique (SPA)</span><span class="sxs-lookup"><span data-stu-id="e318c-304">Handles all requests from this point in the middleware chain by returning the default page for the Single Page Application (SPA)</span></span> | <span data-ttu-id="e318c-305">À la fin de la chaîne, les autres middlewares pour traiter les fichiers statiques, les actions MVC, etc., sont prioritaires.</span><span class="sxs-lookup"><span data-stu-id="e318c-305">Late in the chain, so that other middleware for serving static files, MVC actions, etc., takes precedence.</span></span>|
| [<span data-ttu-id="e318c-306">Session</span><span class="sxs-lookup"><span data-stu-id="e318c-306">Session</span></span>](xref:fundamentals/app-state) | <span data-ttu-id="e318c-307">Prend en charge la gestion des sessions utilisateur.</span><span class="sxs-lookup"><span data-stu-id="e318c-307">Provides support for managing user sessions.</span></span> | <span data-ttu-id="e318c-308">Avant les composants qui nécessitent la session.</span><span class="sxs-lookup"><span data-stu-id="e318c-308">Before components that require Session.</span></span> | 
| [<span data-ttu-id="e318c-309">Fichiers statiques</span><span class="sxs-lookup"><span data-stu-id="e318c-309">Static Files</span></span>](xref:fundamentals/static-files) | <span data-ttu-id="e318c-310">Prend en charge le traitement des fichiers statiques et l’exploration des répertoires.</span><span class="sxs-lookup"><span data-stu-id="e318c-310">Provides support for serving static files and directory browsing.</span></span> | <span data-ttu-id="e318c-311">Terminal si une requête correspond à un fichier.</span><span class="sxs-lookup"><span data-stu-id="e318c-311">Terminal if a request matches a file.</span></span> |
| [<span data-ttu-id="e318c-312">URL Rewrite</span><span class="sxs-lookup"><span data-stu-id="e318c-312">URL Rewrite</span></span>](xref:fundamentals/url-rewriting) | <span data-ttu-id="e318c-313">Prend en charge la réécriture d’URL et la redirection des requêtes.</span><span class="sxs-lookup"><span data-stu-id="e318c-313">Provides support for rewriting URLs and redirecting requests.</span></span> | <span data-ttu-id="e318c-314">Avant les composants qui consomment l’URL.</span><span class="sxs-lookup"><span data-stu-id="e318c-314">Before components that consume the URL.</span></span> |
| [<span data-ttu-id="e318c-315">WebSockets</span><span class="sxs-lookup"><span data-stu-id="e318c-315">WebSockets</span></span>](xref:fundamentals/websockets) | <span data-ttu-id="e318c-316">Autorise le protocole WebSockets.</span><span class="sxs-lookup"><span data-stu-id="e318c-316">Enables the WebSockets protocol.</span></span> | <span data-ttu-id="e318c-317">Avant les composants qui sont nécessaires pour accepter les requêtes WebSocket.</span><span class="sxs-lookup"><span data-stu-id="e318c-317">Before components that are required to accept WebSocket requests.</span></span> |

## <a name="additional-resources"></a><span data-ttu-id="e318c-318">Ressources supplémentaires</span><span class="sxs-lookup"><span data-stu-id="e318c-318">Additional resources</span></span>

* <span data-ttu-id="e318c-319">Les [options de durée de vie et d’inscription](xref:fundamentals/dependency-injection#lifetime-and-registration-options) contiennent un exemple complet d’intergiciel (middleware) avec des services de durée de vie *délimités* , *transitoires* et *singletons* .</span><span class="sxs-lookup"><span data-stu-id="e318c-319">[Lifetime and registration options](xref:fundamentals/dependency-injection#lifetime-and-registration-options) contains a complete sample of middleware with *scoped* , *transient* , and *singleton* lifetime services.</span></span>
* <xref:fundamentals/middleware/write>
* <xref:test/middleware>
* <xref:migration/http-modules>
* <xref:fundamentals/startup>
* <xref:fundamentals/request-features>
* <xref:fundamentals/middleware/extensibility>
* <xref:fundamentals/middleware/extensibility-third-party-container>

::: moniker-end

::: moniker range="< aspnetcore-3.0"

<span data-ttu-id="e318c-320">De [Rick Anderson](https://twitter.com/RickAndMSFT) et [Steve Smith](https://ardalis.com/)</span><span class="sxs-lookup"><span data-stu-id="e318c-320">By [Rick Anderson](https://twitter.com/RickAndMSFT) and [Steve Smith](https://ardalis.com/)</span></span>

<span data-ttu-id="e318c-321">Un middleware est un logiciel qui est assemblé dans un pipeline d’application pour gérer les requêtes et les réponses.</span><span class="sxs-lookup"><span data-stu-id="e318c-321">Middleware is software that's assembled into an app pipeline to handle requests and responses.</span></span> <span data-ttu-id="e318c-322">Chaque composant :</span><span class="sxs-lookup"><span data-stu-id="e318c-322">Each component:</span></span>

* <span data-ttu-id="e318c-323">Choisit de passer la requête au composant suivant dans le pipeline.</span><span class="sxs-lookup"><span data-stu-id="e318c-323">Chooses whether to pass the request to the next component in the pipeline.</span></span>
* <span data-ttu-id="e318c-324">Peut travailler avant et après le composant suivant dans le pipeline.</span><span class="sxs-lookup"><span data-stu-id="e318c-324">Can perform work before and after the next component in the pipeline.</span></span>

<span data-ttu-id="e318c-325">Les délégués de requête sont utilisés pour créer le pipeline de requête.</span><span class="sxs-lookup"><span data-stu-id="e318c-325">Request delegates are used to build the request pipeline.</span></span> <span data-ttu-id="e318c-326">Les délégués de requête gèrent chaque requête HTTP.</span><span class="sxs-lookup"><span data-stu-id="e318c-326">The request delegates handle each HTTP request.</span></span>

<span data-ttu-id="e318c-327">Les délégués de requête sont configurés à l’aide des méthodes d’extension <xref:Microsoft.AspNetCore.Builder.RunExtensions.Run%2A>, <xref:Microsoft.AspNetCore.Builder.MapExtensions.Map%2A> et <xref:Microsoft.AspNetCore.Builder.UseExtensions.Use%2A>.</span><span class="sxs-lookup"><span data-stu-id="e318c-327">Request delegates are configured using <xref:Microsoft.AspNetCore.Builder.RunExtensions.Run%2A>, <xref:Microsoft.AspNetCore.Builder.MapExtensions.Map%2A>, and <xref:Microsoft.AspNetCore.Builder.UseExtensions.Use%2A> extension methods.</span></span> <span data-ttu-id="e318c-328">Chaque délégué de requête peut être spécifié inline comme méthode anonyme (appelée intergiciel inline) ou peut être défini dans une classe réutilisable.</span><span class="sxs-lookup"><span data-stu-id="e318c-328">An individual request delegate can be specified in-line as an anonymous method (called in-line middleware), or it can be defined in a reusable class.</span></span> <span data-ttu-id="e318c-329">Ces classes réutilisables et les méthodes anonymes inline sont des *middlewares* , également appelés *composants de middleware* .</span><span class="sxs-lookup"><span data-stu-id="e318c-329">These reusable classes and in-line anonymous methods are *middleware* , also called *middleware components* .</span></span> <span data-ttu-id="e318c-330">Chaque composant de middleware du pipeline de requête est chargé d’appeler le composant suivant du pipeline ou de court-circuiter le pipeline.</span><span class="sxs-lookup"><span data-stu-id="e318c-330">Each middleware component in the request pipeline is responsible for invoking the next component in the pipeline or short-circuiting the pipeline.</span></span> <span data-ttu-id="e318c-331">Lorsqu’un middleware effectue un court-circuit, on parle de *middleware terminal* , car il empêche tout autre middleware de traiter la requête.</span><span class="sxs-lookup"><span data-stu-id="e318c-331">When a middleware short-circuits, it's called a *terminal middleware* because it prevents further middleware from processing the request.</span></span>

<span data-ttu-id="e318c-332"><xref:migration/http-modules> explique la différence entre les pipelines de requêtes dans ASP.NET Core et ASP.NET 4.x, puis fournit d’autres exemples de middlewares.</span><span class="sxs-lookup"><span data-stu-id="e318c-332"><xref:migration/http-modules> explains the difference between request pipelines in ASP.NET Core and ASP.NET 4.x and provides additional middleware samples.</span></span>

## <a name="create-a-middleware-pipeline-with-iapplicationbuilder"></a><span data-ttu-id="e318c-333">Créer un pipeline de middleware avec IApplicationBuilder</span><span class="sxs-lookup"><span data-stu-id="e318c-333">Create a middleware pipeline with IApplicationBuilder</span></span>

<span data-ttu-id="e318c-334">Le pipeline de requête ASP.NET Core est composé d’une séquence de délégués de requête, appelés l’un après l’autre.</span><span class="sxs-lookup"><span data-stu-id="e318c-334">The ASP.NET Core request pipeline consists of a sequence of request delegates, called one after the other.</span></span> <span data-ttu-id="e318c-335">Le diagramme suivant illustre le concept.</span><span class="sxs-lookup"><span data-stu-id="e318c-335">The following diagram demonstrates the concept.</span></span> <span data-ttu-id="e318c-336">Le thread d’exécution suit les flèches noires.</span><span class="sxs-lookup"><span data-stu-id="e318c-336">The thread of execution follows the black arrows.</span></span>

![Modèle de traitement des requêtes montrant une requête qui arrive et qui est traitée par trois middlewares, puis la réponse qui quitte l’application.](index/_static/request-delegate-pipeline.png)

<span data-ttu-id="e318c-340">Chaque délégué peut effectuer des opérations avant et après le délégué suivant.</span><span class="sxs-lookup"><span data-stu-id="e318c-340">Each delegate can perform operations before and after the next delegate.</span></span> <span data-ttu-id="e318c-341">Les délégués de gestion des exceptions doivent être appelés tôt dans le pipeline pour qu’ils puissent intercepter les exceptions qui se produisent dans les phases ultérieures du pipeline.</span><span class="sxs-lookup"><span data-stu-id="e318c-341">Exception-handling delegates should be called early in the pipeline, so they can catch exceptions that occur in later stages of the pipeline.</span></span>

<span data-ttu-id="e318c-342">L’application ASP.NET Core la plus simple possible définit un seul délégué de requête qui gère toutes les requêtes.</span><span class="sxs-lookup"><span data-stu-id="e318c-342">The simplest possible ASP.NET Core app sets up a single request delegate that handles all requests.</span></span> <span data-ttu-id="e318c-343">Ce cas ne fait pas appel à un pipeline de requête réel.</span><span class="sxs-lookup"><span data-stu-id="e318c-343">This case doesn't include an actual request pipeline.</span></span> <span data-ttu-id="e318c-344">À la place, une seule fonction anonyme est appelée en réponse à chaque requête HTTP.</span><span class="sxs-lookup"><span data-stu-id="e318c-344">Instead, a single anonymous function is called in response to every HTTP request.</span></span>

[!code-csharp[](index/snapshot/Middleware/Startup.cs)]

<span data-ttu-id="e318c-345">Le premier délégué <xref:Microsoft.AspNetCore.Builder.RunExtensions.Run%2A> termine le pipeline.</span><span class="sxs-lookup"><span data-stu-id="e318c-345">The first <xref:Microsoft.AspNetCore.Builder.RunExtensions.Run%2A> delegate terminates the pipeline.</span></span>

<span data-ttu-id="e318c-346">Chaînez plusieurs délégués de requête avec <xref:Microsoft.AspNetCore.Builder.UseExtensions.Use%2A>.</span><span class="sxs-lookup"><span data-stu-id="e318c-346">Chain multiple request delegates together with <xref:Microsoft.AspNetCore.Builder.UseExtensions.Use%2A>.</span></span> <span data-ttu-id="e318c-347">Le paramètre `next` représente le délégué suivant dans le pipeline.</span><span class="sxs-lookup"><span data-stu-id="e318c-347">The `next` parameter represents the next delegate in the pipeline.</span></span> <span data-ttu-id="e318c-348">Vous pouvez court-circuiter le pipeline en n’appelant *pas* le paramètre *next* .</span><span class="sxs-lookup"><span data-stu-id="e318c-348">You can short-circuit the pipeline by *not* calling the *next* parameter.</span></span> <span data-ttu-id="e318c-349">Vous pouvez généralement effectuer des actions à la fois avant et après le délégué suivant, comme illustré dans cet exemple :</span><span class="sxs-lookup"><span data-stu-id="e318c-349">You can typically perform actions both before and after the next delegate, as the following example demonstrates:</span></span>

[!code-csharp[](index/snapshot/Chain/Startup.cs)]

<span data-ttu-id="e318c-350">Quand un délégué ne passe pas une requête au délégué suivant, on parle alors de *court-circuit du pipeline de requête* .</span><span class="sxs-lookup"><span data-stu-id="e318c-350">When a delegate doesn't pass a request to the next delegate, it's called *short-circuiting the request pipeline* .</span></span> <span data-ttu-id="e318c-351">Un court-circuit est souvent souhaitable car il évite le travail inutile.</span><span class="sxs-lookup"><span data-stu-id="e318c-351">Short-circuiting is often desirable because it avoids unnecessary work.</span></span> <span data-ttu-id="e318c-352">Par exemple, le [middleware Fichier statique](xref:fundamentals/static-files) peut agir en tant que *middleware terminal* en traitant une requête pour un fichier statique et en court-circuitant le reste du pipeline.</span><span class="sxs-lookup"><span data-stu-id="e318c-352">For example, [Static File Middleware](xref:fundamentals/static-files) can act as a *terminal middleware* by processing a request for a static file and short-circuiting the rest of the pipeline.</span></span> <span data-ttu-id="e318c-353">Le middleware ajouté au pipeline avant de le middleware qui met fin à la poursuite du traitement traite tout de même le code après les instructions `next.Invoke`.</span><span class="sxs-lookup"><span data-stu-id="e318c-353">Middleware added to the pipeline before the middleware that terminates further processing still processes code after their `next.Invoke` statements.</span></span> <span data-ttu-id="e318c-354">Toutefois, consultez l’avertissement suivant à propos de la tentative d’écriture sur une réponse qui a déjà été envoyée.</span><span class="sxs-lookup"><span data-stu-id="e318c-354">However, see the following warning about attempting to write to a response that has already been sent.</span></span>

> [!WARNING]
> <span data-ttu-id="e318c-355">N’appelez pas `next.Invoke` une fois que la réponse a été envoyée au client.</span><span class="sxs-lookup"><span data-stu-id="e318c-355">Don't call `next.Invoke` after the response has been sent to the client.</span></span> <span data-ttu-id="e318c-356">Les changements apportés à <xref:Microsoft.AspNetCore.Http.HttpResponse> après le démarrage de la réponse lèvent une exception.</span><span class="sxs-lookup"><span data-stu-id="e318c-356">Changes to <xref:Microsoft.AspNetCore.Http.HttpResponse> after the response has started throw an exception.</span></span> <span data-ttu-id="e318c-357">Par exemple, les changements comme la définition des en-têtes et du code d’état lèvent une exception.</span><span class="sxs-lookup"><span data-stu-id="e318c-357">For example, changes such as setting headers and a status code throw an exception.</span></span> <span data-ttu-id="e318c-358">Écrire dans le corps de la réponse après avoir appelé `next` :</span><span class="sxs-lookup"><span data-stu-id="e318c-358">Writing to the response body after calling `next`:</span></span>
>
> * <span data-ttu-id="e318c-359">Peut entraîner une violation de protocole.</span><span class="sxs-lookup"><span data-stu-id="e318c-359">May cause a protocol violation.</span></span> <span data-ttu-id="e318c-360">Par exemple, écrire plus que le `Content-Length` indiqué.</span><span class="sxs-lookup"><span data-stu-id="e318c-360">For example, writing more than the stated `Content-Length`.</span></span>
> * <span data-ttu-id="e318c-361">Peut altérer le format du corps.</span><span class="sxs-lookup"><span data-stu-id="e318c-361">May corrupt the body format.</span></span> <span data-ttu-id="e318c-362">Par exemple, l’écriture d’un pied de page HTML dans un fichier CSS.</span><span class="sxs-lookup"><span data-stu-id="e318c-362">For example, writing an HTML footer to a CSS file.</span></span>
>
> <span data-ttu-id="e318c-363"><xref:Microsoft.AspNetCore.Http.HttpResponse.HasStarted%2A> est un indice utile pour indiquer si les en-têtes ont été envoyés ou si le corps a fait l’objet d’écritures.</span><span class="sxs-lookup"><span data-stu-id="e318c-363"><xref:Microsoft.AspNetCore.Http.HttpResponse.HasStarted%2A> is a useful hint to indicate if headers have been sent or the body has been written to.</span></span>

<a name="order"></a>

## <a name="middleware-order"></a><span data-ttu-id="e318c-364">Ordre des intergiciels (middleware)</span><span class="sxs-lookup"><span data-stu-id="e318c-364">Middleware order</span></span>

<span data-ttu-id="e318c-365">L’ordre dans lequel les composants de middleware sont ajoutés dans la méthode `Startup.Configure` définit l’ordre dans lequel ils sont appelés sur les requêtes et l’ordre inverse pour la réponse.</span><span class="sxs-lookup"><span data-stu-id="e318c-365">The order that middleware components are added in the `Startup.Configure` method defines the order in which the middleware components are invoked on requests and the reverse order for the response.</span></span> <span data-ttu-id="e318c-366">L’ordre est **essentiel** pour la sécurité, les performances et les fonctionnalités.</span><span class="sxs-lookup"><span data-stu-id="e318c-366">The order is **critical** for security, performance, and functionality.</span></span>

<span data-ttu-id="e318c-367">La `Startup.Configure` méthode suivante ajoute les composants de l’intergiciel (middleware) associés à la sécurité dans l’ordre recommandé :</span><span class="sxs-lookup"><span data-stu-id="e318c-367">The following `Startup.Configure` method adds security related middleware components in the recommended order:</span></span>

[!code-csharp[](index/snapshot/Startup22.cs?name=snippet)]

<span data-ttu-id="e318c-368">Dans le code précédent :</span><span class="sxs-lookup"><span data-stu-id="e318c-368">In the preceding code:</span></span>

* <span data-ttu-id="e318c-369">Les intergiciels (middleware) qui ne sont pas ajoutés lors de la création d’une nouvelle application Web avec des [comptes d’utilisateurs individuels](xref:security/authentication/identity) sont commentés.</span><span class="sxs-lookup"><span data-stu-id="e318c-369">Middleware that is not added when creating a new web app with [individual users accounts](xref:security/authentication/identity) is commented out.</span></span>
* <span data-ttu-id="e318c-370">Tous les intergiciels (middleware) ne doivent pas être placés dans cet ordre exact, mais beaucoup d’entre eux.</span><span class="sxs-lookup"><span data-stu-id="e318c-370">Not every middleware needs to go in this exact order, but many do.</span></span> <span data-ttu-id="e318c-371">Par exemple, `UseCors` et `UseAuthentication` doivent être placés dans l’ordre indiqué.</span><span class="sxs-lookup"><span data-stu-id="e318c-371">For example, `UseCors` and `UseAuthentication` must go in the order shown.</span></span>

<span data-ttu-id="e318c-372">La méthode `Startup.Configure` suivante ajoute des composants middleware utiles pour les scénarios d’application courants :</span><span class="sxs-lookup"><span data-stu-id="e318c-372">The following `Startup.Configure` method adds middleware components for common app scenarios:</span></span>

1. <span data-ttu-id="e318c-373">Gestion des erreurs/exceptions</span><span class="sxs-lookup"><span data-stu-id="e318c-373">Exception/error handling</span></span>
   * <span data-ttu-id="e318c-374">Quand l’application s’exécute dans l’environnement de développement :</span><span class="sxs-lookup"><span data-stu-id="e318c-374">When the app runs in the Development environment:</span></span>
     * <span data-ttu-id="e318c-375">Le middleware Page d’exceptions du développeur (<xref:Microsoft.AspNetCore.Builder.DeveloperExceptionPageExtensions.UseDeveloperExceptionPage%2A>) signale des erreurs de runtime de l’application.</span><span class="sxs-lookup"><span data-stu-id="e318c-375">Developer Exception Page Middleware (<xref:Microsoft.AspNetCore.Builder.DeveloperExceptionPageExtensions.UseDeveloperExceptionPage%2A>) reports app runtime errors.</span></span>
     * <span data-ttu-id="e318c-376">Le middleware Page d’erreur de base de données (`Microsoft.AspNetCore.Builder.DatabaseErrorPageExtensions.UseDatabaseErrorPage`) signale des erreurs de runtime de la base de données.</span><span class="sxs-lookup"><span data-stu-id="e318c-376">Database Error Page Middleware (`Microsoft.AspNetCore.Builder.DatabaseErrorPageExtensions.UseDatabaseErrorPage`) reports database runtime errors.</span></span>
   * <span data-ttu-id="e318c-377">Quand l’application s’exécute dans l’environnement de production :</span><span class="sxs-lookup"><span data-stu-id="e318c-377">When the app runs in the Production environment:</span></span>
     * <span data-ttu-id="e318c-378">Le middleware Gestionnaire d'exceptions (<xref:Microsoft.AspNetCore.Builder.ExceptionHandlerExtensions.UseExceptionHandler%2A>) intercepte des exceptions levées dans les middlewares suivants.</span><span class="sxs-lookup"><span data-stu-id="e318c-378">Exception Handler Middleware (<xref:Microsoft.AspNetCore.Builder.ExceptionHandlerExtensions.UseExceptionHandler%2A>) catches exceptions thrown in the following middlewares.</span></span>
     * <span data-ttu-id="e318c-379">Le middleware Protocole HSTS (HTTP Strict Transport Security) (<xref:Microsoft.AspNetCore.Builder.HstsBuilderExtensions.UseHsts%2A>) ajoute l’en-tête `Strict-Transport-Security`.</span><span class="sxs-lookup"><span data-stu-id="e318c-379">HTTP Strict Transport Security Protocol (HSTS) Middleware (<xref:Microsoft.AspNetCore.Builder.HstsBuilderExtensions.UseHsts%2A>) adds the `Strict-Transport-Security` header.</span></span>
1. <span data-ttu-id="e318c-380">Le middleware Redirection HTTPS (<xref:Microsoft.AspNetCore.Builder.HttpsPolicyBuilderExtensions.UseHttpsRedirection%2A>) redirige les requêtes HTTP vers HTTPS.</span><span class="sxs-lookup"><span data-stu-id="e318c-380">HTTPS Redirection Middleware (<xref:Microsoft.AspNetCore.Builder.HttpsPolicyBuilderExtensions.UseHttpsRedirection%2A>) redirects HTTP requests to HTTPS.</span></span>
1. <span data-ttu-id="e318c-381">Le middleware Fichier statique (<xref:Microsoft.AspNetCore.Builder.StaticFileExtensions.UseStaticFiles%2A>) retourne des fichiers statiques et court-circuite tout traitement supplémentaire de la requête.</span><span class="sxs-lookup"><span data-stu-id="e318c-381">Static File Middleware (<xref:Microsoft.AspNetCore.Builder.StaticFileExtensions.UseStaticFiles%2A>) returns static files and short-circuits further request processing.</span></span>
1. <span data-ttu-id="e318c-382">Cookie L’intergiciel ( <xref:Microsoft.AspNetCore.Builder.CookiePolicyAppBuilderExtensions.UseCookiePolicy%2A> ) de stratégie convertit l’application en RGPD (union Règlement général sur la protection des données européenne).</span><span class="sxs-lookup"><span data-stu-id="e318c-382">Cookie Policy Middleware (<xref:Microsoft.AspNetCore.Builder.CookiePolicyAppBuilderExtensions.UseCookiePolicy%2A>) conforms the app to the EU General Data Protection Regulation (GDPR) regulations.</span></span>
1. <span data-ttu-id="e318c-383">Le middleware Authentification (<xref:Microsoft.AspNetCore.Builder.AuthAppBuilderExtensions.UseAuthentication%2A>) tente d’authentifier l’utilisateur avant qu’il ne soit autorisé à accéder aux ressources sécurisées.</span><span class="sxs-lookup"><span data-stu-id="e318c-383">Authentication Middleware (<xref:Microsoft.AspNetCore.Builder.AuthAppBuilderExtensions.UseAuthentication%2A>) attempts to authenticate the user before they're allowed access to secure resources.</span></span>
1. <span data-ttu-id="e318c-384">Le middleware Session (<xref:Microsoft.AspNetCore.Builder.SessionMiddlewareExtensions.UseSession%2A>) établit et maintient l’état de la session.</span><span class="sxs-lookup"><span data-stu-id="e318c-384">Session Middleware (<xref:Microsoft.AspNetCore.Builder.SessionMiddlewareExtensions.UseSession%2A>) establishes and maintains session state.</span></span> <span data-ttu-id="e318c-385">Si l’application utilise l’état de session, appelez l’intergiciel (middleware) de session après l’intergiciel (middleware) Cookie de stratégie et avant l’intergiciel (middleware) Mvc.</span><span class="sxs-lookup"><span data-stu-id="e318c-385">If the app uses session state, call Session Middleware after Cookie Policy Middleware and before MVC Middleware.</span></span>
1. <span data-ttu-id="e318c-386">MVC (<xref:Microsoft.AspNetCore.Builder.MvcApplicationBuilderExtensions.UseMvc%2A>) pour ajouter MVC au pipeline de requête.</span><span class="sxs-lookup"><span data-stu-id="e318c-386">MVC (<xref:Microsoft.AspNetCore.Builder.MvcApplicationBuilderExtensions.UseMvc%2A>) to add MVC to the request pipeline.</span></span>

```csharp
public void Configure(IApplicationBuilder app, IHostingEnvironment env)
{
    if (env.IsDevelopment())
    {
        app.UseDeveloperExceptionPage();
        app.UseDatabaseErrorPage();
    }
    else
    {
        app.UseExceptionHandler("/Error");
        app.UseHsts();
    }

    app.UseHttpsRedirection();
    app.UseStaticFiles();
    app.UseCookiePolicy();
    app.UseAuthentication();
    app.UseSession();
    app.UseMvc();
}
```

<span data-ttu-id="e318c-387">Dans l’exemple de code précédent, chaque méthode d’extension d’intergiciel (middleware) est exposée sur <xref:Microsoft.AspNetCore.Builder.IApplicationBuilder> à travers l’espace de noms <xref:Microsoft.AspNetCore.Builder?displayProperty=fullName>.</span><span class="sxs-lookup"><span data-stu-id="e318c-387">In the preceding example code, each middleware extension method is exposed on <xref:Microsoft.AspNetCore.Builder.IApplicationBuilder> through the <xref:Microsoft.AspNetCore.Builder?displayProperty=fullName> namespace.</span></span>

<span data-ttu-id="e318c-388"><xref:Microsoft.AspNetCore.Builder.ExceptionHandlerExtensions.UseExceptionHandler%2A> est le premier composant d’intergiciel ajouté au pipeline.</span><span class="sxs-lookup"><span data-stu-id="e318c-388"><xref:Microsoft.AspNetCore.Builder.ExceptionHandlerExtensions.UseExceptionHandler%2A> is the first middleware component added to the pipeline.</span></span> <span data-ttu-id="e318c-389">Par conséquent, le middleware Gestion des exceptions intercepte toutes les exceptions qui se produisent dans les appels ultérieurs.</span><span class="sxs-lookup"><span data-stu-id="e318c-389">Therefore, the Exception Handler Middleware catches any exceptions that occur in later calls.</span></span>

<span data-ttu-id="e318c-390">Le middleware Fichier statique est appelé tôt dans le pipeline pour qu’il puisse gérer les requêtes et procéder au court-circuit sans passer par les composants restants.</span><span class="sxs-lookup"><span data-stu-id="e318c-390">Static File Middleware is called early in the pipeline so that it can handle requests and short-circuit without going through the remaining components.</span></span> <span data-ttu-id="e318c-391">Le middleware de fichiers statiques **ne fournit aucune** vérification d’autorisation.</span><span class="sxs-lookup"><span data-stu-id="e318c-391">The Static File Middleware provides **no** authorization checks.</span></span> <span data-ttu-id="e318c-392">Tous les fichiers pris en charge par l’intergiciel (middleware) de fichiers statiques, y compris ceux qui se trouvent sous *wwwroot* , sont disponibles publiquement.</span><span class="sxs-lookup"><span data-stu-id="e318c-392">Any files served by Static File Middleware, including those under *wwwroot* , are publicly available.</span></span> <span data-ttu-id="e318c-393">Pour obtenir une approche permettant de sécuriser les fichiers statiques, consultez <xref:fundamentals/static-files>.</span><span class="sxs-lookup"><span data-stu-id="e318c-393">For an approach to secure static files, see <xref:fundamentals/static-files>.</span></span>

<span data-ttu-id="e318c-394">Si la requête n’est pas gérée par le middleware Fichier statique, elle est transmise au middleware Authentification (<xref:Microsoft.AspNetCore.Builder.AuthAppBuilderExtensions.UseAuthentication%2A>), qui effectue l’authentification.</span><span class="sxs-lookup"><span data-stu-id="e318c-394">If the request isn't handled by the Static File Middleware, it's passed on to the Authentication Middleware (<xref:Microsoft.AspNetCore.Builder.AuthAppBuilderExtensions.UseAuthentication%2A>), which performs authentication.</span></span> <span data-ttu-id="e318c-395">Le middleware Authentification ne court-circuite pas les requêtes non authentifiées.</span><span class="sxs-lookup"><span data-stu-id="e318c-395">Authentication doesn't short-circuit unauthenticated requests.</span></span> <span data-ttu-id="e318c-396">Bien que l’intergiciel d’authentification authentifie les demandes, l’autorisation (et le rejet) se produit uniquement lorsque MVC sélectionne une Razor page ou un contrôleur MVC et une action spécifiques.</span><span class="sxs-lookup"><span data-stu-id="e318c-396">Although Authentication Middleware authenticates requests, authorization (and rejection) occurs only after MVC selects a specific Razor Page or MVC controller and action.</span></span>

<span data-ttu-id="e318c-397">L’exemple suivant montre un ordre de middlewares où les requêtes pour les fichiers statiques sont gérées par le middleware Fichier statique avant le middleware Compression de la réponse.</span><span class="sxs-lookup"><span data-stu-id="e318c-397">The following example demonstrates a middleware order where requests for static files are handled by Static File Middleware before Response Compression Middleware.</span></span> <span data-ttu-id="e318c-398">Les fichiers statiques ne sont pas compressés avec cet ordre de middlewares.</span><span class="sxs-lookup"><span data-stu-id="e318c-398">Static files aren't compressed with this middleware order.</span></span> <span data-ttu-id="e318c-399">Les réponses MVC de <xref:Microsoft.AspNetCore.Builder.MvcApplicationBuilderExtensions.UseMvcWithDefaultRoute%2A> peuvent être compressées.</span><span class="sxs-lookup"><span data-stu-id="e318c-399">The MVC responses from <xref:Microsoft.AspNetCore.Builder.MvcApplicationBuilderExtensions.UseMvcWithDefaultRoute%2A> can be compressed.</span></span>

```csharp
public void Configure(IApplicationBuilder app)
{
    // Static files aren't compressed by Static File Middleware.
    app.UseStaticFiles();

    app.UseResponseCompression();

    app.UseMvcWithDefaultRoute();
}
```

## <a name="use-run-and-map"></a><span data-ttu-id="e318c-400">Use, Run et Map</span><span class="sxs-lookup"><span data-stu-id="e318c-400">Use, Run, and Map</span></span>

<span data-ttu-id="e318c-401">Configurez le pipeline HTTP avec <xref:Microsoft.AspNetCore.Builder.UseExtensions.Use%2A>, <xref:Microsoft.AspNetCore.Builder.RunExtensions.Run%2A> et <xref:Microsoft.AspNetCore.Builder.MapExtensions.Map%2A>.</span><span class="sxs-lookup"><span data-stu-id="e318c-401">Configure the HTTP pipeline using <xref:Microsoft.AspNetCore.Builder.UseExtensions.Use%2A>, <xref:Microsoft.AspNetCore.Builder.RunExtensions.Run%2A>, and <xref:Microsoft.AspNetCore.Builder.MapExtensions.Map%2A>.</span></span> <span data-ttu-id="e318c-402">La méthode `Use` peut court-circuiter le pipeline (autrement dit, si elle n’appelle pas un délégué de requête `next`).</span><span class="sxs-lookup"><span data-stu-id="e318c-402">The `Use` method can short-circuit the pipeline (that is, if it doesn't call a `next` request delegate).</span></span> <span data-ttu-id="e318c-403">`Run` est une convention, et certains composants d’intergiciel peuvent exposer des méthodes `Run[Middleware]` qui s’exécutent à la fin du pipeline.</span><span class="sxs-lookup"><span data-stu-id="e318c-403">`Run` is a convention, and some middleware components may expose `Run[Middleware]` methods that run at the end of the pipeline.</span></span>

<span data-ttu-id="e318c-404">Les extensions <xref:Microsoft.AspNetCore.Builder.MapExtensions.Map%2A> sont utilisées comme convention pour créer une branche dans le pipeline.</span><span class="sxs-lookup"><span data-stu-id="e318c-404"><xref:Microsoft.AspNetCore.Builder.MapExtensions.Map%2A> extensions are used as a convention for branching the pipeline.</span></span> <span data-ttu-id="e318c-405">`Map` crée une branche dans le pipeline de requête en fonction des correspondances du chemin de requête donné.</span><span class="sxs-lookup"><span data-stu-id="e318c-405">`Map` branches the request pipeline based on matches of the given request path.</span></span> <span data-ttu-id="e318c-406">Si le chemin de requête commence par le chemin donné, la branche est exécutée.</span><span class="sxs-lookup"><span data-stu-id="e318c-406">If the request path starts with the given path, the branch is executed.</span></span>

[!code-csharp[](index/snapshot/Chain/StartupMap.cs)]

<span data-ttu-id="e318c-407">Le tableau suivant présente les requêtes et les réponses de `http://localhost:1234` avec le code précédent.</span><span class="sxs-lookup"><span data-stu-id="e318c-407">The following table shows the requests and responses from `http://localhost:1234` using the previous code.</span></span>

| <span data-ttu-id="e318c-408">Requête</span><span class="sxs-lookup"><span data-stu-id="e318c-408">Request</span></span>             | <span data-ttu-id="e318c-409">response</span><span class="sxs-lookup"><span data-stu-id="e318c-409">Response</span></span>                     |
| ------------------- | ---------------------------- |
| <span data-ttu-id="e318c-410">localhost:1234</span><span class="sxs-lookup"><span data-stu-id="e318c-410">localhost:1234</span></span>      | <span data-ttu-id="e318c-411">Hello from non-Map delegate.</span><span class="sxs-lookup"><span data-stu-id="e318c-411">Hello from non-Map delegate.</span></span> |
| <span data-ttu-id="e318c-412">localhost:1234/map1</span><span class="sxs-lookup"><span data-stu-id="e318c-412">localhost:1234/map1</span></span> | <span data-ttu-id="e318c-413">Map Test 1</span><span class="sxs-lookup"><span data-stu-id="e318c-413">Map Test 1</span></span>                   |
| <span data-ttu-id="e318c-414">localhost:1234/map2</span><span class="sxs-lookup"><span data-stu-id="e318c-414">localhost:1234/map2</span></span> | <span data-ttu-id="e318c-415">Map Test 2</span><span class="sxs-lookup"><span data-stu-id="e318c-415">Map Test 2</span></span>                   |
| <span data-ttu-id="e318c-416">localhost:1234/map3</span><span class="sxs-lookup"><span data-stu-id="e318c-416">localhost:1234/map3</span></span> | <span data-ttu-id="e318c-417">Hello from non-Map delegate.</span><span class="sxs-lookup"><span data-stu-id="e318c-417">Hello from non-Map delegate.</span></span> |

<span data-ttu-id="e318c-418">Quand `Map` est utilisé, les segments de chemin mis en correspondance sont supprimés de `HttpRequest.Path` et ajoutés à `HttpRequest.PathBase` pour chaque requête.</span><span class="sxs-lookup"><span data-stu-id="e318c-418">When `Map` is used, the matched path segments are removed from `HttpRequest.Path` and appended to `HttpRequest.PathBase` for each request.</span></span>

<span data-ttu-id="e318c-419"><xref:Microsoft.AspNetCore.Builder.MapWhenExtensions.MapWhen%2A> crée une branche dans le pipeline de requête en fonction du résultat du prédicat donné.</span><span class="sxs-lookup"><span data-stu-id="e318c-419"><xref:Microsoft.AspNetCore.Builder.MapWhenExtensions.MapWhen%2A> branches the request pipeline based on the result of the given predicate.</span></span> <span data-ttu-id="e318c-420">Un prédicat de type `Func<HttpContext, bool>` peut être utilisé pour mapper les requêtes à une nouvelle branche du pipeline.</span><span class="sxs-lookup"><span data-stu-id="e318c-420">Any predicate of type `Func<HttpContext, bool>` can be used to map requests to a new branch of the pipeline.</span></span> <span data-ttu-id="e318c-421">Dans l’exemple suivant, un prédicat est utilisé pour détecter la présence d’une variable de chaîne de requête `branch` :</span><span class="sxs-lookup"><span data-stu-id="e318c-421">In the following example, a predicate is used to detect the presence of a query string variable `branch`:</span></span>

[!code-csharp[](index/snapshot/Chain/StartupMapWhen.cs)]

<span data-ttu-id="e318c-422">Le tableau suivant présente les requêtes et les réponses de `http://localhost:1234` avec le code précédent.</span><span class="sxs-lookup"><span data-stu-id="e318c-422">The following table shows the requests and responses from `http://localhost:1234` using the previous code.</span></span>

| <span data-ttu-id="e318c-423">Requête</span><span class="sxs-lookup"><span data-stu-id="e318c-423">Request</span></span>                       | <span data-ttu-id="e318c-424">response</span><span class="sxs-lookup"><span data-stu-id="e318c-424">Response</span></span>                     |
| ----------------------------- | ---------------------------- |
| <span data-ttu-id="e318c-425">localhost:1234</span><span class="sxs-lookup"><span data-stu-id="e318c-425">localhost:1234</span></span>                | <span data-ttu-id="e318c-426">Hello from non-Map delegate.</span><span class="sxs-lookup"><span data-stu-id="e318c-426">Hello from non-Map delegate.</span></span> |
| <span data-ttu-id="e318c-427">localhost:1234/?branch=master</span><span class="sxs-lookup"><span data-stu-id="e318c-427">localhost:1234/?branch=master</span></span> | <span data-ttu-id="e318c-428">Branch used = master</span><span class="sxs-lookup"><span data-stu-id="e318c-428">Branch used = master</span></span>         |

<span data-ttu-id="e318c-429">`Map` prend en charge l’imbrication, par exemple :</span><span class="sxs-lookup"><span data-stu-id="e318c-429">`Map` supports nesting, for example:</span></span>

```csharp
app.Map("/level1", level1App => {
    level1App.Map("/level2a", level2AApp => {
        // "/level1/level2a" processing
    });
    level1App.Map("/level2b", level2BApp => {
        // "/level1/level2b" processing
    });
});
```

<span data-ttu-id="e318c-430">`Map` peut également faire correspondre plusieurs segments à la fois :</span><span class="sxs-lookup"><span data-stu-id="e318c-430">`Map` can also match multiple segments at once:</span></span>

[!code-csharp[](index/snapshot/Chain/StartupMultiSeg.cs?highlight=13)]

## <a name="built-in-middleware"></a><span data-ttu-id="e318c-431">Intergiciels (middleware) intégrés</span><span class="sxs-lookup"><span data-stu-id="e318c-431">Built-in middleware</span></span>

<span data-ttu-id="e318c-432">ASP.NET Core est fourni avec les composants de middleware suivant.</span><span class="sxs-lookup"><span data-stu-id="e318c-432">ASP.NET Core ships with the following middleware components.</span></span> <span data-ttu-id="e318c-433">La colonne *Ordre* fournit des notes sur l’emplacement du middleware dans le pipeline de traitement de la requête et sur les conditions dans lesquelles le middleware peut mettre fin au traitement de la requête.</span><span class="sxs-lookup"><span data-stu-id="e318c-433">The *Order* column provides notes on middleware placement in the request processing pipeline and under what conditions the middleware may terminate request processing.</span></span> <span data-ttu-id="e318c-434">Lorsqu’un middleware court-circuite le pipeline de traitement de la requête et empêche tout middleware en aval de traiter une requête, on parle de *middleware terminal* .</span><span class="sxs-lookup"><span data-stu-id="e318c-434">When a middleware short-circuits the request processing pipeline and prevents further downstream middleware from processing a request, it's called a *terminal middleware* .</span></span> <span data-ttu-id="e318c-435">Pour plus d’informations sur le court-circuit, consultez la section [Créer un pipeline de middlewares avec IApplicationBuilder](#create-a-middleware-pipeline-with-iapplicationbuilder).</span><span class="sxs-lookup"><span data-stu-id="e318c-435">For more information on short-circuiting, see the [Create a middleware pipeline with IApplicationBuilder](#create-a-middleware-pipeline-with-iapplicationbuilder) section.</span></span>

| <span data-ttu-id="e318c-436">Middleware</span><span class="sxs-lookup"><span data-stu-id="e318c-436">Middleware</span></span> | <span data-ttu-id="e318c-437">Description</span><span class="sxs-lookup"><span data-stu-id="e318c-437">Description</span></span> | <span data-ttu-id="e318c-438">JSON</span><span class="sxs-lookup"><span data-stu-id="e318c-438">Order</span></span> |
| ---------- | ----------- | ----- |
| [<span data-ttu-id="e318c-439">Authentification</span><span class="sxs-lookup"><span data-stu-id="e318c-439">Authentication</span></span>](xref:security/authentication/identity) | <span data-ttu-id="e318c-440">Prend en charge l’authentification.</span><span class="sxs-lookup"><span data-stu-id="e318c-440">Provides authentication support.</span></span> | <span data-ttu-id="e318c-441">Avant que `HttpContext.User` ne soit nécessaire.</span><span class="sxs-lookup"><span data-stu-id="e318c-441">Before `HttpContext.User` is needed.</span></span> <span data-ttu-id="e318c-442">Terminal pour les rappels OAuth.</span><span class="sxs-lookup"><span data-stu-id="e318c-442">Terminal for OAuth callbacks.</span></span> |
| [<span data-ttu-id="e318c-443">Cookie Renvoi</span><span class="sxs-lookup"><span data-stu-id="e318c-443">Cookie Policy</span></span>](xref:security/gdpr) | <span data-ttu-id="e318c-444">Effectue le suivi du consentement des utilisateurs pour le stockage des informations personnelles et applique les normes minimales pour les cookie champs, tels que `secure` et `SameSite` .</span><span class="sxs-lookup"><span data-stu-id="e318c-444">Tracks consent from users for storing personal information and enforces minimum standards for cookie fields, such as `secure` and `SameSite`.</span></span> | <span data-ttu-id="e318c-445">Avant l’intergiciel (middleware) qui émet cookie s.</span><span class="sxs-lookup"><span data-stu-id="e318c-445">Before middleware that issues cookies.</span></span> <span data-ttu-id="e318c-446">Exemples : authentification, session, MVC (TempData).</span><span class="sxs-lookup"><span data-stu-id="e318c-446">Examples: Authentication, Session, MVC (TempData).</span></span> |
| [<span data-ttu-id="e318c-447">CORS</span><span class="sxs-lookup"><span data-stu-id="e318c-447">CORS</span></span>](xref:security/cors) | <span data-ttu-id="e318c-448">Configure le partage des ressources cross-origin (CORS).</span><span class="sxs-lookup"><span data-stu-id="e318c-448">Configures Cross-Origin Resource Sharing.</span></span> | <span data-ttu-id="e318c-449">Avant les composants qui utilisent CORS.</span><span class="sxs-lookup"><span data-stu-id="e318c-449">Before components that use CORS.</span></span> |
| [<span data-ttu-id="e318c-450">Diagnostics</span><span class="sxs-lookup"><span data-stu-id="e318c-450">Diagnostics</span></span>](xref:fundamentals/error-handling) | <span data-ttu-id="e318c-451">Plusieurs intergiciels distincts qui fournissent une page d’exception de développeur, la gestion des exceptions, les pages de codes d’État et la page Web par défaut pour les nouvelles applications.</span><span class="sxs-lookup"><span data-stu-id="e318c-451">Several separate middlewares that provide a developer exception page, exception handling, status code pages, and the default web page for new apps.</span></span> | <span data-ttu-id="e318c-452">Avant les composants qui génèrent des erreurs.</span><span class="sxs-lookup"><span data-stu-id="e318c-452">Before components that generate errors.</span></span> <span data-ttu-id="e318c-453">Terminal pour les exceptions ou service de la page Web par défaut pour les nouvelles applications.</span><span class="sxs-lookup"><span data-stu-id="e318c-453">Terminal for exceptions or serving the default web page for new apps.</span></span> |
| [<span data-ttu-id="e318c-454">En-têtes transférés</span><span class="sxs-lookup"><span data-stu-id="e318c-454">Forwarded Headers</span></span>](xref:host-and-deploy/proxy-load-balancer) | <span data-ttu-id="e318c-455">Transfère les en-têtes en proxy vers la requête actuelle.</span><span class="sxs-lookup"><span data-stu-id="e318c-455">Forwards proxied headers onto the current request.</span></span> | <span data-ttu-id="e318c-456">Avant les composants qui consomment les champs mis à jour.</span><span class="sxs-lookup"><span data-stu-id="e318c-456">Before components that consume the updated fields.</span></span> <span data-ttu-id="e318c-457">Exemples : schéma, hôte, IP du client, méthode.</span><span class="sxs-lookup"><span data-stu-id="e318c-457">Examples: scheme, host, client IP, method.</span></span> |
| [<span data-ttu-id="e318c-458">Contrôle d’intégrité</span><span class="sxs-lookup"><span data-stu-id="e318c-458">Health Check</span></span>](xref:host-and-deploy/health-checks) | <span data-ttu-id="e318c-459">Contrôle l’intégrité d’une application ASP.NET Core et de ses dépendances, notamment la disponibilité de la base de données.</span><span class="sxs-lookup"><span data-stu-id="e318c-459">Checks the health of an ASP.NET Core app and its dependencies, such as checking database availability.</span></span> | <span data-ttu-id="e318c-460">Terminal si une requête correspond à un point de terminaison de contrôle d’intégrité.</span><span class="sxs-lookup"><span data-stu-id="e318c-460">Terminal if a request matches a health check endpoint.</span></span> |
| [<span data-ttu-id="e318c-461">Remplacement de la méthode HTTP</span><span class="sxs-lookup"><span data-stu-id="e318c-461">HTTP Method Override</span></span>](xref:Microsoft.AspNetCore.Builder.HttpMethodOverrideExtensions) | <span data-ttu-id="e318c-462">Autorise une requête POST entrante à remplacer la méthode.</span><span class="sxs-lookup"><span data-stu-id="e318c-462">Allows an incoming POST request to override the method.</span></span> | <span data-ttu-id="e318c-463">Avant les composants qui consomment la méthode mise à jour.</span><span class="sxs-lookup"><span data-stu-id="e318c-463">Before components that consume the updated method.</span></span> |
| [<span data-ttu-id="e318c-464">Redirection HTTPs</span><span class="sxs-lookup"><span data-stu-id="e318c-464">HTTPS Redirection</span></span>](xref:security/enforcing-ssl#require-https) | <span data-ttu-id="e318c-465">Redirige toutes les requêtes HTTP vers HTTPS.</span><span class="sxs-lookup"><span data-stu-id="e318c-465">Redirect all HTTP requests to HTTPS.</span></span> | <span data-ttu-id="e318c-466">Avant les composants qui consomment l’URL.</span><span class="sxs-lookup"><span data-stu-id="e318c-466">Before components that consume the URL.</span></span> |
| [<span data-ttu-id="e318c-467">HSTS (HTTP Strict Transport Security)</span><span class="sxs-lookup"><span data-stu-id="e318c-467">HTTP Strict Transport Security (HSTS)</span></span>](xref:security/enforcing-ssl#http-strict-transport-security-protocol-hsts) | <span data-ttu-id="e318c-468">Middleware d’amélioration de la sécurité qui ajoute un en-tête de réponse spécial.</span><span class="sxs-lookup"><span data-stu-id="e318c-468">Security enhancement middleware that adds a special response header.</span></span> | <span data-ttu-id="e318c-469">Avant l’envoi des réponses et après les composants qui modifient les requêtes.</span><span class="sxs-lookup"><span data-stu-id="e318c-469">Before responses are sent and after components that modify requests.</span></span> <span data-ttu-id="e318c-470">Exemples : en-têtes transférés, réécriture d’URL.</span><span class="sxs-lookup"><span data-stu-id="e318c-470">Examples: Forwarded Headers, URL Rewriting.</span></span> |
| [<span data-ttu-id="e318c-471">MVC</span><span class="sxs-lookup"><span data-stu-id="e318c-471">MVC</span></span>](xref:mvc/overview) | <span data-ttu-id="e318c-472">Traite les demandes avec MVC/ Razor pages.</span><span class="sxs-lookup"><span data-stu-id="e318c-472">Processes requests with MVC/Razor Pages.</span></span> | <span data-ttu-id="e318c-473">Terminal si une requête correspond à un itinéraire.</span><span class="sxs-lookup"><span data-stu-id="e318c-473">Terminal if a request matches a route.</span></span> |
| [<span data-ttu-id="e318c-474">OWIN</span><span class="sxs-lookup"><span data-stu-id="e318c-474">OWIN</span></span>](xref:fundamentals/owin) | <span data-ttu-id="e318c-475">Interopérabilité avec le middleware, les serveurs et les applications OWIN.</span><span class="sxs-lookup"><span data-stu-id="e318c-475">Interop with OWIN-based apps, servers, and middleware.</span></span> | <span data-ttu-id="e318c-476">Terminal si le middleware OWIN traite entièrement la requête.</span><span class="sxs-lookup"><span data-stu-id="e318c-476">Terminal if the OWIN Middleware fully processes the request.</span></span> |
| [<span data-ttu-id="e318c-477">Mise en cache des réponses</span><span class="sxs-lookup"><span data-stu-id="e318c-477">Response Caching</span></span>](xref:performance/caching/middleware) | <span data-ttu-id="e318c-478">Prend en charge la mise en cache des réponses.</span><span class="sxs-lookup"><span data-stu-id="e318c-478">Provides support for caching responses.</span></span> | <span data-ttu-id="e318c-479">Avant les composants qui nécessitent la mise en cache.</span><span class="sxs-lookup"><span data-stu-id="e318c-479">Before components that require caching.</span></span> |
| [<span data-ttu-id="e318c-480">Compression de la réponse</span><span class="sxs-lookup"><span data-stu-id="e318c-480">Response Compression</span></span>](xref:performance/response-compression) | <span data-ttu-id="e318c-481">Prend en charge la compression des réponses.</span><span class="sxs-lookup"><span data-stu-id="e318c-481">Provides support for compressing responses.</span></span> | <span data-ttu-id="e318c-482">Avant les composants qui nécessitent la compression.</span><span class="sxs-lookup"><span data-stu-id="e318c-482">Before components that require compression.</span></span> |
| [<span data-ttu-id="e318c-483">Localisation des requêtes</span><span class="sxs-lookup"><span data-stu-id="e318c-483">Request Localization</span></span>](xref:fundamentals/localization) | <span data-ttu-id="e318c-484">Prend en charge la localisation.</span><span class="sxs-lookup"><span data-stu-id="e318c-484">Provides localization support.</span></span> | <span data-ttu-id="e318c-485">Avant la localisation des composants sensibles.</span><span class="sxs-lookup"><span data-stu-id="e318c-485">Before localization sensitive components.</span></span> |
| [<span data-ttu-id="e318c-486">Routage de point de terminaison</span><span class="sxs-lookup"><span data-stu-id="e318c-486">Endpoint Routing</span></span>](xref:fundamentals/routing) | <span data-ttu-id="e318c-487">Définit et contraint des routes de requête.</span><span class="sxs-lookup"><span data-stu-id="e318c-487">Defines and constrains request routes.</span></span> | <span data-ttu-id="e318c-488">Terminal pour les routes correspondantes.</span><span class="sxs-lookup"><span data-stu-id="e318c-488">Terminal for matching routes.</span></span> |
| [<span data-ttu-id="e318c-489">Session</span><span class="sxs-lookup"><span data-stu-id="e318c-489">Session</span></span>](xref:fundamentals/app-state) | <span data-ttu-id="e318c-490">Prend en charge la gestion des sessions utilisateur.</span><span class="sxs-lookup"><span data-stu-id="e318c-490">Provides support for managing user sessions.</span></span> | <span data-ttu-id="e318c-491">Avant les composants qui nécessitent la session.</span><span class="sxs-lookup"><span data-stu-id="e318c-491">Before components that require Session.</span></span> |
| [<span data-ttu-id="e318c-492">Fichiers statiques</span><span class="sxs-lookup"><span data-stu-id="e318c-492">Static Files</span></span>](xref:fundamentals/static-files) | <span data-ttu-id="e318c-493">Prend en charge le traitement des fichiers statiques et l’exploration des répertoires.</span><span class="sxs-lookup"><span data-stu-id="e318c-493">Provides support for serving static files and directory browsing.</span></span> | <span data-ttu-id="e318c-494">Terminal si une requête correspond à un fichier.</span><span class="sxs-lookup"><span data-stu-id="e318c-494">Terminal if a request matches a file.</span></span> |
| [<span data-ttu-id="e318c-495">URL Rewrite</span><span class="sxs-lookup"><span data-stu-id="e318c-495">URL Rewrite</span></span>](xref:fundamentals/url-rewriting) | <span data-ttu-id="e318c-496">Prend en charge la réécriture d’URL et la redirection des requêtes.</span><span class="sxs-lookup"><span data-stu-id="e318c-496">Provides support for rewriting URLs and redirecting requests.</span></span> | <span data-ttu-id="e318c-497">Avant les composants qui consomment l’URL.</span><span class="sxs-lookup"><span data-stu-id="e318c-497">Before components that consume the URL.</span></span> |
| [<span data-ttu-id="e318c-498">WebSockets</span><span class="sxs-lookup"><span data-stu-id="e318c-498">WebSockets</span></span>](xref:fundamentals/websockets) | <span data-ttu-id="e318c-499">Autorise le protocole WebSockets.</span><span class="sxs-lookup"><span data-stu-id="e318c-499">Enables the WebSockets protocol.</span></span> | <span data-ttu-id="e318c-500">Avant les composants qui sont nécessaires pour accepter les requêtes WebSocket.</span><span class="sxs-lookup"><span data-stu-id="e318c-500">Before components that are required to accept WebSocket requests.</span></span> |

## <a name="additional-resources"></a><span data-ttu-id="e318c-501">Ressources supplémentaires</span><span class="sxs-lookup"><span data-stu-id="e318c-501">Additional resources</span></span>

* <xref:fundamentals/middleware/write>
* <xref:test/middleware>
* <xref:migration/http-modules>
* <xref:fundamentals/startup>
* <xref:fundamentals/request-features>
* <xref:fundamentals/middleware/extensibility>
* <xref:fundamentals/middleware/extensibility-third-party-container>

::: moniker-end
