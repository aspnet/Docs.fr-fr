---
title: Cache en mémoire dans ASP.NET Core
author: rick-anderson
description: Découvrez comment mettre en cache les données en mémoire dans ASP.NET Core.
ms.author: riande
ms.custom: mvc
ms.date: 02/02/2020
no-loc:
- appsettings.json
- ASP.NET Core Identity
- cookie
- Cookie
- Blazor
- Blazor Server
- Blazor WebAssembly
- Identity
- Let's Encrypt
- Razor
- SignalR
uid: performance/caching/memory
ms.openlocfilehash: 9b19c782d1d42ddaba590f05bab31899402f681a
ms.sourcegitcommit: 6af9016d1ffc2dffbb2454c7da29c880034cefcd
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 12/08/2020
ms.locfileid: "96901221"
---
# <a name="cache-in-memory-in-aspnet-core"></a><span data-ttu-id="be700-103">Cache en mémoire dans ASP.NET Core</span><span class="sxs-lookup"><span data-stu-id="be700-103">Cache in-memory in ASP.NET Core</span></span>

::: moniker range=">= aspnetcore-3.0"

<span data-ttu-id="be700-104">Par [Rick Anderson](https://twitter.com/RickAndMSFT), [John Luo](https://github.com/JunTaoLuo)et [Steve Smith](https://ardalis.com/)</span><span class="sxs-lookup"><span data-stu-id="be700-104">By [Rick Anderson](https://twitter.com/RickAndMSFT), [John Luo](https://github.com/JunTaoLuo), and [Steve Smith](https://ardalis.com/)</span></span>

<span data-ttu-id="be700-105">[Afficher ou télécharger l’exemple de code](https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/performance/caching/memory/3.0sample) ([procédure de téléchargement](xref:index#how-to-download-a-sample))</span><span class="sxs-lookup"><span data-stu-id="be700-105">[View or download sample code](https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/performance/caching/memory/3.0sample) ([how to download](xref:index#how-to-download-a-sample))</span></span>

## <a name="caching-basics"></a><span data-ttu-id="be700-106">Bases de la mise en cache</span><span class="sxs-lookup"><span data-stu-id="be700-106">Caching basics</span></span>

<span data-ttu-id="be700-107">La mise en cache peut améliorer considérablement les performances et l’extensibilité d’une application en réduisant le travail requis pour générer du contenu.</span><span class="sxs-lookup"><span data-stu-id="be700-107">Caching can significantly improve the performance and scalability of an app by reducing the work required to generate content.</span></span> <span data-ttu-id="be700-108">La mise en cache fonctionne mieux avec les données qui changent rarement **et** qui sont coûteuses à générer.</span><span class="sxs-lookup"><span data-stu-id="be700-108">Caching works best with data that changes infrequently **and** is expensive to generate.</span></span> <span data-ttu-id="be700-109">La mise en cache crée une copie des données qui peuvent être retournées beaucoup plus rapidement qu’à partir de la source.</span><span class="sxs-lookup"><span data-stu-id="be700-109">Caching makes a copy of data that can be returned much faster than from the source.</span></span> <span data-ttu-id="be700-110">Les applications doivent être écrites et testées pour **ne** pas dépendre des données mises en cache.</span><span class="sxs-lookup"><span data-stu-id="be700-110">Apps should be written and tested to **never** depend on cached data.</span></span>

<span data-ttu-id="be700-111">ASP.NET Core prend en charge plusieurs caches différents.</span><span class="sxs-lookup"><span data-stu-id="be700-111">ASP.NET Core supports several different caches.</span></span> <span data-ttu-id="be700-112">Le cache le plus simple est basé sur [IMemoryCache](/dotnet/api/microsoft.extensions.caching.memory.imemorycache).</span><span class="sxs-lookup"><span data-stu-id="be700-112">The simplest cache is based on the [IMemoryCache](/dotnet/api/microsoft.extensions.caching.memory.imemorycache).</span></span> <span data-ttu-id="be700-113">`IMemoryCache` représente un cache stocké dans la mémoire du serveur Web.</span><span class="sxs-lookup"><span data-stu-id="be700-113">`IMemoryCache` represents a cache stored in the memory of the web server.</span></span> <span data-ttu-id="be700-114">Les applications qui s’exécutent sur une batterie de serveurs (plusieurs serveurs) doivent s’assurer que les sessions sont permanentes lors de l’utilisation du cache en mémoire.</span><span class="sxs-lookup"><span data-stu-id="be700-114">Apps running on a server farm (multiple servers) should ensure sessions are sticky when using the in-memory cache.</span></span> <span data-ttu-id="be700-115">Les sessions rémanentes garantissent que les demandes suivantes d’un client sont toutes dirigées vers le même serveur.</span><span class="sxs-lookup"><span data-stu-id="be700-115">Sticky sessions ensure that subsequent requests from a client all go to the same server.</span></span> <span data-ttu-id="be700-116">Par exemple, Azure Web Apps utilise [application Request Routing](https://www.iis.net/learn/extensions/planning-for-arr) (arr) pour acheminer toutes les requêtes suivantes vers le même serveur.</span><span class="sxs-lookup"><span data-stu-id="be700-116">For example, Azure Web apps use [Application Request Routing](https://www.iis.net/learn/extensions/planning-for-arr) (ARR) to route all subsequent requests to the same server.</span></span>

<span data-ttu-id="be700-117">Les sessions non rémanentes dans une batterie de serveurs Web requièrent un [cache distribué](distributed.md) pour éviter les problèmes de cohérence du cache.</span><span class="sxs-lookup"><span data-stu-id="be700-117">Non-sticky sessions in a web farm require a [distributed cache](distributed.md) to avoid cache consistency problems.</span></span> <span data-ttu-id="be700-118">Pour certaines applications, un cache distribué peut prendre en charge une montée en puissance parallèle supérieure à celle d’un cache en mémoire.</span><span class="sxs-lookup"><span data-stu-id="be700-118">For some apps, a distributed cache can support higher scale-out than an in-memory cache.</span></span> <span data-ttu-id="be700-119">L’utilisation d’un cache distribué décharge la mémoire cache dans un processus externe.</span><span class="sxs-lookup"><span data-stu-id="be700-119">Using a distributed cache offloads the cache memory to an external process.</span></span>

<span data-ttu-id="be700-120">Le cache en mémoire peut stocker n’importe quel objet.</span><span class="sxs-lookup"><span data-stu-id="be700-120">The in-memory cache can store any object.</span></span> <span data-ttu-id="be700-121">L’interface du cache distribué est limitée à `byte[]` .</span><span class="sxs-lookup"><span data-stu-id="be700-121">The distributed cache interface is limited to `byte[]`.</span></span> <span data-ttu-id="be700-122">Les éléments du cache de stockage du cache distribué et en mémoire sont des paires clé-valeur.</span><span class="sxs-lookup"><span data-stu-id="be700-122">The in-memory and distributed cache store cache items as key-value pairs.</span></span>

## <a name="systemruntimecachingmemorycache"></a><span data-ttu-id="be700-123">System. Runtime. Caching/MemoryCache</span><span class="sxs-lookup"><span data-stu-id="be700-123">System.Runtime.Caching/MemoryCache</span></span>

<span data-ttu-id="be700-124"><xref:System.Runtime.Caching>/<xref:System.Runtime.Caching.MemoryCache> ([Package NuGet](https://www.nuget.org/packages/System.Runtime.Caching/)) peut être utilisé avec :</span><span class="sxs-lookup"><span data-stu-id="be700-124"><xref:System.Runtime.Caching>/<xref:System.Runtime.Caching.MemoryCache> ([NuGet package](https://www.nuget.org/packages/System.Runtime.Caching/)) can be used with:</span></span>

* <span data-ttu-id="be700-125">.NET Standard 2,0 ou version ultérieure.</span><span class="sxs-lookup"><span data-stu-id="be700-125">.NET Standard 2.0 or later.</span></span>
* <span data-ttu-id="be700-126">Toute [implémentation .net](/dotnet/standard/net-standard#net-implementation-support) qui cible .NET standard 2,0 ou version ultérieure.</span><span class="sxs-lookup"><span data-stu-id="be700-126">Any [.NET implementation](/dotnet/standard/net-standard#net-implementation-support) that targets .NET Standard 2.0 or later.</span></span> <span data-ttu-id="be700-127">Par exemple, ASP.NET Core 2,0 ou version ultérieure.</span><span class="sxs-lookup"><span data-stu-id="be700-127">For example, ASP.NET Core 2.0 or later.</span></span>
* <span data-ttu-id="be700-128">.NET Framework 4.5 ou ultérieur.</span><span class="sxs-lookup"><span data-stu-id="be700-128">.NET Framework 4.5 or later.</span></span>

<span data-ttu-id="be700-129">[Microsoft. extensions. Caching. Memory](https://www.nuget.org/packages/Microsoft.Extensions.Caching.Memory/) / `IMemoryCache` (décrit dans cet article) est recommandé `System.Runtime.Caching` / `MemoryCache` , car il est mieux intégré à ASP.net core.</span><span class="sxs-lookup"><span data-stu-id="be700-129">[Microsoft.Extensions.Caching.Memory](https://www.nuget.org/packages/Microsoft.Extensions.Caching.Memory/)/`IMemoryCache` (described in this article) is recommended over `System.Runtime.Caching`/`MemoryCache` because it's better integrated into ASP.NET Core.</span></span> <span data-ttu-id="be700-130">Par exemple, `IMemoryCache` fonctionne en mode natif avec ASP.net Core [injection de dépendances](xref:fundamentals/dependency-injection).</span><span class="sxs-lookup"><span data-stu-id="be700-130">For example, `IMemoryCache` works natively with ASP.NET Core [dependency injection](xref:fundamentals/dependency-injection).</span></span>

<span data-ttu-id="be700-131">`System.Runtime.Caching` / `MemoryCache` À utiliser en tant que pont de compatibilité lors du Portage du code de ASP.net 4. x vers ASP.net core.</span><span class="sxs-lookup"><span data-stu-id="be700-131">Use `System.Runtime.Caching`/`MemoryCache` as a compatibility bridge when porting code from ASP.NET 4.x to ASP.NET Core.</span></span>

## <a name="cache-guidelines"></a><span data-ttu-id="be700-132">Instructions du cache</span><span class="sxs-lookup"><span data-stu-id="be700-132">Cache guidelines</span></span>

* <span data-ttu-id="be700-133">Le code doit toujours avoir une option de secours pour extraire les données et **ne pas** dépendre d’une valeur mise en cache disponible.</span><span class="sxs-lookup"><span data-stu-id="be700-133">Code should always have a fallback option to fetch data and **not** depend on a cached value being available.</span></span>
* <span data-ttu-id="be700-134">Le cache utilise une ressource rare, la mémoire.</span><span class="sxs-lookup"><span data-stu-id="be700-134">The cache uses a scarce resource, memory.</span></span> <span data-ttu-id="be700-135">Limiter la croissance du cache :</span><span class="sxs-lookup"><span data-stu-id="be700-135">Limit cache growth:</span></span>
  * <span data-ttu-id="be700-136">N’utilisez **pas** d’entrée externe comme clés de cache.</span><span class="sxs-lookup"><span data-stu-id="be700-136">Do **not** use external input as cache keys.</span></span>
  * <span data-ttu-id="be700-137">Utilisez des expirations pour limiter la croissance du cache.</span><span class="sxs-lookup"><span data-stu-id="be700-137">Use expirations to limit cache growth.</span></span>
  * <span data-ttu-id="be700-138">[Utilisez les paramètres, size et SizeLimit pour limiter la taille du cache](#use-setsize-size-and-sizelimit-to-limit-cache-size).</span><span class="sxs-lookup"><span data-stu-id="be700-138">[Use SetSize, Size, and SizeLimit to limit cache size](#use-setsize-size-and-sizelimit-to-limit-cache-size).</span></span> <span data-ttu-id="be700-139">Le runtime ASP.NET Core ne limite **pas** la taille du cache en fonction de la sollicitation de la mémoire.</span><span class="sxs-lookup"><span data-stu-id="be700-139">The ASP.NET Core runtime does **not** limit cache size based on memory pressure.</span></span> <span data-ttu-id="be700-140">C’est au développeur de limiter la taille du cache.</span><span class="sxs-lookup"><span data-stu-id="be700-140">It's up to the developer to limit cache size.</span></span>

## <a name="use-imemorycache"></a><span data-ttu-id="be700-141">Utiliser IMemoryCache</span><span class="sxs-lookup"><span data-stu-id="be700-141">Use IMemoryCache</span></span>

> [!WARNING]
> <span data-ttu-id="be700-142">L’utilisation d’un cache mémoire *partagé* à partir d’une [injection de dépendance](xref:fundamentals/dependency-injection) et l’appel `SetSize` `Size` de, ou `SizeLimit` pour limiter la taille du cache peuvent entraîner l’échec de l’application.</span><span class="sxs-lookup"><span data-stu-id="be700-142">Using a *shared* memory cache from [Dependency Injection](xref:fundamentals/dependency-injection) and calling `SetSize`, `Size`, or `SizeLimit` to limit cache size can cause the app to fail.</span></span> <span data-ttu-id="be700-143">Quand une limite de taille est définie sur un cache, toutes les entrées doivent spécifier une taille lors de leur ajout.</span><span class="sxs-lookup"><span data-stu-id="be700-143">When a size limit is set on a cache, all entries must specify a size when being added.</span></span> <span data-ttu-id="be700-144">Cela peut entraîner des problèmes, car les développeurs n’ont peut-être pas un contrôle total sur ce qui utilise le cache partagé.</span><span class="sxs-lookup"><span data-stu-id="be700-144">This can lead to issues since developers may not have full control on what uses the shared cache.</span></span> <span data-ttu-id="be700-145">Par exemple, Entity Framework Core utilise le cache partagé et ne spécifie pas de taille.</span><span class="sxs-lookup"><span data-stu-id="be700-145">For example, Entity Framework Core uses the shared cache and does not specify a size.</span></span> <span data-ttu-id="be700-146">Si une application définit une limite de taille de cache et utilise EF Core, l’application lève une exception `InvalidOperationException` .</span><span class="sxs-lookup"><span data-stu-id="be700-146">If an app sets a cache size limit and uses EF Core, the app throws an `InvalidOperationException`.</span></span>
> <span data-ttu-id="be700-147">Lorsque `SetSize` vous utilisez, `Size` ou `SizeLimit` pour limiter le cache, créez un singleton de cache pour la mise en cache.</span><span class="sxs-lookup"><span data-stu-id="be700-147">When using `SetSize`, `Size`, or `SizeLimit` to limit cache, create a cache singleton for caching.</span></span> <span data-ttu-id="be700-148">Pour plus d’informations et pour obtenir un exemple, consultez utiliser la configuration, la [taille et SizeLimit pour limiter la taille du cache](#use-setsize-size-and-sizelimit-to-limit-cache-size).</span><span class="sxs-lookup"><span data-stu-id="be700-148">For more information and an example, see [Use SetSize, Size, and SizeLimit to limit cache size](#use-setsize-size-and-sizelimit-to-limit-cache-size).</span></span>
> <span data-ttu-id="be700-149">Un cache partagé est un cache partagé par d’autres infrastructures ou bibliothèques.</span><span class="sxs-lookup"><span data-stu-id="be700-149">A shared cache is one shared by other frameworks or libraries.</span></span> <span data-ttu-id="be700-150">Par exemple, EF Core utilise le cache partagé et ne spécifie pas de taille.</span><span class="sxs-lookup"><span data-stu-id="be700-150">For example, EF Core uses the shared cache and does not specify a size.</span></span> 

<span data-ttu-id="be700-151">La mise en cache en mémoire est un *service* référencé à partir d’une application à l’aide de l' [injection de dépendances](xref:fundamentals/dependency-injection).</span><span class="sxs-lookup"><span data-stu-id="be700-151">In-memory caching is a *service* that's referenced from an app using [Dependency Injection](xref:fundamentals/dependency-injection).</span></span> <span data-ttu-id="be700-152">Demandez l' `IMemoryCache` instance dans le constructeur :</span><span class="sxs-lookup"><span data-stu-id="be700-152">Request the `IMemoryCache` instance in the constructor:</span></span>

[!code-csharp[](memory/3.0sample/WebCacheSample/Controllers/HomeController.cs?name=snippet_ctor)]

<span data-ttu-id="be700-153">Le code suivant utilise [TryGetValue](/dotnet/api/microsoft.extensions.caching.memory.imemorycache.trygetvalue?view=aspnetcore-2.0#Microsoft_Extensions_Caching_Memory_IMemoryCache_TryGetValue_System_Object_System_Object__) pour vérifier si une heure se trouve dans le cache.</span><span class="sxs-lookup"><span data-stu-id="be700-153">The following code uses [TryGetValue](/dotnet/api/microsoft.extensions.caching.memory.imemorycache.trygetvalue?view=aspnetcore-2.0#Microsoft_Extensions_Caching_Memory_IMemoryCache_TryGetValue_System_Object_System_Object__) to check if a time is in the cache.</span></span> <span data-ttu-id="be700-154">Si une heure n’est pas mise en cache, une nouvelle entrée est créée et ajoutée au cache avec [Set](/dotnet/api/microsoft.extensions.caching.memory.cacheextensions.set?view=aspnetcore-2.0#Microsoft_Extensions_Caching_Memory_CacheExtensions_Set__1_Microsoft_Extensions_Caching_Memory_IMemoryCache_System_Object___0_Microsoft_Extensions_Caching_Memory_MemoryCacheEntryOptions_).</span><span class="sxs-lookup"><span data-stu-id="be700-154">If a time isn't cached, a new entry is created and added to the cache with [Set](/dotnet/api/microsoft.extensions.caching.memory.cacheextensions.set?view=aspnetcore-2.0#Microsoft_Extensions_Caching_Memory_CacheExtensions_Set__1_Microsoft_Extensions_Caching_Memory_IMemoryCache_System_Object___0_Microsoft_Extensions_Caching_Memory_MemoryCacheEntryOptions_).</span></span> <span data-ttu-id="be700-155">La `CacheKeys` classe fait partie de l’exemple Download.</span><span class="sxs-lookup"><span data-stu-id="be700-155">The `CacheKeys` class is part of the download sample.</span></span>

[!code-csharp[](memory/3.0sample/WebCacheSample/CacheKeys.cs)]

[!code-csharp[](memory/3.0sample/WebCacheSample/Controllers/HomeController.cs?name=snippet1)]

<span data-ttu-id="be700-156">L’heure actuelle et l’heure de mise en cache sont affichées :</span><span class="sxs-lookup"><span data-stu-id="be700-156">The current time and the cached time are displayed:</span></span>

[!code-cshtml[](memory/3.0sample/WebCacheSample/Views/Home/Cache.cshtml)]

<span data-ttu-id="be700-157">Le code suivant utilise la méthode d’extension [Set pour mettre](/dotnet/api/microsoft.extensions.caching.memory.cacheextensions.set#Microsoft_Extensions_Caching_Memory_CacheExtensions_Set__1_Microsoft_Extensions_Caching_Memory_IMemoryCache_System_Object___0_System_TimeSpan_) en cache des données pour une heure relative sans créer l' `MemoryCacheEntryOptions` objet.</span><span class="sxs-lookup"><span data-stu-id="be700-157">The following code uses the [Set](/dotnet/api/microsoft.extensions.caching.memory.cacheextensions.set#Microsoft_Extensions_Caching_Memory_CacheExtensions_Set__1_Microsoft_Extensions_Caching_Memory_IMemoryCache_System_Object___0_System_TimeSpan_) extension method to cache data for a relative time without creating the `MemoryCacheEntryOptions` object.</span></span>
[!code-csharp[](memory/3.0sample/WebCacheSample/Controllers/HomeController.cs?name=snippet_set)]

<span data-ttu-id="be700-158">La valeur mise en cache `DateTime` reste dans le cache pendant qu’il y a des requêtes dans le délai imparti.</span><span class="sxs-lookup"><span data-stu-id="be700-158">The cached `DateTime` value remains in the cache while there are requests within the timeout period.</span></span>

<span data-ttu-id="be700-159">Le code suivant utilise [GetOrCreate](/dotnet/api/microsoft.extensions.caching.memory.cacheextensions.getorcreate#Microsoft_Extensions_Caching_Memory_CacheExtensions_GetOrCreate__1_Microsoft_Extensions_Caching_Memory_IMemoryCache_System_Object_System_Func_Microsoft_Extensions_Caching_Memory_ICacheEntry___0__) et [GetOrCreateAsync](/dotnet/api/microsoft.extensions.caching.memory.cacheextensions.getorcreateasync#Microsoft_Extensions_Caching_Memory_CacheExtensions_GetOrCreateAsync__1_Microsoft_Extensions_Caching_Memory_IMemoryCache_System_Object_System_Func_Microsoft_Extensions_Caching_Memory_ICacheEntry_System_Threading_Tasks_Task___0___) pour mettre en cache des données.</span><span class="sxs-lookup"><span data-stu-id="be700-159">The following code uses [GetOrCreate](/dotnet/api/microsoft.extensions.caching.memory.cacheextensions.getorcreate#Microsoft_Extensions_Caching_Memory_CacheExtensions_GetOrCreate__1_Microsoft_Extensions_Caching_Memory_IMemoryCache_System_Object_System_Func_Microsoft_Extensions_Caching_Memory_ICacheEntry___0__) and [GetOrCreateAsync](/dotnet/api/microsoft.extensions.caching.memory.cacheextensions.getorcreateasync#Microsoft_Extensions_Caching_Memory_CacheExtensions_GetOrCreateAsync__1_Microsoft_Extensions_Caching_Memory_IMemoryCache_System_Object_System_Func_Microsoft_Extensions_Caching_Memory_ICacheEntry_System_Threading_Tasks_Task___0___) to cache data.</span></span>

[!code-csharp[](memory/3.0sample/WebCacheSample/Controllers/HomeController.cs?name=snippet2&highlight=3-7,14-19)]

<span data-ttu-id="be700-160">Le code [suivant appelle la commande pour récupérer le](/dotnet/api/microsoft.extensions.caching.memory.cacheextensions.get#Microsoft_Extensions_Caching_Memory_CacheExtensions_Get__1_Microsoft_Extensions_Caching_Memory_IMemoryCache_System_Object_) temps mis en cache :</span><span class="sxs-lookup"><span data-stu-id="be700-160">The following code calls [Get](/dotnet/api/microsoft.extensions.caching.memory.cacheextensions.get#Microsoft_Extensions_Caching_Memory_CacheExtensions_Get__1_Microsoft_Extensions_Caching_Memory_IMemoryCache_System_Object_) to fetch the cached time:</span></span>

[!code-csharp[](memory/3.0sample/WebCacheSample/Controllers/HomeController.cs?name=snippet_gct)]

<span data-ttu-id="be700-161">Le code suivant obtient ou crée un élément mis en cache avec une expiration absolue :</span><span class="sxs-lookup"><span data-stu-id="be700-161">The following code gets or creates a cached item with absolute expiration:</span></span>

[!code-csharp[](memory/3.0sample/WebCacheSample/Controllers/HomeController.cs?name=snippet99)]

<span data-ttu-id="be700-162">Un ensemble d’éléments mis en cache avec une expiration décalée est à risque de devenir obsolète.</span><span class="sxs-lookup"><span data-stu-id="be700-162">A cached item set with a sliding expiration only is at risk of becoming stale.</span></span> <span data-ttu-id="be700-163">Si l’accès est plus fréquent que l’intervalle d’expiration décalé, l’élément n’expire jamais.</span><span class="sxs-lookup"><span data-stu-id="be700-163">If it's accessed more frequently than the sliding expiration interval, the item will never expire.</span></span> <span data-ttu-id="be700-164">Combinez une expiration décalée avec une expiration absolue pour garantir que l’élément expire une fois que son heure d’expiration absolue s’est écoulée.</span><span class="sxs-lookup"><span data-stu-id="be700-164">Combine a sliding expiration with an absolute expiration to guarantee that the item expires once its absolute expiration time passes.</span></span> <span data-ttu-id="be700-165">L’expiration absolue définit une limite supérieure à la durée pendant laquelle l’élément peut être mis en cache tout en autorisant l’expiration antérieure de l’élément s’il n’est pas demandé dans l’intervalle d’expiration décalé.</span><span class="sxs-lookup"><span data-stu-id="be700-165">The absolute expiration sets an upper bound to how long the item can be cached while still allowing the item to expire earlier if it isn't requested within the sliding expiration interval.</span></span> <span data-ttu-id="be700-166">Lorsque les expirations absolues et décalées sont spécifiées, les expirations sont logiquement associées.</span><span class="sxs-lookup"><span data-stu-id="be700-166">When both absolute and sliding expiration are specified, the expirations are logically ORed.</span></span> <span data-ttu-id="be700-167">Si l’intervalle d’expiration décalé *ou* le délai d’expiration absolu est écoulé, l’élément est supprimé du cache.</span><span class="sxs-lookup"><span data-stu-id="be700-167">If either the sliding expiration interval *or* the absolute expiration time pass, the item is evicted from the cache.</span></span>

<span data-ttu-id="be700-168">Le code suivant obtient ou crée un élément mis en cache avec l’expiration décalée *et* absolue :</span><span class="sxs-lookup"><span data-stu-id="be700-168">The following code gets or creates a cached item with both sliding *and* absolute expiration:</span></span>

[!code-csharp[](memory/3.0sample/WebCacheSample/Controllers/HomeController.cs?name=snippet9)]

<span data-ttu-id="be700-169">Le code précédent garantit que les données ne seront pas mises en cache plus longtemps que l’heure absolue.</span><span class="sxs-lookup"><span data-stu-id="be700-169">The preceding code guarantees the data will not be cached longer than the absolute time.</span></span>

<span data-ttu-id="be700-170"><xref:Microsoft.Extensions.Caching.Memory.CacheExtensions.GetOrCreate*>, <xref:Microsoft.Extensions.Caching.Memory.CacheExtensions.GetOrCreateAsync*> et <xref:Microsoft.Extensions.Caching.Memory.CacheExtensions.Get*> sont des méthodes d’extension dans la <xref:Microsoft.Extensions.Caching.Memory.CacheExtensions> classe.</span><span class="sxs-lookup"><span data-stu-id="be700-170"><xref:Microsoft.Extensions.Caching.Memory.CacheExtensions.GetOrCreate*>, <xref:Microsoft.Extensions.Caching.Memory.CacheExtensions.GetOrCreateAsync*>, and <xref:Microsoft.Extensions.Caching.Memory.CacheExtensions.Get*> are extension methods in the <xref:Microsoft.Extensions.Caching.Memory.CacheExtensions> class.</span></span> <span data-ttu-id="be700-171">Ces méthodes étendent la capacité de <xref:Microsoft.Extensions.Caching.Memory.IMemoryCache> .</span><span class="sxs-lookup"><span data-stu-id="be700-171">These methods extend the capability of <xref:Microsoft.Extensions.Caching.Memory.IMemoryCache>.</span></span>

## <a name="memorycacheentryoptions"></a><span data-ttu-id="be700-172">MemoryCacheEntryOptions</span><span class="sxs-lookup"><span data-stu-id="be700-172">MemoryCacheEntryOptions</span></span>

<span data-ttu-id="be700-173">L’exemple suivant :</span><span class="sxs-lookup"><span data-stu-id="be700-173">The following sample:</span></span>

* <span data-ttu-id="be700-174">Définit une heure d’expiration décalée.</span><span class="sxs-lookup"><span data-stu-id="be700-174">Sets a sliding expiration time.</span></span> <span data-ttu-id="be700-175">Les requêtes qui accèdent à cet élément mis en cache réinitialisent l’horloge d’expiration décalée.</span><span class="sxs-lookup"><span data-stu-id="be700-175">Requests that access this cached item will reset the sliding expiration clock.</span></span>
* <span data-ttu-id="be700-176">Définit la priorité du cache sur [CacheItemPriority. NeverRemove](xref:Microsoft.Extensions.Caching.Memory.CacheItemPriority.NeverRemove).</span><span class="sxs-lookup"><span data-stu-id="be700-176">Sets the cache priority to [CacheItemPriority.NeverRemove](xref:Microsoft.Extensions.Caching.Memory.CacheItemPriority.NeverRemove).</span></span>
* <span data-ttu-id="be700-177">Définit un [PostEvictionDelegate](/dotnet/api/microsoft.extensions.caching.memory.postevictiondelegate) qui sera appelé une fois que l’entrée est supprimée du cache.</span><span class="sxs-lookup"><span data-stu-id="be700-177">Sets a [PostEvictionDelegate](/dotnet/api/microsoft.extensions.caching.memory.postevictiondelegate) that will be called after the entry is evicted from the cache.</span></span> <span data-ttu-id="be700-178">Le rappel est exécuté sur un thread différent du code qui supprime l’élément du cache.</span><span class="sxs-lookup"><span data-stu-id="be700-178">The callback is run on a different thread from the code that removes the item from the cache.</span></span>

[!code-csharp[](memory/3.0sample/WebCacheSample/Controllers/HomeController.cs?name=snippet_et&highlight=14-21)]

## <a name="use-setsize-size-and-sizelimit-to-limit-cache-size"></a><span data-ttu-id="be700-179">Utiliser la valeur de Size, size et SizeLimit pour limiter la taille du cache</span><span class="sxs-lookup"><span data-stu-id="be700-179">Use SetSize, Size, and SizeLimit to limit cache size</span></span>

<span data-ttu-id="be700-180">Une `MemoryCache` instance peut éventuellement spécifier et appliquer une limite de taille.</span><span class="sxs-lookup"><span data-stu-id="be700-180">A `MemoryCache` instance may optionally specify and enforce a size limit.</span></span> <span data-ttu-id="be700-181">La limite de taille du cache n’a pas d’unité de mesure définie car le cache n’a pas de mécanisme pour mesurer la taille des entrées.</span><span class="sxs-lookup"><span data-stu-id="be700-181">The cache size limit does not have a defined unit of measure because the cache has no mechanism to measure the size of entries.</span></span> <span data-ttu-id="be700-182">Si la limite de taille du cache est définie, toutes les entrées doivent spécifier la taille.</span><span class="sxs-lookup"><span data-stu-id="be700-182">If the cache size limit is set, all entries must specify size.</span></span> <span data-ttu-id="be700-183">Le runtime ASP.NET Core ne limite pas la taille du cache en fonction de la sollicitation de la mémoire.</span><span class="sxs-lookup"><span data-stu-id="be700-183">The ASP.NET Core runtime does not limit cache size based on memory pressure.</span></span> <span data-ttu-id="be700-184">C’est au développeur de limiter la taille du cache.</span><span class="sxs-lookup"><span data-stu-id="be700-184">It's up to the developer to limit cache size.</span></span> <span data-ttu-id="be700-185">La taille spécifiée est dans les unités choisies par le développeur.</span><span class="sxs-lookup"><span data-stu-id="be700-185">The size specified is in units the developer chooses.</span></span>

<span data-ttu-id="be700-186">Par exemple :</span><span class="sxs-lookup"><span data-stu-id="be700-186">For example:</span></span>

* <span data-ttu-id="be700-187">Si l’application Web a principalement mis en cache des chaînes, chaque taille d’entrée de cache peut être la longueur de chaîne.</span><span class="sxs-lookup"><span data-stu-id="be700-187">If the web app was primarily caching strings, each cache entry size could be the string length.</span></span>
* <span data-ttu-id="be700-188">L’application peut spécifier la taille de toutes les entrées en tant que 1, et la limite de taille est le nombre d’entrées.</span><span class="sxs-lookup"><span data-stu-id="be700-188">The app could specify the size of all entries as 1, and the size limit is the count of entries.</span></span>

<span data-ttu-id="be700-189">Si <xref:Microsoft.Extensions.Caching.Memory.MemoryCacheOptions.SizeLimit> n’est pas défini, le cache croît sans limite.</span><span class="sxs-lookup"><span data-stu-id="be700-189">If <xref:Microsoft.Extensions.Caching.Memory.MemoryCacheOptions.SizeLimit> isn't set, the cache grows without bound.</span></span> <span data-ttu-id="be700-190">Le runtime ASP.NET Core ne supprime pas le cache lorsque la mémoire système est insuffisante.</span><span class="sxs-lookup"><span data-stu-id="be700-190">The ASP.NET Core runtime doesn't trim the cache when system memory is low.</span></span> <span data-ttu-id="be700-191">Les applications doivent être conçues pour :</span><span class="sxs-lookup"><span data-stu-id="be700-191">Apps must be architected to:</span></span>

* <span data-ttu-id="be700-192">Limiter la croissance du cache.</span><span class="sxs-lookup"><span data-stu-id="be700-192">Limit cache growth.</span></span>
* <span data-ttu-id="be700-193">Appelez <xref:Microsoft.Extensions.Caching.Memory.MemoryCache.Compact*> ou <xref:Microsoft.Extensions.Caching.Memory.MemoryCache.Remove*> lorsque la mémoire disponible est limitée :</span><span class="sxs-lookup"><span data-stu-id="be700-193">Call <xref:Microsoft.Extensions.Caching.Memory.MemoryCache.Compact*> or <xref:Microsoft.Extensions.Caching.Memory.MemoryCache.Remove*> when available memory is limited:</span></span>

<span data-ttu-id="be700-194">Le code suivant crée une taille fixe sans unité <xref:Microsoft.Extensions.Caching.Memory.MemoryCache> accessible par [injection de dépendances](xref:fundamentals/dependency-injection):</span><span class="sxs-lookup"><span data-stu-id="be700-194">The following code creates a unitless fixed size <xref:Microsoft.Extensions.Caching.Memory.MemoryCache> accessible by [dependency injection](xref:fundamentals/dependency-injection):</span></span>

[!code-csharp[](memory/sample/RPcache/Services/MyMemoryCache.cs?name=snippet)]

<span data-ttu-id="be700-195">`SizeLimit` n’a pas d’unités.</span><span class="sxs-lookup"><span data-stu-id="be700-195">`SizeLimit` does not have units.</span></span> <span data-ttu-id="be700-196">Les entrées mises en cache doivent spécifier la taille des unités qu’elles estiment le plus approprié si la limite de taille du cache a été définie.</span><span class="sxs-lookup"><span data-stu-id="be700-196">Cached entries must specify size in whatever units they deem most appropriate if the cache size limit has been set.</span></span> <span data-ttu-id="be700-197">Tous les utilisateurs d’une instance de cache doivent utiliser le même système d’unité.</span><span class="sxs-lookup"><span data-stu-id="be700-197">All users of a cache instance should use the same unit system.</span></span> <span data-ttu-id="be700-198">Une entrée ne sera pas mise en cache si la somme des tailles d’entrée mises en cache dépasse la valeur spécifiée par `SizeLimit` .</span><span class="sxs-lookup"><span data-stu-id="be700-198">An entry will not be cached if the sum of the cached entry sizes exceeds the value specified by `SizeLimit`.</span></span> <span data-ttu-id="be700-199">Si aucune limite de taille du cache n’est définie, la taille du cache définie sur l’entrée sera ignorée.</span><span class="sxs-lookup"><span data-stu-id="be700-199">If no cache size limit is set, the cache size set on the entry will be ignored.</span></span>

<span data-ttu-id="be700-200">Le code suivant s’inscrit `MyMemoryCache` auprès du conteneur d' [injection de dépendances](xref:fundamentals/dependency-injection) .</span><span class="sxs-lookup"><span data-stu-id="be700-200">The following code registers `MyMemoryCache` with the [dependency injection](xref:fundamentals/dependency-injection) container.</span></span>

[!code-csharp[](memory/3.0sample/RPcache/Startup.cs?name=snippet)]

<span data-ttu-id="be700-201">`MyMemoryCache` est créé en tant que cache mémoire indépendant pour les composants qui connaissent ce cache de taille limitée et savent comment définir la taille d’entrée du cache de manière appropriée.</span><span class="sxs-lookup"><span data-stu-id="be700-201">`MyMemoryCache` is created as an independent memory cache for components that are aware of this size limited cache and know how to set cache entry size appropriately.</span></span>

<span data-ttu-id="be700-202">Le code suivant utilise `MyMemoryCache` :</span><span class="sxs-lookup"><span data-stu-id="be700-202">The following code uses `MyMemoryCache`:</span></span>

[!code-csharp[](memory/3.0sample/RPcache/Pages/SetSize.cshtml.cs?name=snippet)]

<span data-ttu-id="be700-203">La taille de l’entrée de cache peut être définie par <xref:Microsoft.Extensions.Caching.Memory.MemoryCacheEntryOptions.Size> ou par les <xref:Microsoft.Extensions.Caching.Memory.MemoryCacheEntryExtensions.SetSize*> méthodes d’extension :</span><span class="sxs-lookup"><span data-stu-id="be700-203">The size of the cache entry can be set by <xref:Microsoft.Extensions.Caching.Memory.MemoryCacheEntryOptions.Size> or the <xref:Microsoft.Extensions.Caching.Memory.MemoryCacheEntryExtensions.SetSize*> extension methods:</span></span>

[!code-csharp[](memory/3.0sample/RPcache/Pages/SetSize.cshtml.cs?name=snippet2&highlight=9,10,14,15)]

### <a name="memorycachecompact"></a><span data-ttu-id="be700-204">MemoryCache. compact</span><span class="sxs-lookup"><span data-stu-id="be700-204">MemoryCache.Compact</span></span>

<span data-ttu-id="be700-205">`MemoryCache.Compact` tente de supprimer le pourcentage spécifié du cache dans l’ordre suivant :</span><span class="sxs-lookup"><span data-stu-id="be700-205">`MemoryCache.Compact` attempts to remove the specified percentage of the cache in the following order:</span></span>

* <span data-ttu-id="be700-206">Tous les éléments arrivés à expiration.</span><span class="sxs-lookup"><span data-stu-id="be700-206">All expired items.</span></span>
* <span data-ttu-id="be700-207">Éléments par priorité.</span><span class="sxs-lookup"><span data-stu-id="be700-207">Items by priority.</span></span> <span data-ttu-id="be700-208">Les éléments de priorité la plus basse sont supprimés en premier.</span><span class="sxs-lookup"><span data-stu-id="be700-208">Lowest priority items are removed first.</span></span>
* <span data-ttu-id="be700-209">Objets utilisés le moins récemment.</span><span class="sxs-lookup"><span data-stu-id="be700-209">Least recently used objects.</span></span>
* <span data-ttu-id="be700-210">Éléments avec l’expiration absolue la plus ancienne.</span><span class="sxs-lookup"><span data-stu-id="be700-210">Items with the earliest absolute expiration.</span></span>
* <span data-ttu-id="be700-211">Éléments avec l’expiration décalée la plus ancienne.</span><span class="sxs-lookup"><span data-stu-id="be700-211">Items with the earliest sliding expiration.</span></span>

<span data-ttu-id="be700-212">Les éléments épinglés avec priorité <xref:Microsoft.Extensions.Caching.Memory.CacheItemPriority.NeverRemove> ne sont jamais supprimés.</span><span class="sxs-lookup"><span data-stu-id="be700-212">Pinned items with priority <xref:Microsoft.Extensions.Caching.Memory.CacheItemPriority.NeverRemove> are never removed.</span></span> <span data-ttu-id="be700-213">Le code suivant supprime un élément de cache et appelle `Compact` :</span><span class="sxs-lookup"><span data-stu-id="be700-213">The following code removes a cache item and calls `Compact`:</span></span>

[!code-csharp[](memory/3.0sample/RPcache/Pages/TestCache.cshtml.cs?name=snippet3)]

<span data-ttu-id="be700-214">Pour plus d’informations, consultez [source compact sur GitHub](https://github.com/dotnet/extensions/blob/v3.0.0-preview8.19405.4/src/Caching/Memory/src/MemoryCache.cs#L382-L393) .</span><span class="sxs-lookup"><span data-stu-id="be700-214">See [Compact source on GitHub](https://github.com/dotnet/extensions/blob/v3.0.0-preview8.19405.4/src/Caching/Memory/src/MemoryCache.cs#L382-L393) for more information.</span></span>

## <a name="cache-dependencies"></a><span data-ttu-id="be700-215">Dépendances de cache</span><span class="sxs-lookup"><span data-stu-id="be700-215">Cache dependencies</span></span>

<span data-ttu-id="be700-216">L’exemple suivant montre comment faire expirer une entrée de cache en cas d’expiration d’une entrée dépendante.</span><span class="sxs-lookup"><span data-stu-id="be700-216">The following sample shows how to expire a cache entry if a dependent entry expires.</span></span> <span data-ttu-id="be700-217">Un <xref:Microsoft.Extensions.Primitives.CancellationChangeToken> est ajouté à l’élément mis en cache.</span><span class="sxs-lookup"><span data-stu-id="be700-217">A <xref:Microsoft.Extensions.Primitives.CancellationChangeToken> is added to the cached item.</span></span> <span data-ttu-id="be700-218">Lorsque `Cancel` est appelé sur `CancellationTokenSource` , les deux entrées du cache sont supprimées.</span><span class="sxs-lookup"><span data-stu-id="be700-218">When `Cancel` is called on the `CancellationTokenSource`, both cache entries are evicted.</span></span>

[!code-csharp[](memory/3.0sample/WebCacheSample/Controllers/HomeController.cs?name=snippet_ed)]

<span data-ttu-id="be700-219">L’utilisation de <xref:System.Threading.CancellationTokenSource> permet de supprimer plusieurs entrées de cache en tant que groupe.</span><span class="sxs-lookup"><span data-stu-id="be700-219">Using a <xref:System.Threading.CancellationTokenSource> allows multiple cache entries to be evicted as a group.</span></span> <span data-ttu-id="be700-220">Avec le `using` modèle dans le code ci-dessus, les entrées de cache créées à l’intérieur du `using` bloc héritent des déclencheurs et des paramètres d’expiration.</span><span class="sxs-lookup"><span data-stu-id="be700-220">With the `using` pattern in the code above, cache entries created inside the `using` block will inherit triggers and expiration settings.</span></span>

## <a name="additional-notes"></a><span data-ttu-id="be700-221">Remarques supplémentaires</span><span class="sxs-lookup"><span data-stu-id="be700-221">Additional notes</span></span>

* <span data-ttu-id="be700-222">L’expiration ne se produit pas en arrière-plan.</span><span class="sxs-lookup"><span data-stu-id="be700-222">Expiration doesn't happen in the background.</span></span> <span data-ttu-id="be700-223">Il n’existe pas de minuteur qui analyse activement le cache à la recherche d’éléments arrivés à expiration.</span><span class="sxs-lookup"><span data-stu-id="be700-223">There is no timer that actively scans the cache for expired items.</span></span> <span data-ttu-id="be700-224">Toute activité sur le cache ( `Get` , `Set` , `Remove` ) peut déclencher une analyse en arrière-plan des éléments arrivés à expiration.</span><span class="sxs-lookup"><span data-stu-id="be700-224">Any activity on the cache (`Get`, `Set`, `Remove`) can trigger a background scan for expired items.</span></span> <span data-ttu-id="be700-225">Un minuteur sur `CancellationTokenSource` ( <xref:System.Threading.CancellationTokenSource.CancelAfter*> ) supprime également l’entrée et déclenche une analyse des éléments arrivés à expiration.</span><span class="sxs-lookup"><span data-stu-id="be700-225">A timer on the `CancellationTokenSource` (<xref:System.Threading.CancellationTokenSource.CancelAfter*>) also removes the entry and trigger a scan for expired items.</span></span> <span data-ttu-id="be700-226">L’exemple suivant utilise [CancellationTokenSource (TimeSpan)](/dotnet/api/system.threading.cancellationtokensource.-ctor) pour le jeton inscrit.</span><span class="sxs-lookup"><span data-stu-id="be700-226">The following example uses [CancellationTokenSource(TimeSpan)](/dotnet/api/system.threading.cancellationtokensource.-ctor) for the registered token.</span></span> <span data-ttu-id="be700-227">Quand ce jeton est activé, il supprime immédiatement l’entrée et déclenche les rappels d’éviction :</span><span class="sxs-lookup"><span data-stu-id="be700-227">When this token fires it removes the entry immediately and fires the eviction callbacks:</span></span>

[!code-csharp[](memory/3.0sample/WebCacheSample/Controllers/HomeController.cs?name=snippet_ae)]

* <span data-ttu-id="be700-228">Lors de l’utilisation d’un rappel pour remplir à nouveau un élément de cache :</span><span class="sxs-lookup"><span data-stu-id="be700-228">When using a callback to repopulate a cache item:</span></span>

  * <span data-ttu-id="be700-229">Plusieurs demandes peuvent trouver la valeur de clé mise en cache vide, car le rappel n’est pas terminé.</span><span class="sxs-lookup"><span data-stu-id="be700-229">Multiple requests can find the cached key value empty because the callback hasn't completed.</span></span>
  * <span data-ttu-id="be700-230">Cela peut entraîner le remplissage de plusieurs threads de l’élément mis en cache.</span><span class="sxs-lookup"><span data-stu-id="be700-230">This can result in several threads repopulating the cached item.</span></span>

* <span data-ttu-id="be700-231">Lorsqu’une entrée de cache est utilisée pour en créer une autre, l’enfant copie les jetons d’expiration de l’entrée parente et les paramètres d’expiration basés sur la durée.</span><span class="sxs-lookup"><span data-stu-id="be700-231">When one cache entry is used to create another, the child copies the parent entry's expiration tokens and time-based expiration settings.</span></span> <span data-ttu-id="be700-232">L’enfant n’a pas expiré par la suppression ou la mise à jour manuelle de l’entrée parente.</span><span class="sxs-lookup"><span data-stu-id="be700-232">The child isn't expired by manual removal or updating of the parent entry.</span></span>

* <span data-ttu-id="be700-233">Utilisez <xref:Microsoft.Extensions.Caching.Memory.ICacheEntry.PostEvictionCallbacks> pour définir les rappels qui seront déclenchés après que l’entrée du cache a été supprimée du cache.</span><span class="sxs-lookup"><span data-stu-id="be700-233">Use <xref:Microsoft.Extensions.Caching.Memory.ICacheEntry.PostEvictionCallbacks> to set the callbacks that will be fired after the cache entry is evicted from the cache.</span></span>
* <span data-ttu-id="be700-234">Pour la plupart des applications, `IMemoryCache` est activé.</span><span class="sxs-lookup"><span data-stu-id="be700-234">For most apps, `IMemoryCache` is enabled.</span></span> <span data-ttu-id="be700-235">Par exemple, l’appel de `AddMvc` , `AddControllersWithViews` , `AddRazorPages` , `AddMvcCore().AddRazorViewEngine` , et `Add{Service}` de nombreuses autres méthodes dans `ConfigureServices` , active `IMemoryCache` .</span><span class="sxs-lookup"><span data-stu-id="be700-235">For example, calling `AddMvc`, `AddControllersWithViews`, `AddRazorPages`, `AddMvcCore().AddRazorViewEngine`, and many other `Add{Service}` methods in `ConfigureServices`, enables `IMemoryCache`.</span></span> <span data-ttu-id="be700-236">Pour les applications qui n’appellent pas l’une des `Add{Service}` méthodes précédentes, il peut être nécessaire d’appeler <xref:Microsoft.Extensions.DependencyInjection.MemoryCacheServiceCollectionExtensions.AddMemoryCache*> dans `ConfigureServices` .</span><span class="sxs-lookup"><span data-stu-id="be700-236">For apps that are not calling one of the preceding `Add{Service}` methods, it may be necessary to call <xref:Microsoft.Extensions.DependencyInjection.MemoryCacheServiceCollectionExtensions.AddMemoryCache*> in `ConfigureServices`.</span></span>

## <a name="background-cache-update"></a><span data-ttu-id="be700-237">Mise à jour du cache en arrière-plan</span><span class="sxs-lookup"><span data-stu-id="be700-237">Background cache update</span></span>

<span data-ttu-id="be700-238">Utilisez un [service d’arrière-plan](xref:fundamentals/host/hosted-services) tel que <xref:Microsoft.Extensions.Hosting.IHostedService> pour mettre à jour le cache.</span><span class="sxs-lookup"><span data-stu-id="be700-238">Use a [background service](xref:fundamentals/host/hosted-services) such as <xref:Microsoft.Extensions.Hosting.IHostedService> to update the cache.</span></span> <span data-ttu-id="be700-239">Le service d’arrière-plan peut recalculer les entrées, puis les assigner au cache uniquement lorsqu’elles sont prêtes.</span><span class="sxs-lookup"><span data-stu-id="be700-239">The background service can recompute the entries and then assign them to the cache only when they’re ready.</span></span>

## <a name="additional-resources"></a><span data-ttu-id="be700-240">Ressources supplémentaires</span><span class="sxs-lookup"><span data-stu-id="be700-240">Additional resources</span></span>

* <xref:performance/caching/distributed>
* <xref:fundamentals/change-tokens>
* <xref:performance/caching/response>
* <xref:performance/caching/middleware>
* <xref:mvc/views/tag-helpers/builtin-th/cache-tag-helper>
* <xref:mvc/views/tag-helpers/builtin-th/distributed-cache-tag-helper>

::: moniker-end

::: moniker range="< aspnetcore-3.0"

<!-- This is the 2.1 version -->
<span data-ttu-id="be700-241">Par [Rick Anderson](https://twitter.com/RickAndMSFT), [John Luo](https://github.com/JunTaoLuo)et [Steve Smith](https://ardalis.com/)</span><span class="sxs-lookup"><span data-stu-id="be700-241">By [Rick Anderson](https://twitter.com/RickAndMSFT), [John Luo](https://github.com/JunTaoLuo), and [Steve Smith](https://ardalis.com/)</span></span>

<span data-ttu-id="be700-242">[Afficher ou télécharger l’exemple de code](https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/performance/caching/memory/sample) ([procédure de téléchargement](xref:index#how-to-download-a-sample))</span><span class="sxs-lookup"><span data-stu-id="be700-242">[View or download sample code](https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/performance/caching/memory/sample) ([how to download](xref:index#how-to-download-a-sample))</span></span>

## <a name="caching-basics"></a><span data-ttu-id="be700-243">Bases de la mise en cache</span><span class="sxs-lookup"><span data-stu-id="be700-243">Caching basics</span></span>

<span data-ttu-id="be700-244">La mise en cache peut améliorer considérablement les performances et l’extensibilité d’une application en réduisant le travail requis pour générer du contenu.</span><span class="sxs-lookup"><span data-stu-id="be700-244">Caching can significantly improve the performance and scalability of an app by reducing the work required to generate content.</span></span> <span data-ttu-id="be700-245">La mise en cache fonctionne mieux avec les données qui changent rarement.</span><span class="sxs-lookup"><span data-stu-id="be700-245">Caching works best with data that changes infrequently.</span></span> <span data-ttu-id="be700-246">La mise en cache crée une copie des données qui peuvent être retournées beaucoup plus rapidement qu’à partir de la source d’origine.</span><span class="sxs-lookup"><span data-stu-id="be700-246">Caching makes a copy of data that can be returned much faster than from the original source.</span></span> <span data-ttu-id="be700-247">Le code doit être écrit et testé pour **ne** pas dépendre des données mises en cache.</span><span class="sxs-lookup"><span data-stu-id="be700-247">Code should be written and tested to **never** depend on cached data.</span></span>

<span data-ttu-id="be700-248">ASP.NET Core prend en charge plusieurs caches différents.</span><span class="sxs-lookup"><span data-stu-id="be700-248">ASP.NET Core supports several different caches.</span></span> <span data-ttu-id="be700-249">Le cache le plus simple est basé sur [IMemoryCache](/dotnet/api/microsoft.extensions.caching.memory.imemorycache), qui représente un cache stocké dans la mémoire du serveur Web.</span><span class="sxs-lookup"><span data-stu-id="be700-249">The simplest cache is based on the [IMemoryCache](/dotnet/api/microsoft.extensions.caching.memory.imemorycache), which represents a cache stored in the memory of the web server.</span></span> <span data-ttu-id="be700-250">Les applications qui s’exécutent sur une batterie de serveurs (plusieurs serveurs) doivent s’assurer que les sessions sont permanentes lors de l’utilisation du cache en mémoire.</span><span class="sxs-lookup"><span data-stu-id="be700-250">Apps that run on a server farm (multiple servers) should ensure that sessions are sticky when using the in-memory cache.</span></span> <span data-ttu-id="be700-251">Les sessions rémanentes garantissent que les demandes ultérieures provenant d’un client sont toutes dirigées vers le même serveur.</span><span class="sxs-lookup"><span data-stu-id="be700-251">Sticky sessions ensure that later requests from a client all go to the same server.</span></span> <span data-ttu-id="be700-252">Par exemple, Azure Web Apps utilise [application Request Routing](https://www.iis.net/learn/extensions/planning-for-arr) (arr) pour acheminer toutes les demandes d’un agent utilisateur vers le même serveur.</span><span class="sxs-lookup"><span data-stu-id="be700-252">For example, Azure Web apps use [Application Request Routing](https://www.iis.net/learn/extensions/planning-for-arr) (ARR) to route all requests from a user agent to the same server.</span></span>

<span data-ttu-id="be700-253">Les sessions non rémanentes dans une batterie de serveurs Web requièrent un [cache distribué](distributed.md) pour éviter les problèmes de cohérence du cache.</span><span class="sxs-lookup"><span data-stu-id="be700-253">Non-sticky sessions in a web farm require a [distributed cache](distributed.md) to avoid cache consistency problems.</span></span> <span data-ttu-id="be700-254">Pour certaines applications, un cache distribué peut prendre en charge une montée en puissance parallèle supérieure à celle d’un cache en mémoire.</span><span class="sxs-lookup"><span data-stu-id="be700-254">For some apps, a distributed cache can support higher scale-out than an in-memory cache.</span></span> <span data-ttu-id="be700-255">L’utilisation d’un cache distribué décharge la mémoire cache dans un processus externe.</span><span class="sxs-lookup"><span data-stu-id="be700-255">Using a distributed cache offloads the cache memory to an external process.</span></span>

<span data-ttu-id="be700-256">Le cache en mémoire peut stocker n’importe quel objet.</span><span class="sxs-lookup"><span data-stu-id="be700-256">The in-memory cache can store any object.</span></span> <span data-ttu-id="be700-257">L’interface du cache distribué est limitée à `byte[]` .</span><span class="sxs-lookup"><span data-stu-id="be700-257">The distributed cache interface is limited to `byte[]`.</span></span> <span data-ttu-id="be700-258">Les éléments du cache de stockage du cache distribué et en mémoire sont des paires clé-valeur.</span><span class="sxs-lookup"><span data-stu-id="be700-258">The in-memory and distributed cache store cache items as key-value pairs.</span></span>

## <a name="systemruntimecachingmemorycache"></a><span data-ttu-id="be700-259">System. Runtime. Caching/MemoryCache</span><span class="sxs-lookup"><span data-stu-id="be700-259">System.Runtime.Caching/MemoryCache</span></span>

<span data-ttu-id="be700-260"><xref:System.Runtime.Caching>/<xref:System.Runtime.Caching.MemoryCache> ([Package NuGet](https://www.nuget.org/packages/System.Runtime.Caching/)) peut être utilisé avec :</span><span class="sxs-lookup"><span data-stu-id="be700-260"><xref:System.Runtime.Caching>/<xref:System.Runtime.Caching.MemoryCache> ([NuGet package](https://www.nuget.org/packages/System.Runtime.Caching/)) can be used with:</span></span>

* <span data-ttu-id="be700-261">.NET Standard 2,0 ou version ultérieure.</span><span class="sxs-lookup"><span data-stu-id="be700-261">.NET Standard 2.0 or later.</span></span>
* <span data-ttu-id="be700-262">Toute [implémentation .net](/dotnet/standard/net-standard#net-implementation-support) qui cible .NET standard 2,0 ou version ultérieure.</span><span class="sxs-lookup"><span data-stu-id="be700-262">Any [.NET implementation](/dotnet/standard/net-standard#net-implementation-support) that targets .NET Standard 2.0 or later.</span></span> <span data-ttu-id="be700-263">Par exemple, ASP.NET Core 2,0 ou version ultérieure.</span><span class="sxs-lookup"><span data-stu-id="be700-263">For example, ASP.NET Core 2.0 or later.</span></span>
* <span data-ttu-id="be700-264">.NET Framework 4.5 ou ultérieur.</span><span class="sxs-lookup"><span data-stu-id="be700-264">.NET Framework 4.5 or later.</span></span>

<span data-ttu-id="be700-265">[Microsoft. extensions. Caching. Memory](https://www.nuget.org/packages/Microsoft.Extensions.Caching.Memory/) / `IMemoryCache` (décrit dans cet article) est recommandé `System.Runtime.Caching` / `MemoryCache` , car il est mieux intégré à ASP.net core.</span><span class="sxs-lookup"><span data-stu-id="be700-265">[Microsoft.Extensions.Caching.Memory](https://www.nuget.org/packages/Microsoft.Extensions.Caching.Memory/)/`IMemoryCache` (described in this article) is recommended over `System.Runtime.Caching`/`MemoryCache` because it's better integrated into ASP.NET Core.</span></span> <span data-ttu-id="be700-266">Par exemple, `IMemoryCache` fonctionne en mode natif avec ASP.net Core [injection de dépendances](xref:fundamentals/dependency-injection).</span><span class="sxs-lookup"><span data-stu-id="be700-266">For example, `IMemoryCache` works natively with ASP.NET Core [dependency injection](xref:fundamentals/dependency-injection).</span></span>

<span data-ttu-id="be700-267">`System.Runtime.Caching` / `MemoryCache` À utiliser en tant que pont de compatibilité lors du Portage du code de ASP.net 4. x vers ASP.net core.</span><span class="sxs-lookup"><span data-stu-id="be700-267">Use `System.Runtime.Caching`/`MemoryCache` as a compatibility bridge when porting code from ASP.NET 4.x to ASP.NET Core.</span></span>

## <a name="cache-guidelines"></a><span data-ttu-id="be700-268">Instructions du cache</span><span class="sxs-lookup"><span data-stu-id="be700-268">Cache guidelines</span></span>

* <span data-ttu-id="be700-269">Le code doit toujours avoir une option de secours pour extraire les données et **ne pas** dépendre d’une valeur mise en cache disponible.</span><span class="sxs-lookup"><span data-stu-id="be700-269">Code should always have a fallback option to fetch data and **not** depend on a cached value being available.</span></span>
* <span data-ttu-id="be700-270">Le cache utilise une ressource rare, la mémoire.</span><span class="sxs-lookup"><span data-stu-id="be700-270">The cache uses a scarce resource, memory.</span></span> <span data-ttu-id="be700-271">Limiter la croissance du cache :</span><span class="sxs-lookup"><span data-stu-id="be700-271">Limit cache growth:</span></span>
  * <span data-ttu-id="be700-272">N’utilisez **pas** d’entrée externe comme clés de cache.</span><span class="sxs-lookup"><span data-stu-id="be700-272">Do **not** use external input as cache keys.</span></span>
  * <span data-ttu-id="be700-273">Utilisez des expirations pour limiter la croissance du cache.</span><span class="sxs-lookup"><span data-stu-id="be700-273">Use expirations to limit cache growth.</span></span>
  * <span data-ttu-id="be700-274">[Utilisez les paramètres, size et SizeLimit pour limiter la taille du cache](#use-setsize-size-and-sizelimit-to-limit-cache-size).</span><span class="sxs-lookup"><span data-stu-id="be700-274">[Use SetSize, Size, and SizeLimit to limit cache size](#use-setsize-size-and-sizelimit-to-limit-cache-size).</span></span> <span data-ttu-id="be700-275">Le runtime ASP.NET Core ne limite pas la taille du cache en fonction de la sollicitation de la mémoire.</span><span class="sxs-lookup"><span data-stu-id="be700-275">The ASP.NET Core runtime does not limit cache size based on memory pressure.</span></span> <span data-ttu-id="be700-276">C’est au développeur de limiter la taille du cache.</span><span class="sxs-lookup"><span data-stu-id="be700-276">It's up to the developer to limit cache size.</span></span>

## <a name="using-imemorycache"></a><span data-ttu-id="be700-277">Utilisation de IMemoryCache</span><span class="sxs-lookup"><span data-stu-id="be700-277">Using IMemoryCache</span></span>

> [!WARNING]
> <span data-ttu-id="be700-278">L’utilisation d’un cache mémoire *partagé* à partir d’une [injection de dépendance](xref:fundamentals/dependency-injection) et l’appel `SetSize` `Size` de, ou `SizeLimit` pour limiter la taille du cache peuvent entraîner l’échec de l’application.</span><span class="sxs-lookup"><span data-stu-id="be700-278">Using a *shared* memory cache from [Dependency Injection](xref:fundamentals/dependency-injection) and calling `SetSize`, `Size`, or `SizeLimit` to limit cache size can cause the app to fail.</span></span> <span data-ttu-id="be700-279">Quand une limite de taille est définie sur un cache, toutes les entrées doivent spécifier une taille lors de leur ajout.</span><span class="sxs-lookup"><span data-stu-id="be700-279">When a size limit is set on a cache, all entries must specify a size when being added.</span></span> <span data-ttu-id="be700-280">Cela peut entraîner des problèmes, car les développeurs n’ont peut-être pas un contrôle total sur ce qui utilise le cache partagé.</span><span class="sxs-lookup"><span data-stu-id="be700-280">This can lead to issues since developers may not have full control on what uses the shared cache.</span></span> <span data-ttu-id="be700-281">Par exemple, Entity Framework Core utilise le cache partagé et ne spécifie pas de taille.</span><span class="sxs-lookup"><span data-stu-id="be700-281">For example, Entity Framework Core uses the shared cache and does not specify a size.</span></span> <span data-ttu-id="be700-282">Si une application définit une limite de taille de cache et utilise EF Core, l’application lève une exception `InvalidOperationException` .</span><span class="sxs-lookup"><span data-stu-id="be700-282">If an app sets a cache size limit and uses EF Core, the app throws an `InvalidOperationException`.</span></span>
> <span data-ttu-id="be700-283">Lorsque `SetSize` vous utilisez, `Size` ou `SizeLimit` pour limiter le cache, créez un singleton de cache pour la mise en cache.</span><span class="sxs-lookup"><span data-stu-id="be700-283">When using `SetSize`, `Size`, or `SizeLimit` to limit cache, create a cache singleton for caching.</span></span> <span data-ttu-id="be700-284">Pour plus d’informations et pour obtenir un exemple, consultez utiliser la configuration, la [taille et SizeLimit pour limiter la taille du cache](#use-setsize-size-and-sizelimit-to-limit-cache-size).</span><span class="sxs-lookup"><span data-stu-id="be700-284">For more information and an example, see [Use SetSize, Size, and SizeLimit to limit cache size](#use-setsize-size-and-sizelimit-to-limit-cache-size).</span></span>

<span data-ttu-id="be700-285">La mise en cache en mémoire est un *service* qui est référencé à partir de votre application à l’aide de l' [injection de dépendances](../../fundamentals/dependency-injection.md).</span><span class="sxs-lookup"><span data-stu-id="be700-285">In-memory caching is a *service* that's referenced from your app using [Dependency Injection](../../fundamentals/dependency-injection.md).</span></span> <span data-ttu-id="be700-286">Appeler `AddMemoryCache` dans `ConfigureServices` :</span><span class="sxs-lookup"><span data-stu-id="be700-286">Call `AddMemoryCache` in `ConfigureServices`:</span></span>

[!code-csharp[](memory/sample/WebCache/Startup.cs?highlight=9)]

<span data-ttu-id="be700-287">Demandez l' `IMemoryCache` instance dans le constructeur :</span><span class="sxs-lookup"><span data-stu-id="be700-287">Request the `IMemoryCache` instance in the constructor:</span></span>

[!code-csharp[](memory/sample/WebCache/Controllers/HomeController.cs?name=snippet_ctor)]

<span data-ttu-id="be700-288">`IMemoryCache` requiert le package NuGet [Microsoft. extensions. Caching. Memory](https://www.nuget.org/packages/Microsoft.Extensions.Caching.Memory/), qui est disponible dans le [produit Microsoft. AspNetCore. app](xref:fundamentals/metapackage-app).</span><span class="sxs-lookup"><span data-stu-id="be700-288">`IMemoryCache` requires NuGet package [Microsoft.Extensions.Caching.Memory](https://www.nuget.org/packages/Microsoft.Extensions.Caching.Memory/), which is available in the [Microsoft.AspNetCore.App metapackage](xref:fundamentals/metapackage-app).</span></span>

<span data-ttu-id="be700-289">Le code suivant utilise [TryGetValue](/dotnet/api/microsoft.extensions.caching.memory.imemorycache.trygetvalue?view=aspnetcore-2.0#Microsoft_Extensions_Caching_Memory_IMemoryCache_TryGetValue_System_Object_System_Object__) pour vérifier si une heure se trouve dans le cache.</span><span class="sxs-lookup"><span data-stu-id="be700-289">The following code uses [TryGetValue](/dotnet/api/microsoft.extensions.caching.memory.imemorycache.trygetvalue?view=aspnetcore-2.0#Microsoft_Extensions_Caching_Memory_IMemoryCache_TryGetValue_System_Object_System_Object__) to check if a time is in the cache.</span></span> <span data-ttu-id="be700-290">Si une heure n’est pas mise en cache, une nouvelle entrée est créée et ajoutée au cache avec [Set](/dotnet/api/microsoft.extensions.caching.memory.cacheextensions.set?view=aspnetcore-2.0#Microsoft_Extensions_Caching_Memory_CacheExtensions_Set__1_Microsoft_Extensions_Caching_Memory_IMemoryCache_System_Object___0_Microsoft_Extensions_Caching_Memory_MemoryCacheEntryOptions_).</span><span class="sxs-lookup"><span data-stu-id="be700-290">If a time isn't cached, a new entry is created and added to the cache with [Set](/dotnet/api/microsoft.extensions.caching.memory.cacheextensions.set?view=aspnetcore-2.0#Microsoft_Extensions_Caching_Memory_CacheExtensions_Set__1_Microsoft_Extensions_Caching_Memory_IMemoryCache_System_Object___0_Microsoft_Extensions_Caching_Memory_MemoryCacheEntryOptions_).</span></span>

[!code-csharp[](memory/sample/WebCache/CacheKeys.cs)]

[!code-csharp[](memory/sample/WebCache/Controllers/HomeController.cs?name=snippet1)]

<span data-ttu-id="be700-291">L’heure actuelle et l’heure de mise en cache sont affichées :</span><span class="sxs-lookup"><span data-stu-id="be700-291">The current time and the cached time are displayed:</span></span>

[!code-cshtml[](memory/sample/WebCache/Views/Home/Cache.cshtml)]

<span data-ttu-id="be700-292">La valeur mise en cache `DateTime` reste dans le cache pendant qu’il y a des requêtes dans le délai imparti.</span><span class="sxs-lookup"><span data-stu-id="be700-292">The cached `DateTime` value remains in the cache while there are requests within the timeout period.</span></span> <span data-ttu-id="be700-293">L’illustration suivante montre l’heure actuelle et une ancienne heure extraite du cache :</span><span class="sxs-lookup"><span data-stu-id="be700-293">The following image shows the current time and an older time retrieved from the cache:</span></span>

![Vue d’index avec deux heures différentes affichées](memory/_static/time.png)

<span data-ttu-id="be700-295">Le code suivant utilise [GetOrCreate](/dotnet/api/microsoft.extensions.caching.memory.cacheextensions.getorcreate#Microsoft_Extensions_Caching_Memory_CacheExtensions_GetOrCreate__1_Microsoft_Extensions_Caching_Memory_IMemoryCache_System_Object_System_Func_Microsoft_Extensions_Caching_Memory_ICacheEntry___0__) et [GetOrCreateAsync](/dotnet/api/microsoft.extensions.caching.memory.cacheextensions.getorcreateasync#Microsoft_Extensions_Caching_Memory_CacheExtensions_GetOrCreateAsync__1_Microsoft_Extensions_Caching_Memory_IMemoryCache_System_Object_System_Func_Microsoft_Extensions_Caching_Memory_ICacheEntry_System_Threading_Tasks_Task___0___) pour mettre en cache des données.</span><span class="sxs-lookup"><span data-stu-id="be700-295">The following code uses [GetOrCreate](/dotnet/api/microsoft.extensions.caching.memory.cacheextensions.getorcreate#Microsoft_Extensions_Caching_Memory_CacheExtensions_GetOrCreate__1_Microsoft_Extensions_Caching_Memory_IMemoryCache_System_Object_System_Func_Microsoft_Extensions_Caching_Memory_ICacheEntry___0__) and [GetOrCreateAsync](/dotnet/api/microsoft.extensions.caching.memory.cacheextensions.getorcreateasync#Microsoft_Extensions_Caching_Memory_CacheExtensions_GetOrCreateAsync__1_Microsoft_Extensions_Caching_Memory_IMemoryCache_System_Object_System_Func_Microsoft_Extensions_Caching_Memory_ICacheEntry_System_Threading_Tasks_Task___0___) to cache data.</span></span>

[!code-csharp[](memory/sample/WebCache/Controllers/HomeController.cs?name=snippet2&highlight=3-7,14-19)]

<span data-ttu-id="be700-296">Le code [suivant appelle la commande pour récupérer le](/dotnet/api/microsoft.extensions.caching.memory.cacheextensions.get#Microsoft_Extensions_Caching_Memory_CacheExtensions_Get__1_Microsoft_Extensions_Caching_Memory_IMemoryCache_System_Object_) temps mis en cache :</span><span class="sxs-lookup"><span data-stu-id="be700-296">The following code calls [Get](/dotnet/api/microsoft.extensions.caching.memory.cacheextensions.get#Microsoft_Extensions_Caching_Memory_CacheExtensions_Get__1_Microsoft_Extensions_Caching_Memory_IMemoryCache_System_Object_) to fetch the cached time:</span></span>

[!code-csharp[](memory/sample/WebCache/Controllers/HomeController.cs?name=snippet_gct)]

<span data-ttu-id="be700-297"><xref:Microsoft.Extensions.Caching.Memory.CacheExtensions.GetOrCreate*>, <xref:Microsoft.Extensions.Caching.Memory.CacheExtensions.GetOrCreateAsync*> et sont [Get](/dotnet/api/microsoft.extensions.caching.memory.cacheextensions.get#Microsoft_Extensions_Caching_Memory_CacheExtensions_Get__1_Microsoft_Extensions_Caching_Memory_IMemoryCache_System_Object_) des méthodes d’extension qui font partie de la classe [CacheExtensions](/dotnet/api/microsoft.extensions.caching.memory.cacheextensions) qui étend la fonctionnalité de <xref:Microsoft.Extensions.Caching.Memory.IMemoryCache> .</span><span class="sxs-lookup"><span data-stu-id="be700-297"><xref:Microsoft.Extensions.Caching.Memory.CacheExtensions.GetOrCreate*> , <xref:Microsoft.Extensions.Caching.Memory.CacheExtensions.GetOrCreateAsync*>, and [Get](/dotnet/api/microsoft.extensions.caching.memory.cacheextensions.get#Microsoft_Extensions_Caching_Memory_CacheExtensions_Get__1_Microsoft_Extensions_Caching_Memory_IMemoryCache_System_Object_) are extension methods part of the [CacheExtensions](/dotnet/api/microsoft.extensions.caching.memory.cacheextensions) class that extends the capability of <xref:Microsoft.Extensions.Caching.Memory.IMemoryCache>.</span></span> <span data-ttu-id="be700-298">Pour obtenir une description des autres méthodes de cache, consultez [méthodes IMemoryCache](/dotnet/api/microsoft.extensions.caching.memory.imemorycache) et [méthodes CacheExtensions](/dotnet/api/microsoft.extensions.caching.memory.cacheextensions) .</span><span class="sxs-lookup"><span data-stu-id="be700-298">See [IMemoryCache methods](/dotnet/api/microsoft.extensions.caching.memory.imemorycache) and [CacheExtensions methods](/dotnet/api/microsoft.extensions.caching.memory.cacheextensions) for a description of other cache methods.</span></span>

## <a name="memorycacheentryoptions"></a><span data-ttu-id="be700-299">MemoryCacheEntryOptions</span><span class="sxs-lookup"><span data-stu-id="be700-299">MemoryCacheEntryOptions</span></span>

<span data-ttu-id="be700-300">L’exemple suivant :</span><span class="sxs-lookup"><span data-stu-id="be700-300">The following sample:</span></span>

* <span data-ttu-id="be700-301">Définit une heure d’expiration décalée.</span><span class="sxs-lookup"><span data-stu-id="be700-301">Sets a sliding expiration time.</span></span> <span data-ttu-id="be700-302">Les requêtes qui accèdent à cet élément mis en cache réinitialisent l’horloge d’expiration décalée.</span><span class="sxs-lookup"><span data-stu-id="be700-302">Requests that access this cached item will reset the sliding expiration clock.</span></span>
* <span data-ttu-id="be700-303">Affecte à la priorité de cache la valeur `CacheItemPriority.NeverRemove` .</span><span class="sxs-lookup"><span data-stu-id="be700-303">Sets the cache priority to `CacheItemPriority.NeverRemove`.</span></span>
* <span data-ttu-id="be700-304">Définit un [PostEvictionDelegate](/dotnet/api/microsoft.extensions.caching.memory.postevictiondelegate) qui sera appelé une fois que l’entrée est supprimée du cache.</span><span class="sxs-lookup"><span data-stu-id="be700-304">Sets a [PostEvictionDelegate](/dotnet/api/microsoft.extensions.caching.memory.postevictiondelegate) that will be called after the entry is evicted from the cache.</span></span> <span data-ttu-id="be700-305">Le rappel est exécuté sur un thread différent du code qui supprime l’élément du cache.</span><span class="sxs-lookup"><span data-stu-id="be700-305">The callback is run on a different thread from the code that removes the item from the cache.</span></span>

[!code-csharp[](memory/sample/WebCache/Controllers/HomeController.cs?name=snippet_et&highlight=14-21)]

## <a name="use-setsize-size-and-sizelimit-to-limit-cache-size"></a><span data-ttu-id="be700-306">Utiliser la valeur de Size, size et SizeLimit pour limiter la taille du cache</span><span class="sxs-lookup"><span data-stu-id="be700-306">Use SetSize, Size, and SizeLimit to limit cache size</span></span>

<span data-ttu-id="be700-307">Une `MemoryCache` instance peut éventuellement spécifier et appliquer une limite de taille.</span><span class="sxs-lookup"><span data-stu-id="be700-307">A `MemoryCache` instance may optionally specify and enforce a size limit.</span></span> <span data-ttu-id="be700-308">La limite de taille du cache n’a pas d’unité de mesure définie car le cache n’a pas de mécanisme pour mesurer la taille des entrées.</span><span class="sxs-lookup"><span data-stu-id="be700-308">The cache size limit does not have a defined unit of measure because the cache has no mechanism to measure the size of entries.</span></span> <span data-ttu-id="be700-309">Si la limite de taille du cache est définie, toutes les entrées doivent spécifier la taille.</span><span class="sxs-lookup"><span data-stu-id="be700-309">If the cache size limit is set, all entries must specify size.</span></span> <span data-ttu-id="be700-310">Le runtime ASP.NET Core ne limite pas la taille du cache en fonction de la sollicitation de la mémoire.</span><span class="sxs-lookup"><span data-stu-id="be700-310">The ASP.NET Core runtime does not limit cache size based on memory pressure.</span></span> <span data-ttu-id="be700-311">C’est au développeur de limiter la taille du cache.</span><span class="sxs-lookup"><span data-stu-id="be700-311">It's up to the developer to limit cache size.</span></span> <span data-ttu-id="be700-312">La taille spécifiée est dans les unités choisies par le développeur.</span><span class="sxs-lookup"><span data-stu-id="be700-312">The size specified is in units the developer chooses.</span></span>

<span data-ttu-id="be700-313">Par exemple :</span><span class="sxs-lookup"><span data-stu-id="be700-313">For example:</span></span>

* <span data-ttu-id="be700-314">Si l’application Web a principalement mis en cache des chaînes, chaque taille d’entrée de cache peut être la longueur de chaîne.</span><span class="sxs-lookup"><span data-stu-id="be700-314">If the web app was primarily caching strings, each cache entry size could be the string length.</span></span>
* <span data-ttu-id="be700-315">L’application peut spécifier la taille de toutes les entrées en tant que 1, et la limite de taille est le nombre d’entrées.</span><span class="sxs-lookup"><span data-stu-id="be700-315">The app could specify the size of all entries as 1, and the size limit is the count of entries.</span></span>

<span data-ttu-id="be700-316">Si <xref:Microsoft.Extensions.Caching.Memory.MemoryCacheOptions.SizeLimit> n’est pas défini, le cache croît sans limite.</span><span class="sxs-lookup"><span data-stu-id="be700-316">If <xref:Microsoft.Extensions.Caching.Memory.MemoryCacheOptions.SizeLimit> is not set, the cache grows without bound.</span></span> <span data-ttu-id="be700-317">Le runtime ASP.NET Core ne supprime pas le cache lorsque la mémoire système est insuffisante.</span><span class="sxs-lookup"><span data-stu-id="be700-317">The ASP.NET Core runtime does not trim the cache when system memory is low.</span></span> <span data-ttu-id="be700-318">Les applications sont en grande partie conçues pour :</span><span class="sxs-lookup"><span data-stu-id="be700-318">Apps much be architected to:</span></span>

* <span data-ttu-id="be700-319">Limiter la croissance du cache.</span><span class="sxs-lookup"><span data-stu-id="be700-319">Limit cache growth.</span></span>
* <span data-ttu-id="be700-320">Appelez <xref:Microsoft.Extensions.Caching.Memory.MemoryCache.Compact*> ou <xref:Microsoft.Extensions.Caching.Memory.MemoryCache.Remove*> lorsque la mémoire disponible est limitée :</span><span class="sxs-lookup"><span data-stu-id="be700-320">Call <xref:Microsoft.Extensions.Caching.Memory.MemoryCache.Compact*> or <xref:Microsoft.Extensions.Caching.Memory.MemoryCache.Remove*> when available memory is limited:</span></span>

<span data-ttu-id="be700-321">Le code suivant crée une taille fixe sans unité <xref:Microsoft.Extensions.Caching.Memory.MemoryCache> accessible par [injection de dépendances](xref:fundamentals/dependency-injection):</span><span class="sxs-lookup"><span data-stu-id="be700-321">The following code creates a unitless fixed size <xref:Microsoft.Extensions.Caching.Memory.MemoryCache> accessible by [dependency injection](xref:fundamentals/dependency-injection):</span></span>

[!code-csharp[](memory/sample/RPcache/Services/MyMemoryCache.cs?name=snippet)]

<span data-ttu-id="be700-322">`SizeLimit` n’a pas d’unités.</span><span class="sxs-lookup"><span data-stu-id="be700-322">`SizeLimit` does not have units.</span></span> <span data-ttu-id="be700-323">Les entrées mises en cache doivent spécifier la taille des unités qu’elles estiment le plus approprié si la limite de taille du cache a été définie.</span><span class="sxs-lookup"><span data-stu-id="be700-323">Cached entries must specify size in whatever units they deem most appropriate if the cache size limit has been set.</span></span> <span data-ttu-id="be700-324">Tous les utilisateurs d’une instance de cache doivent utiliser le même système d’unité.</span><span class="sxs-lookup"><span data-stu-id="be700-324">All users of a cache instance should use the same unit system.</span></span> <span data-ttu-id="be700-325">Une entrée ne sera pas mise en cache si la somme des tailles d’entrée mises en cache dépasse la valeur spécifiée par `SizeLimit` .</span><span class="sxs-lookup"><span data-stu-id="be700-325">An entry will not be cached if the sum of the cached entry sizes exceeds the value specified by `SizeLimit`.</span></span> <span data-ttu-id="be700-326">Si aucune limite de taille du cache n’est définie, la taille du cache définie sur l’entrée sera ignorée.</span><span class="sxs-lookup"><span data-stu-id="be700-326">If no cache size limit is set, the cache size set on the entry will be ignored.</span></span>

<span data-ttu-id="be700-327">Le code suivant s’inscrit `MyMemoryCache` auprès du conteneur d' [injection de dépendances](xref:fundamentals/dependency-injection) .</span><span class="sxs-lookup"><span data-stu-id="be700-327">The following code registers `MyMemoryCache` with the [dependency injection](xref:fundamentals/dependency-injection) container.</span></span>

[!code-csharp[](memory/sample/RPcache/Startup.cs?name=snippet&highlight=5)]

<span data-ttu-id="be700-328">`MyMemoryCache` est créé en tant que cache mémoire indépendant pour les composants qui connaissent ce cache de taille limitée et savent comment définir la taille d’entrée du cache de manière appropriée.</span><span class="sxs-lookup"><span data-stu-id="be700-328">`MyMemoryCache` is created as an independent memory cache for components that are aware of this size limited cache and know how to set cache entry size appropriately.</span></span>

<span data-ttu-id="be700-329">Le code suivant utilise `MyMemoryCache` :</span><span class="sxs-lookup"><span data-stu-id="be700-329">The following code uses `MyMemoryCache`:</span></span>

[!code-csharp[](memory/sample/RPcache/Pages/About.cshtml.cs?name=snippet)]

<span data-ttu-id="be700-330">La taille de l’entrée de cache peut être définie par [taille](/dotnet/api/microsoft.extensions.caching.memory.memorycacheentryoptions.size?view=aspnetcore-2.1#Microsoft_Extensions_Caching_Memory_MemoryCacheEntryOptions_Size) ou par la méthode d’extension de [définition](/dotnet/api/microsoft.extensions.caching.memory.memorycacheentryextensions.setsize?view=aspnetcore-2.0#Microsoft_Extensions_Caching_Memory_MemoryCacheEntryExtensions_SetSize_Microsoft_Extensions_Caching_Memory_MemoryCacheEntryOptions_System_Int64_) :</span><span class="sxs-lookup"><span data-stu-id="be700-330">The size of the cache entry can be set by [Size](/dotnet/api/microsoft.extensions.caching.memory.memorycacheentryoptions.size?view=aspnetcore-2.1#Microsoft_Extensions_Caching_Memory_MemoryCacheEntryOptions_Size) or the [SetSize](/dotnet/api/microsoft.extensions.caching.memory.memorycacheentryextensions.setsize?view=aspnetcore-2.0#Microsoft_Extensions_Caching_Memory_MemoryCacheEntryExtensions_SetSize_Microsoft_Extensions_Caching_Memory_MemoryCacheEntryOptions_System_Int64_) extension method:</span></span>

[!code-csharp[](memory/sample/RPcache/Pages/About.cshtml.cs?name=snippet2&highlight=9,10,14,15)]

### <a name="memorycachecompact"></a><span data-ttu-id="be700-331">MemoryCache. compact</span><span class="sxs-lookup"><span data-stu-id="be700-331">MemoryCache.Compact</span></span>

<span data-ttu-id="be700-332">`MemoryCache.Compact` tente de supprimer le pourcentage spécifié du cache dans l’ordre suivant :</span><span class="sxs-lookup"><span data-stu-id="be700-332">`MemoryCache.Compact` attempts to remove the specified percentage of the cache in the following order:</span></span>

* <span data-ttu-id="be700-333">Tous les éléments arrivés à expiration.</span><span class="sxs-lookup"><span data-stu-id="be700-333">All expired items.</span></span>
* <span data-ttu-id="be700-334">Éléments par priorité.</span><span class="sxs-lookup"><span data-stu-id="be700-334">Items by priority.</span></span> <span data-ttu-id="be700-335">Les éléments de priorité la plus basse sont supprimés en premier.</span><span class="sxs-lookup"><span data-stu-id="be700-335">Lowest priority items are removed first.</span></span>
* <span data-ttu-id="be700-336">Objets utilisés le moins récemment.</span><span class="sxs-lookup"><span data-stu-id="be700-336">Least recently used objects.</span></span>
* <span data-ttu-id="be700-337">Éléments avec l’expiration absolue la plus ancienne.</span><span class="sxs-lookup"><span data-stu-id="be700-337">Items with the earliest absolute expiration.</span></span>
* <span data-ttu-id="be700-338">Éléments avec l’expiration décalée la plus ancienne.</span><span class="sxs-lookup"><span data-stu-id="be700-338">Items with the earliest sliding expiration.</span></span>

<span data-ttu-id="be700-339">Les éléments épinglés avec priorité <xref:Microsoft.Extensions.Caching.Memory.CacheItemPriority.NeverRemove> ne sont jamais supprimés.</span><span class="sxs-lookup"><span data-stu-id="be700-339">Pinned items with priority <xref:Microsoft.Extensions.Caching.Memory.CacheItemPriority.NeverRemove> are never removed.</span></span>

[!code-csharp[](memory/3.0sample/RPcache/Pages/TestCache.cshtml.cs?name=snippet3)]

<span data-ttu-id="be700-340">Pour plus d’informations, consultez [source compact sur GitHub](https://github.com/dotnet/extensions/blob/v3.0.0-preview8.19405.4/src/Caching/Memory/src/MemoryCache.cs#L382-L393) .</span><span class="sxs-lookup"><span data-stu-id="be700-340">See [Compact source on GitHub](https://github.com/dotnet/extensions/blob/v3.0.0-preview8.19405.4/src/Caching/Memory/src/MemoryCache.cs#L382-L393) for more information.</span></span>

## <a name="cache-dependencies"></a><span data-ttu-id="be700-341">Dépendances de cache</span><span class="sxs-lookup"><span data-stu-id="be700-341">Cache dependencies</span></span>

<span data-ttu-id="be700-342">L’exemple suivant montre comment faire expirer une entrée de cache en cas d’expiration d’une entrée dépendante.</span><span class="sxs-lookup"><span data-stu-id="be700-342">The following sample shows how to expire a cache entry if a dependent entry expires.</span></span> <span data-ttu-id="be700-343">Un <xref:Microsoft.Extensions.Primitives.CancellationChangeToken> est ajouté à l’élément mis en cache.</span><span class="sxs-lookup"><span data-stu-id="be700-343">A <xref:Microsoft.Extensions.Primitives.CancellationChangeToken> is added to the cached item.</span></span> <span data-ttu-id="be700-344">Lorsque `Cancel` est appelé sur `CancellationTokenSource` , les deux entrées du cache sont supprimées.</span><span class="sxs-lookup"><span data-stu-id="be700-344">When `Cancel` is called on the `CancellationTokenSource`, both cache entries are evicted.</span></span>

[!code-csharp[](memory/sample/WebCache/Controllers/HomeController.cs?name=snippet_ed)]

<span data-ttu-id="be700-345">L’utilisation de `CancellationTokenSource` permet de supprimer plusieurs entrées de cache en tant que groupe.</span><span class="sxs-lookup"><span data-stu-id="be700-345">Using a `CancellationTokenSource` allows multiple cache entries to be evicted as a group.</span></span> <span data-ttu-id="be700-346">Avec le `using` modèle dans le code ci-dessus, les entrées de cache créées à l’intérieur du `using` bloc héritent des déclencheurs et des paramètres d’expiration.</span><span class="sxs-lookup"><span data-stu-id="be700-346">With the `using` pattern in the code above, cache entries created inside the `using` block will inherit triggers and expiration settings.</span></span>

## <a name="additional-notes"></a><span data-ttu-id="be700-347">Remarques supplémentaires</span><span class="sxs-lookup"><span data-stu-id="be700-347">Additional notes</span></span>

* <span data-ttu-id="be700-348">Lors de l’utilisation d’un rappel pour remplir à nouveau un élément de cache :</span><span class="sxs-lookup"><span data-stu-id="be700-348">When using a callback to repopulate a cache item:</span></span>

  * <span data-ttu-id="be700-349">Plusieurs demandes peuvent trouver la valeur de clé mise en cache vide, car le rappel n’est pas terminé.</span><span class="sxs-lookup"><span data-stu-id="be700-349">Multiple requests can find the cached key value empty because the callback hasn't completed.</span></span>
  * <span data-ttu-id="be700-350">Cela peut entraîner le remplissage de plusieurs threads de l’élément mis en cache.</span><span class="sxs-lookup"><span data-stu-id="be700-350">This can result in several threads repopulating the cached item.</span></span>

* <span data-ttu-id="be700-351">Lorsqu’une entrée de cache est utilisée pour en créer une autre, l’enfant copie les jetons d’expiration de l’entrée parente et les paramètres d’expiration basés sur la durée.</span><span class="sxs-lookup"><span data-stu-id="be700-351">When one cache entry is used to create another, the child copies the parent entry's expiration tokens and time-based expiration settings.</span></span> <span data-ttu-id="be700-352">L’enfant n’a pas expiré par la suppression ou la mise à jour manuelle de l’entrée parente.</span><span class="sxs-lookup"><span data-stu-id="be700-352">The child isn't expired by manual removal or updating of the parent entry.</span></span>

* <span data-ttu-id="be700-353">Utilisez [PostEvictionCallbacks](/dotnet/api/microsoft.extensions.caching.memory.icacheentry.postevictioncallbacks#Microsoft_Extensions_Caching_Memory_ICacheEntry_PostEvictionCallbacks) pour définir les rappels qui seront déclenchés après que l’entrée du cache a été supprimée du cache.</span><span class="sxs-lookup"><span data-stu-id="be700-353">Use [PostEvictionCallbacks](/dotnet/api/microsoft.extensions.caching.memory.icacheentry.postevictioncallbacks#Microsoft_Extensions_Caching_Memory_ICacheEntry_PostEvictionCallbacks) to set the callbacks that will be fired after the cache entry is evicted from the cache.</span></span>

## <a name="background-cache-update"></a><span data-ttu-id="be700-354">Mise à jour du cache en arrière-plan</span><span class="sxs-lookup"><span data-stu-id="be700-354">Background cache update</span></span>

<span data-ttu-id="be700-355">Utilisez un [service d’arrière-plan](xref:fundamentals/host/hosted-services) tel que <xref:Microsoft.Extensions.Hosting.IHostedService> pour mettre à jour le cache.</span><span class="sxs-lookup"><span data-stu-id="be700-355">Use a [background service](xref:fundamentals/host/hosted-services) such as <xref:Microsoft.Extensions.Hosting.IHostedService> to update the cache.</span></span> <span data-ttu-id="be700-356">Le service d’arrière-plan peut recalculer les entrées, puis les assigner au cache uniquement lorsqu’elles sont prêtes.</span><span class="sxs-lookup"><span data-stu-id="be700-356">The background service can recompute the entries and then assign them to the cache only when they’re ready.</span></span>

## <a name="additional-resources"></a><span data-ttu-id="be700-357">Ressources supplémentaires</span><span class="sxs-lookup"><span data-stu-id="be700-357">Additional resources</span></span>

* <xref:performance/caching/distributed>
* <xref:fundamentals/change-tokens>
* <xref:performance/caching/response>
* <xref:performance/caching/middleware>
* <xref:mvc/views/tag-helpers/builtin-th/cache-tag-helper>
* <xref:mvc/views/tag-helpers/builtin-th/distributed-cache-tag-helper>

::: moniker-end
