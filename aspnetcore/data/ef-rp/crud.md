---
title: Partie 2, Razor pages avec EF Core dans ASP.net Core-CRUD
author: rick-anderson
description: Partie 2 de Razor pages et Entity Framework série de didacticiels.
ms.author: riande
ms.date: 07/22/2019
no-loc:
- appsettings.json
- ASP.NET Core Identity
- cookie
- Cookie
- Blazor
- Blazor Server
- Blazor WebAssembly
- Identity
- Let's Encrypt
- Razor
- SignalR
uid: data/ef-rp/crud
ms.openlocfilehash: 4a48fb094888d51aa6f881c82e4f20ffbc84c8e2
ms.sourcegitcommit: 3593c4efa707edeaaceffbfa544f99f41fc62535
ms.translationtype: MT
ms.contentlocale: fr-FR
ms.lasthandoff: 01/04/2021
ms.locfileid: "96901169"
---
# <a name="part-2-no-locrazor-pages-with-ef-core-in-aspnet-core---crud"></a><span data-ttu-id="ae96e-103">Partie 2, Razor pages avec EF Core dans ASP.net Core-CRUD</span><span class="sxs-lookup"><span data-stu-id="ae96e-103">Part 2, Razor Pages with EF Core in ASP.NET Core - CRUD</span></span>

<span data-ttu-id="ae96e-104">Par [Tom Dykstra](https://github.com/tdykstra), [Jon P Smith](https://twitter.com/thereformedprog) et [Rick Anderson](https://twitter.com/RickAndMSFT)</span><span class="sxs-lookup"><span data-stu-id="ae96e-104">By [Tom Dykstra](https://github.com/tdykstra), [Jon P Smith](https://twitter.com/thereformedprog), and [Rick Anderson](https://twitter.com/RickAndMSFT)</span></span>

[!INCLUDE [about the series](~/includes/RP-EF/intro.md)]

::: moniker range=">= aspnetcore-5.0"

<span data-ttu-id="ae96e-105">Dans ce didacticiel, nous allons examiner et personnaliser le code CRUD (créer, lire, mettre à jour, supprimer) généré automatiquement.</span><span class="sxs-lookup"><span data-stu-id="ae96e-105">In this tutorial, the scaffolded CRUD (create, read, update, delete) code is reviewed and customized.</span></span>

## <a name="no-repository"></a><span data-ttu-id="ae96e-106">Aucun référentiel</span><span class="sxs-lookup"><span data-stu-id="ae96e-106">No repository</span></span>

<span data-ttu-id="ae96e-107">Certains développeurs utilisent une couche de service ou un modèle de référentiel pour créer une couche d’abstraction entre l’interface utilisateur ( Razor pages) et la couche d’accès aux données.</span><span class="sxs-lookup"><span data-stu-id="ae96e-107">Some developers use a service layer or repository pattern to create an abstraction layer between the UI (Razor Pages) and the data access layer.</span></span> <span data-ttu-id="ae96e-108">Ce n’est pas le cas de ce tutoriel.</span><span class="sxs-lookup"><span data-stu-id="ae96e-108">This tutorial doesn't do that.</span></span> <span data-ttu-id="ae96e-109">Pour que ce tutoriel soit moins complexe et traite exclusivement d’EF Core, le code EF Core est directement ajouté aux classes de modèle de page.</span><span class="sxs-lookup"><span data-stu-id="ae96e-109">To minimize complexity and keep the tutorial focused on EF Core, EF Core code is added directly to the page model classes.</span></span> 

## <a name="update-the-details-page"></a><span data-ttu-id="ae96e-110">Mettre à jour la page Details</span><span class="sxs-lookup"><span data-stu-id="ae96e-110">Update the Details page</span></span>

<span data-ttu-id="ae96e-111">Le code généré automatiquement pour les pages Students n’inclut pas les données d’inscription (« enrollment »).</span><span class="sxs-lookup"><span data-stu-id="ae96e-111">The scaffolded code for the Students pages doesn't include enrollment data.</span></span> <span data-ttu-id="ae96e-112">Dans cette section, vous allez ajouter des inscriptions à la page Details.</span><span class="sxs-lookup"><span data-stu-id="ae96e-112">In this section, you add enrollments to the Details page.</span></span>

### <a name="read-enrollments"></a><span data-ttu-id="ae96e-113">Lire les inscriptions</span><span class="sxs-lookup"><span data-stu-id="ae96e-113">Read enrollments</span></span>

<span data-ttu-id="ae96e-114">Pour afficher les données d’inscription d’un étudiant dans la page, vous devez les lire.</span><span class="sxs-lookup"><span data-stu-id="ae96e-114">To display a student's enrollment data on the page, you need to read it.</span></span> <span data-ttu-id="ae96e-115">Le code généré automatiquement dans *Pages/Students/Details.cshtml.cs* lit uniquement les données d’étudiant, sans les données d’inscription :</span><span class="sxs-lookup"><span data-stu-id="ae96e-115">The scaffolded code in *Pages/Students/Details.cshtml.cs* reads only the Student data, without the Enrollment data:</span></span>

[!code-csharp[Main](intro/samples/cu30snapshots/2-crud/Pages/Students/Details1.cshtml.cs?name=snippet_OnGetAsync&highlight=8)]

<span data-ttu-id="ae96e-116">Remplacez la méthode `OnGetAsync` par le code suivant pour lire les données d’inscription de l’étudiant sélectionné.</span><span class="sxs-lookup"><span data-stu-id="ae96e-116">Replace the `OnGetAsync` method with the following code to read enrollment data for the selected student.</span></span> <span data-ttu-id="ae96e-117">Les modifications sont mises en surbrillance.</span><span class="sxs-lookup"><span data-stu-id="ae96e-117">The changes are highlighted.</span></span>

[!code-csharp[Main](intro/samples/cu30/Pages/Students/Details.cshtml.cs?name=snippet_OnGetAsync&highlight=8-12)]

<span data-ttu-id="ae96e-118">Les méthodes [Include](/dotnet/api/microsoft.entityframeworkcore.entityframeworkqueryableextensions.include) et [ThenInclude](/dotnet/api/microsoft.entityframeworkcore.entityframeworkqueryableextensions.theninclude#Microsoft_EntityFrameworkCore_EntityFrameworkQueryableExtensions_ThenInclude__3_Microsoft_EntityFrameworkCore_Query_IIncludableQueryable___0_System_Collections_Generic_IEnumerable___1___System_Linq_Expressions_Expression_System_Func___1___2___) forcent le contexte à charger la propriété de navigation `Student.Enrollments` et, dans chaque inscription, la propriété de navigation `Enrollment.Course`.</span><span class="sxs-lookup"><span data-stu-id="ae96e-118">The [Include](/dotnet/api/microsoft.entityframeworkcore.entityframeworkqueryableextensions.include) and [ThenInclude](/dotnet/api/microsoft.entityframeworkcore.entityframeworkqueryableextensions.theninclude#Microsoft_EntityFrameworkCore_EntityFrameworkQueryableExtensions_ThenInclude__3_Microsoft_EntityFrameworkCore_Query_IIncludableQueryable___0_System_Collections_Generic_IEnumerable___1___System_Linq_Expressions_Expression_System_Func___1___2___) methods cause the context to load the `Student.Enrollments` navigation property, and within each enrollment the `Enrollment.Course` navigation property.</span></span> <span data-ttu-id="ae96e-119">Ces méthodes sont examinées en détail dans le didacticiel [lire les données associées](xref:data/ef-rp/read-related-data) .</span><span class="sxs-lookup"><span data-stu-id="ae96e-119">These methods are examined in detail in the [Read related data](xref:data/ef-rp/read-related-data) tutorial.</span></span>

<span data-ttu-id="ae96e-120">La méthode [AsNoTracking](/dotnet/api/microsoft.entityframeworkcore.entityframeworkqueryableextensions.asnotracking#Microsoft_EntityFrameworkCore_EntityFrameworkQueryableExtensions_AsNoTracking__1_System_Linq_IQueryable___0__) améliore les performances dans les scénarios où les entités retournées ne sont pas mises à jour dans le contexte actuel.</span><span class="sxs-lookup"><span data-stu-id="ae96e-120">The [AsNoTracking](/dotnet/api/microsoft.entityframeworkcore.entityframeworkqueryableextensions.asnotracking#Microsoft_EntityFrameworkCore_EntityFrameworkQueryableExtensions_AsNoTracking__1_System_Linq_IQueryable___0__) method improves performance in scenarios where the entities returned are not updated in the current context.</span></span> <span data-ttu-id="ae96e-121">Le sujet `AsNoTracking` est abordé plus loin dans ce didacticiel.</span><span class="sxs-lookup"><span data-stu-id="ae96e-121">`AsNoTracking` is discussed later in this tutorial.</span></span>

### <a name="display-enrollments"></a><span data-ttu-id="ae96e-122">Afficher les inscriptions</span><span class="sxs-lookup"><span data-stu-id="ae96e-122">Display enrollments</span></span>

<span data-ttu-id="ae96e-123">Remplacez le code dans *Pages/Students/Details.cshtml* par le code suivant pour afficher une liste d’inscriptions.</span><span class="sxs-lookup"><span data-stu-id="ae96e-123">Replace the code in *Pages/Students/Details.cshtml* with the following code to display a list of enrollments.</span></span> <span data-ttu-id="ae96e-124">Les modifications sont mises en surbrillance.</span><span class="sxs-lookup"><span data-stu-id="ae96e-124">The changes are highlighted.</span></span>

[!code-cshtml[Main](intro/samples/cu30/Pages/Students/Details.cshtml?highlight=32-53)]

<span data-ttu-id="ae96e-125">Le code précédent effectue une itération sur les entités dans la propriété de navigation `Enrollments`.</span><span class="sxs-lookup"><span data-stu-id="ae96e-125">The preceding code loops through the entities in the `Enrollments` navigation property.</span></span> <span data-ttu-id="ae96e-126">Pour chaque inscription, il affiche le titre du cours et le niveau.</span><span class="sxs-lookup"><span data-stu-id="ae96e-126">For each enrollment, it displays the course title and the grade.</span></span> <span data-ttu-id="ae96e-127">Le titre du cours est récupéré à partir de l’entité de cours qui est stockée dans la propriété de navigation `Course` de l’entité Enrollments.</span><span class="sxs-lookup"><span data-stu-id="ae96e-127">The course title is retrieved from the Course entity that's stored in the `Course` navigation property of the Enrollments entity.</span></span>

<span data-ttu-id="ae96e-128">Exécutez l’application, sélectionnez l’onglet **Students**, puis cliquez sur le lien **Details** pour un étudiant.</span><span class="sxs-lookup"><span data-stu-id="ae96e-128">Run the app, select the **Students** tab, and click the **Details** link for a student.</span></span> <span data-ttu-id="ae96e-129">La liste des cours et les notes de l’étudiant sélectionné s’affiche.</span><span class="sxs-lookup"><span data-stu-id="ae96e-129">The list of courses and grades for the selected student is displayed.</span></span>

### <a name="ways-to-read-one-entity"></a><span data-ttu-id="ae96e-130">Méthodes pour lire une entité</span><span class="sxs-lookup"><span data-stu-id="ae96e-130">Ways to read one entity</span></span>

<span data-ttu-id="ae96e-131">Le code généré utilise [FirstOrDefaultAsync](/dotnet/api/microsoft.entityframeworkcore.entityframeworkqueryableextensions.firstordefaultasync#Microsoft_EntityFrameworkCore_EntityFrameworkQueryableExtensions_FirstOrDefaultAsync__1_System_Linq_IQueryable___0__System_Threading_CancellationToken_) pour lire une entité.</span><span class="sxs-lookup"><span data-stu-id="ae96e-131">The generated code uses [FirstOrDefaultAsync](/dotnet/api/microsoft.entityframeworkcore.entityframeworkqueryableextensions.firstordefaultasync#Microsoft_EntityFrameworkCore_EntityFrameworkQueryableExtensions_FirstOrDefaultAsync__1_System_Linq_IQueryable___0__System_Threading_CancellationToken_) to read one entity.</span></span> <span data-ttu-id="ae96e-132">Cette méthode retourne la valeur Null si rien n’est trouvé ; sinon, elle retourne la première ligne trouvée qui répond aux critères de filtre de requête.</span><span class="sxs-lookup"><span data-stu-id="ae96e-132">This method returns null if nothing is found; otherwise, it returns the first row found that satisfies the query filter criteria.</span></span> <span data-ttu-id="ae96e-133">`FirstOrDefaultAsync` est généralement un meilleur choix que les autres solutions suivantes :</span><span class="sxs-lookup"><span data-stu-id="ae96e-133">`FirstOrDefaultAsync` is generally a better choice than the following alternatives:</span></span>

* <span data-ttu-id="ae96e-134">[SingleOrDefaultAsync](/dotnet/api/microsoft.entityframeworkcore.entityframeworkqueryableextensions.singleordefaultasync#Microsoft_EntityFrameworkCore_EntityFrameworkQueryableExtensions_SingleOrDefaultAsync__1_System_Linq_IQueryable___0__System_Linq_Expressions_Expression_System_Func___0_System_Boolean___System_Threading_CancellationToken_) – Lève une exception si plusieurs entités répondent au filtre de requête.</span><span class="sxs-lookup"><span data-stu-id="ae96e-134">[SingleOrDefaultAsync](/dotnet/api/microsoft.entityframeworkcore.entityframeworkqueryableextensions.singleordefaultasync#Microsoft_EntityFrameworkCore_EntityFrameworkQueryableExtensions_SingleOrDefaultAsync__1_System_Linq_IQueryable___0__System_Linq_Expressions_Expression_System_Func___0_System_Boolean___System_Threading_CancellationToken_) - Throws an exception if there's more than one entity that satisfies the query filter.</span></span> <span data-ttu-id="ae96e-135">Pour déterminer si plusieurs lignes peuvent être retournées par la requête, `SingleOrDefaultAsync` tente de récupérer plusieurs lignes.</span><span class="sxs-lookup"><span data-stu-id="ae96e-135">To determine if more than one row could be returned by the query, `SingleOrDefaultAsync` tries to fetch multiple rows.</span></span> <span data-ttu-id="ae96e-136">Ce travail supplémentaire est inutile si la requête ne peut retourner qu’une seule entité, comme quand elle effectue une recherche sur une clé unique.</span><span class="sxs-lookup"><span data-stu-id="ae96e-136">This extra work is unnecessary if the query can only return one entity, as when it searches on a unique key.</span></span>
* <span data-ttu-id="ae96e-137">[FindAsync](/dotnet/api/microsoft.entityframeworkcore.dbcontext.findasync#Microsoft_EntityFrameworkCore_DbContext_FindAsync_System_Type_System_Object___) – Recherche une entité avec la clé primaire.</span><span class="sxs-lookup"><span data-stu-id="ae96e-137">[FindAsync](/dotnet/api/microsoft.entityframeworkcore.dbcontext.findasync#Microsoft_EntityFrameworkCore_DbContext_FindAsync_System_Type_System_Object___) - Finds an entity with the primary key (PK).</span></span> <span data-ttu-id="ae96e-138">Si une entité avec la clé primaire est suivie par le contexte, elle est retournée sans qu’aucune requête soit envoyée à la base de données.</span><span class="sxs-lookup"><span data-stu-id="ae96e-138">If an entity with the PK is being tracked by the context, it's returned without a request to the database.</span></span> <span data-ttu-id="ae96e-139">Cette méthode est optimisée pour la recherche d’une seule entité, mais vous ne pouvez pas appeler `Include` avec `FindAsync`.</span><span class="sxs-lookup"><span data-stu-id="ae96e-139">This method is optimized to look up a single entity, but you can't call `Include` with `FindAsync`.</span></span>  <span data-ttu-id="ae96e-140">Par conséquent, si des données associées sont nécessaires, `FirstOrDefaultAsync` est le meilleur choix.</span><span class="sxs-lookup"><span data-stu-id="ae96e-140">So if related data is needed, `FirstOrDefaultAsync` is the better choice.</span></span>

### <a name="route-data-vs-query-string"></a><span data-ttu-id="ae96e-141">Données de route/chaîne de requête</span><span class="sxs-lookup"><span data-stu-id="ae96e-141">Route data vs. query string</span></span>

<span data-ttu-id="ae96e-142">L’URL de la page Details est `https://localhost:<port>/Students/Details?id=1`.</span><span class="sxs-lookup"><span data-stu-id="ae96e-142">The URL for the Details page is `https://localhost:<port>/Students/Details?id=1`.</span></span> <span data-ttu-id="ae96e-143">La valeur de clé primaire de l’entité se trouve dans la chaîne de requête.</span><span class="sxs-lookup"><span data-stu-id="ae96e-143">The entity's primary key value is in the query string.</span></span> <span data-ttu-id="ae96e-144">Certains développeurs préfèrent passer la valeur de clé dans des données de route : `https://localhost:<port>/Students/Details/1`.</span><span class="sxs-lookup"><span data-stu-id="ae96e-144">Some developers prefer to pass the key value in route data: `https://localhost:<port>/Students/Details/1`.</span></span> <span data-ttu-id="ae96e-145">Pour plus d'informations, consultez [Mettre à jour le code généré](xref:tutorials/razor-pages/da1#update-the-generated-code).</span><span class="sxs-lookup"><span data-stu-id="ae96e-145">For more information, see [Update the generated code](xref:tutorials/razor-pages/da1#update-the-generated-code).</span></span>

## <a name="update-the-create-page"></a><span data-ttu-id="ae96e-146">Mettre à jour la page Create</span><span class="sxs-lookup"><span data-stu-id="ae96e-146">Update the Create page</span></span>

<span data-ttu-id="ae96e-147">Le code `OnPostAsync` généré automatiquement pour la page Create est vulnérable aux [sur-publications](#overposting).</span><span class="sxs-lookup"><span data-stu-id="ae96e-147">The scaffolded `OnPostAsync` code for the Create page is vulnerable to [overposting](#overposting).</span></span> <span data-ttu-id="ae96e-148">Remplacez la méthode `OnPostAsync` dans *Pages/Students/Create.cshtml.cs* par le code suivant.</span><span class="sxs-lookup"><span data-stu-id="ae96e-148">Replace the `OnPostAsync` method in *Pages/Students/Create.cshtml.cs* with the following code.</span></span>

[!code-csharp[Main](intro/samples/cu30/Pages/Students/Create.cshtml.cs?name=snippet_OnPostAsync)]

<a name="TryUpdateModelAsync"></a>

### <a name="tryupdatemodelasync"></a><span data-ttu-id="ae96e-149">TryUpdateModelAsync</span><span class="sxs-lookup"><span data-stu-id="ae96e-149">TryUpdateModelAsync</span></span>

<span data-ttu-id="ae96e-150">Le code précédent crée un objet Student, puis utilise des champs de formulaire publiés pour mettre à jour les propriétés de l’objet Student.</span><span class="sxs-lookup"><span data-stu-id="ae96e-150">The preceding code creates a Student object and then uses posted form fields to update the Student object's properties.</span></span> <span data-ttu-id="ae96e-151">La méthode [TryUpdateModelAsync](/dotnet/api/microsoft.aspnetcore.mvc.controllerbase.tryupdatemodelasync#Microsoft_AspNetCore_Mvc_ControllerBase_TryUpdateModelAsync_System_Object_System_Type_System_String_) :</span><span class="sxs-lookup"><span data-stu-id="ae96e-151">The [TryUpdateModelAsync](/dotnet/api/microsoft.aspnetcore.mvc.controllerbase.tryupdatemodelasync#Microsoft_AspNetCore_Mvc_ControllerBase_TryUpdateModelAsync_System_Object_System_Type_System_String_) method:</span></span>

* <span data-ttu-id="ae96e-152">Utilise les valeurs de formulaire publiées de la propriété [PageContext](/dotnet/api/microsoft.aspnetcore.mvc.razorpages.pagemodel.pagecontext#Microsoft_AspNetCore_Mvc_RazorPages_PageModel_PageContext) de [PageModel](/dotnet/api/microsoft.aspnetcore.mvc.razorpages.pagemodel).</span><span class="sxs-lookup"><span data-stu-id="ae96e-152">Uses the posted form values from the [PageContext](/dotnet/api/microsoft.aspnetcore.mvc.razorpages.pagemodel.pagecontext#Microsoft_AspNetCore_Mvc_RazorPages_PageModel_PageContext) property in the [PageModel](/dotnet/api/microsoft.aspnetcore.mvc.razorpages.pagemodel).</span></span>
* <span data-ttu-id="ae96e-153">Met à jour uniquement les propriétés listées (`s => s.FirstMidName, s => s.LastName, s => s.EnrollmentDate`).</span><span class="sxs-lookup"><span data-stu-id="ae96e-153">Updates only the properties listed (`s => s.FirstMidName, s => s.LastName, s => s.EnrollmentDate`).</span></span>
* <span data-ttu-id="ae96e-154">Recherche les champs de formulaire dotés d’un préfixe « Student ».</span><span class="sxs-lookup"><span data-stu-id="ae96e-154">Looks for form fields with a "student" prefix.</span></span> <span data-ttu-id="ae96e-155">Par exemple : `Student.FirstMidName`.</span><span class="sxs-lookup"><span data-stu-id="ae96e-155">For example, `Student.FirstMidName`.</span></span> <span data-ttu-id="ae96e-156">Il ne respecte pas la casse.</span><span class="sxs-lookup"><span data-stu-id="ae96e-156">It's not case sensitive.</span></span>
* <span data-ttu-id="ae96e-157">Utilise le système de [liaison de modèles](xref:mvc/models/model-binding) pour convertir les valeurs de formulaire de chaînes en types dans le modèle `Student`.</span><span class="sxs-lookup"><span data-stu-id="ae96e-157">Uses the [model binding](xref:mvc/models/model-binding) system to convert form values from strings to the types in the `Student` model.</span></span> <span data-ttu-id="ae96e-158">Par exemple, `EnrollmentDate` est converti en `DateTime` .</span><span class="sxs-lookup"><span data-stu-id="ae96e-158">For example, `EnrollmentDate` is converted to `DateTime`.</span></span>

<span data-ttu-id="ae96e-159">Exécutez l’application, puis créez une entité Student pour tester la page Create.</span><span class="sxs-lookup"><span data-stu-id="ae96e-159">Run the app, and create a student entity to test the Create page.</span></span>

## <a name="overposting"></a><span data-ttu-id="ae96e-160">Sur-publication</span><span class="sxs-lookup"><span data-stu-id="ae96e-160">Overposting</span></span>

<span data-ttu-id="ae96e-161">L’utilisation de `TryUpdateModel` pour mettre à jour des champs avec des valeurs publiées est une bonne pratique de sécurité, car cela empêche la sur-publication.</span><span class="sxs-lookup"><span data-stu-id="ae96e-161">Using `TryUpdateModel` to update fields with posted values is a security best practice because it prevents overposting.</span></span> <span data-ttu-id="ae96e-162">Par exemple, supposez que l’entité Student comprend une propriété `Secret` que cette page web ne doit pas mettre à jour ou ajouter :</span><span class="sxs-lookup"><span data-stu-id="ae96e-162">For example, suppose the Student entity includes a `Secret` property that this web page shouldn't update or add:</span></span>

[!code-csharp[Main](intro/samples/cu30snapshots/2-crud/Models/StudentZsecret.cs?name=snippet_Intro&highlight=7)]

<span data-ttu-id="ae96e-163">Même si l’application n’a pas de `Secret` champ dans la page de création ou de mise à jour Razor , un pirate peut définir la `Secret` valeur par survalidation.</span><span class="sxs-lookup"><span data-stu-id="ae96e-163">Even if the app doesn't have a `Secret` field on the create or update Razor Page, a hacker could set the `Secret` value by overposting.</span></span> <span data-ttu-id="ae96e-164">Un pirate pourrait utiliser un outil tel que Fiddler, ou écrire du JavaScript, pour publier une valeur de formulaire `Secret`.</span><span class="sxs-lookup"><span data-stu-id="ae96e-164">A hacker could use a tool such as Fiddler, or write some JavaScript, to post a `Secret` form value.</span></span> <span data-ttu-id="ae96e-165">Le code d’origine ne limite pas les champs que le classeur de modèles utilise quand il crée une instance de Student.</span><span class="sxs-lookup"><span data-stu-id="ae96e-165">The original code doesn't limit the fields that the model binder uses when it creates a Student instance.</span></span>

<span data-ttu-id="ae96e-166">La valeur spécifiée par le pirate pour le champ de formulaire `Secret`, quelle qu’elle soit, est mise à jour dans la base de données.</span><span class="sxs-lookup"><span data-stu-id="ae96e-166">Whatever value the hacker specified for the `Secret` form field is updated in the database.</span></span> <span data-ttu-id="ae96e-167">L’illustration suivante montre l’outil Fiddler ajoutant le `Secret` champ, avec la valeur « surpost », aux valeurs de formulaire publiées.</span><span class="sxs-lookup"><span data-stu-id="ae96e-167">The following image shows the Fiddler tool adding the `Secret` field, with the value "OverPost", to the posted form values.</span></span>

![Fiddler ajoutant un champ Secret](../ef-mvc/crud/_static/fiddler.png)

<span data-ttu-id="ae96e-169">La valeur « OverPost » est ajoutée avec succès à la propriété `Secret` de la ligne insérée.</span><span class="sxs-lookup"><span data-stu-id="ae96e-169">The value "OverPost" is successfully added to the `Secret` property of the inserted row.</span></span> <span data-ttu-id="ae96e-170">Cela se produit même si le concepteur de l’application n’avait jamais prévu que la propriété `Secret` serait définie avec la page Create.</span><span class="sxs-lookup"><span data-stu-id="ae96e-170">That happens even though the app designer never intended the `Secret` property to be set with the Create page.</span></span>

### <a name="view-model"></a><span data-ttu-id="ae96e-171">Afficher le modèle</span><span class="sxs-lookup"><span data-stu-id="ae96e-171">View model</span></span>

<span data-ttu-id="ae96e-172">Les modèles d’affichage fournissent une alternative pour empêcher la sur-publication.</span><span class="sxs-lookup"><span data-stu-id="ae96e-172">View models provide an alternative way to prevent overposting.</span></span>

<span data-ttu-id="ae96e-173">Le modèle d’application est souvent appelé modèle de domaine.</span><span class="sxs-lookup"><span data-stu-id="ae96e-173">The application model is often called the domain model.</span></span> <span data-ttu-id="ae96e-174">En règle générale, le modèle de domaine contient toutes les propriétés requises par l’entité correspondante dans la base de données.</span><span class="sxs-lookup"><span data-stu-id="ae96e-174">The domain model typically contains all the properties required by the corresponding entity in the database.</span></span> <span data-ttu-id="ae96e-175">Le modèle de vue contient uniquement les propriétés nécessaires à la page de l’interface utilisateur, par exemple, la page créer.</span><span class="sxs-lookup"><span data-stu-id="ae96e-175">The view model contains only the properties needed for the UI page, for example, the Create page.</span></span>

<span data-ttu-id="ae96e-176">Outre le modèle de vue, certaines applications utilisent un modèle de liaison ou un modèle d’entrée pour passer des données entre la Razor classe de modèle de page pages et le navigateur.</span><span class="sxs-lookup"><span data-stu-id="ae96e-176">In addition to the view model, some apps use a binding model or input model to pass data between the Razor Pages page model class and the browser.</span></span> 

<span data-ttu-id="ae96e-177">Considérez le modèle d’affichage `StudentVM` suivant :</span><span class="sxs-lookup"><span data-stu-id="ae96e-177">Consider the following `StudentVM` view model:</span></span>

[!code-csharp[Main](intro/samples/cu50/ViewModels/StudentVM.cs?name=snippet)]

<span data-ttu-id="ae96e-178">Le code suivant utilise le modèle d’affichage `StudentVM` pour créer un étudiant :</span><span class="sxs-lookup"><span data-stu-id="ae96e-178">The following code uses the `StudentVM` view model to create a new student:</span></span>

[!code-csharp[Main](intro/samples/cu50/Pages/Students/CreateVM.cshtml.cs?name=snippet)]

<span data-ttu-id="ae96e-179">La méthode [SetValues](/dotnet/api/microsoft.entityframeworkcore.changetracking.propertyvalues.setvalues#Microsoft_EntityFrameworkCore_ChangeTracking_PropertyValues_SetValues_System_Object_) définit les valeurs de cet objet en lisant les valeurs d’un autre objet [PropertyValues](/dotnet/api/microsoft.entityframeworkcore.changetracking.propertyvalues).</span><span class="sxs-lookup"><span data-stu-id="ae96e-179">The [SetValues](/dotnet/api/microsoft.entityframeworkcore.changetracking.propertyvalues.setvalues#Microsoft_EntityFrameworkCore_ChangeTracking_PropertyValues_SetValues_System_Object_) method sets the values of this object by reading values from another [PropertyValues](/dotnet/api/microsoft.entityframeworkcore.changetracking.propertyvalues) object.</span></span> <span data-ttu-id="ae96e-180">`SetValues` utilise la correspondance de nom de propriété.</span><span class="sxs-lookup"><span data-stu-id="ae96e-180">`SetValues` uses property name matching.</span></span> <span data-ttu-id="ae96e-181">Type de modèle de vue :</span><span class="sxs-lookup"><span data-stu-id="ae96e-181">The view model type:</span></span>

* <span data-ttu-id="ae96e-182">N’a pas besoin d’être lié au type de modèle.</span><span class="sxs-lookup"><span data-stu-id="ae96e-182">Doesn't need to be related to the model type.</span></span>
* <span data-ttu-id="ae96e-183">Doit avoir des propriétés qui correspondent.</span><span class="sxs-lookup"><span data-stu-id="ae96e-183">Needs to have properties that match.</span></span>

<span data-ttu-id="ae96e-184">L’utilisation `StudentVM` de requiert l’utilisation de la page Create `StudentVM` au lieu de `Student` :</span><span class="sxs-lookup"><span data-stu-id="ae96e-184">Using `StudentVM` requires the Create page use `StudentVM` rather than `Student`:</span></span>

[!code-cshtml[Main](intro/samples/cu50/Pages/Students/CreateVM.cshtml)]

## <a name="update-the-edit-page"></a><span data-ttu-id="ae96e-185">Mettre à jour la page Edit</span><span class="sxs-lookup"><span data-stu-id="ae96e-185">Update the Edit page</span></span>

<span data-ttu-id="ae96e-186">Dans *Pages/Students/Edit.cshtml.cs*, remplacez les méthodes `OnGetAsync` et `OnPostAsync` par le code suivant.</span><span class="sxs-lookup"><span data-stu-id="ae96e-186">In *Pages/Students/Edit.cshtml.cs*, replace the `OnGetAsync` and `OnPostAsync` methods with the following code.</span></span>

[!code-csharp[Main](intro/samples/cu30/Pages/Students/Edit.cshtml.cs?name=snippet_OnGetPost)]

<span data-ttu-id="ae96e-187">Les modifications de code sont semblables à celles de la page Create, à quelques exceptions près :</span><span class="sxs-lookup"><span data-stu-id="ae96e-187">The code changes are similar to the Create page with a few exceptions:</span></span>

* <span data-ttu-id="ae96e-188">`FirstOrDefaultAsync` a été remplacée par [FindAsync](/dotnet/api/microsoft.entityframeworkcore.dbset-1.findasync).</span><span class="sxs-lookup"><span data-stu-id="ae96e-188">`FirstOrDefaultAsync` has been replaced with [FindAsync](/dotnet/api/microsoft.entityframeworkcore.dbset-1.findasync).</span></span> <span data-ttu-id="ae96e-189">Quand vous n’êtes pas tenu d’inclure des données associées, `FindAsync` est plus efficace.</span><span class="sxs-lookup"><span data-stu-id="ae96e-189">When you don't have to include related data, `FindAsync` is more efficient.</span></span>
* <span data-ttu-id="ae96e-190">`OnPostAsync` contient un paramètre `id`.</span><span class="sxs-lookup"><span data-stu-id="ae96e-190">`OnPostAsync` has an `id` parameter.</span></span>
* <span data-ttu-id="ae96e-191">Plutôt que de créer un étudiant vide, l’étudiant actuel est récupéré à partir de la base de données.</span><span class="sxs-lookup"><span data-stu-id="ae96e-191">The current student is fetched from the database, rather than creating an empty student.</span></span>

<span data-ttu-id="ae96e-192">Exécutez l’application et testez-la en créant et modifiant un étudiant.</span><span class="sxs-lookup"><span data-stu-id="ae96e-192">Run the app, and test it by creating and editing a student.</span></span>

## <a name="entity-states"></a><span data-ttu-id="ae96e-193">États des entités</span><span class="sxs-lookup"><span data-stu-id="ae96e-193">Entity States</span></span>

<span data-ttu-id="ae96e-194">Le contexte de base de données effectue un suivi pour déterminer si les entités en mémoire sont synchronisées avec les lignes correspondantes de la base de données.</span><span class="sxs-lookup"><span data-stu-id="ae96e-194">The database context keeps track of whether entities in memory are in sync with their corresponding rows in the database.</span></span> <span data-ttu-id="ae96e-195">Ces informations de suivi déterminent ce qui se passe quand [SaveChangesAsync](/dotnet/api/microsoft.entityframeworkcore.dbcontext.savechangesasync#Microsoft_EntityFrameworkCore_DbContext_SaveChangesAsync_System_Threading_CancellationToken_) est appelé.</span><span class="sxs-lookup"><span data-stu-id="ae96e-195">This tracking information determines what happens when [SaveChangesAsync](/dotnet/api/microsoft.entityframeworkcore.dbcontext.savechangesasync#Microsoft_EntityFrameworkCore_DbContext_SaveChangesAsync_System_Threading_CancellationToken_) is called.</span></span> <span data-ttu-id="ae96e-196">Par exemple, quand une nouvelle entité est passée à la méthode [AddAsync](/dotnet/api/microsoft.entityframeworkcore.dbcontext.addasync), l’état de cette entité est défini sur [Added](/dotnet/api/microsoft.entityframeworkcore.entitystate#Microsoft_EntityFrameworkCore_EntityState_Added).</span><span class="sxs-lookup"><span data-stu-id="ae96e-196">For example, when a new entity is passed to the [AddAsync](/dotnet/api/microsoft.entityframeworkcore.dbcontext.addasync) method, that entity's state is set to [Added](/dotnet/api/microsoft.entityframeworkcore.entitystate#Microsoft_EntityFrameworkCore_EntityState_Added).</span></span> <span data-ttu-id="ae96e-197">Lorsque `SaveChangesAsync` est appelé, le contexte de base de données émet une `INSERT` commande SQL.</span><span class="sxs-lookup"><span data-stu-id="ae96e-197">When `SaveChangesAsync` is called, the database context issues a SQL `INSERT` command.</span></span>

<span data-ttu-id="ae96e-198">Une entité peut être dans l’un des [États suivants](/dotnet/api/microsoft.entityframeworkcore.entitystate):</span><span class="sxs-lookup"><span data-stu-id="ae96e-198">An entity may be in one of the [following states](/dotnet/api/microsoft.entityframeworkcore.entitystate):</span></span>

* <span data-ttu-id="ae96e-199">`Added`: L’entité n’existe pas encore dans la base de données.</span><span class="sxs-lookup"><span data-stu-id="ae96e-199">`Added`: The entity doesn't yet exist in the database.</span></span> <span data-ttu-id="ae96e-200">La `SaveChanges` méthode émet une `INSERT` instruction.</span><span class="sxs-lookup"><span data-stu-id="ae96e-200">The `SaveChanges` method issues an `INSERT` statement.</span></span>

* <span data-ttu-id="ae96e-201">`Unchanged` : Aucune modification ne doit être enregistrée avec cette entité.</span><span class="sxs-lookup"><span data-stu-id="ae96e-201">`Unchanged`: No changes need to be saved with this entity.</span></span> <span data-ttu-id="ae96e-202">Une entité est dans cet état quand elle est lue à partir de la base de données.</span><span class="sxs-lookup"><span data-stu-id="ae96e-202">An entity has this status when it's read from the database.</span></span>

* <span data-ttu-id="ae96e-203">`Modified` : Tout ou une partie des valeurs de propriété de l’entité ont été modifiées.</span><span class="sxs-lookup"><span data-stu-id="ae96e-203">`Modified`: Some or all of the entity's property values have been modified.</span></span> <span data-ttu-id="ae96e-204">La `SaveChanges` méthode émet une `UPDATE` instruction.</span><span class="sxs-lookup"><span data-stu-id="ae96e-204">The `SaveChanges` method issues an `UPDATE` statement.</span></span>

* <span data-ttu-id="ae96e-205">`Deleted` : L’entité a été marquée pour suppression.</span><span class="sxs-lookup"><span data-stu-id="ae96e-205">`Deleted`: The entity has been marked for deletion.</span></span> <span data-ttu-id="ae96e-206">La `SaveChanges` méthode émet une `DELETE` instruction.</span><span class="sxs-lookup"><span data-stu-id="ae96e-206">The `SaveChanges` method issues a `DELETE` statement.</span></span>

* <span data-ttu-id="ae96e-207">`Detached`: L’entité n’est pas suivie par le contexte de base de données.</span><span class="sxs-lookup"><span data-stu-id="ae96e-207">`Detached`: The entity isn't being tracked by the database context.</span></span>

<span data-ttu-id="ae96e-208">Dans une application de bureau, les changements d’état sont généralement définis automatiquement.</span><span class="sxs-lookup"><span data-stu-id="ae96e-208">In a desktop app, state changes are typically set automatically.</span></span> <span data-ttu-id="ae96e-209">Une entité est lue, des modifications sont apportées et l’état d’entité passe automatiquement à `Modified`.</span><span class="sxs-lookup"><span data-stu-id="ae96e-209">An entity is read, changes are made, and the entity state is automatically changed to `Modified`.</span></span> <span data-ttu-id="ae96e-210">`SaveChanges`L’appel de génère une `UPDATE` instruction SQL qui met à jour uniquement les propriétés modifiées.</span><span class="sxs-lookup"><span data-stu-id="ae96e-210">Calling `SaveChanges` generates a SQL `UPDATE` statement that updates only the changed properties.</span></span>

<span data-ttu-id="ae96e-211">Dans une application web, le `DbContext` qui lit une entité et affiche les données est supprimé après le rendu d’une page.</span><span class="sxs-lookup"><span data-stu-id="ae96e-211">In a web app, the `DbContext` that reads an entity and displays the data is disposed after a page is rendered.</span></span> <span data-ttu-id="ae96e-212">Quand la méthode `OnPostAsync` d’une page est appelée, une nouvelle requête web est faite avec une nouvelle instance du `DbContext`.</span><span class="sxs-lookup"><span data-stu-id="ae96e-212">When a page's `OnPostAsync` method is called, a new web request is made and with a new instance of the `DbContext`.</span></span> <span data-ttu-id="ae96e-213">La relecture de l’entité dans ce nouveau contexte simule le traitement de bureau.</span><span class="sxs-lookup"><span data-stu-id="ae96e-213">Rereading the entity in that new context simulates desktop processing.</span></span>

## <a name="update-the-delete-page"></a><span data-ttu-id="ae96e-214">Mettre à jour la page Delete</span><span class="sxs-lookup"><span data-stu-id="ae96e-214">Update the Delete page</span></span>

<span data-ttu-id="ae96e-215">Dans cette section, un message d’erreur personnalisé est implémenté lorsque l’appel à `SaveChanges` échoue.</span><span class="sxs-lookup"><span data-stu-id="ae96e-215">In this section, a custom error message is implemented when the call to `SaveChanges` fails.</span></span>

<span data-ttu-id="ae96e-216">Remplacez le code dans *Pages/Students/Delete.cshtml.cs* par le code suivant.</span><span class="sxs-lookup"><span data-stu-id="ae96e-216">Replace the code in *Pages/Students/Delete.cshtml.cs* with the following code.</span></span> <span data-ttu-id="ae96e-217">Les modifications apparaissent en surbrillance :</span><span class="sxs-lookup"><span data-stu-id="ae96e-217">The changes are highlighted:</span></span>

[!code-csharp[Main](intro/samples/cu50/Pages/Students/Delete.cshtml.cs?name=snippet_All&highlight=12-14,22,30-33,45-99)]

<span data-ttu-id="ae96e-218">Le code précédent ajoute le paramètre facultatif `saveChangesError` à la signature de méthode `OnGetAsync`.</span><span class="sxs-lookup"><span data-stu-id="ae96e-218">The preceding code adds the optional parameter `saveChangesError` to the `OnGetAsync` method signature.</span></span> <span data-ttu-id="ae96e-219">`saveChangesError` indique si la méthode a été appelée après un échec de suppression de l’objet Student.</span><span class="sxs-lookup"><span data-stu-id="ae96e-219">`saveChangesError` indicates whether the method was called after a failure to delete the student object.</span></span> <span data-ttu-id="ae96e-220">L’opération de suppression peut échouer en raison de problèmes réseau temporaires.</span><span class="sxs-lookup"><span data-stu-id="ae96e-220">The delete operation might fail because of transient network problems.</span></span> <span data-ttu-id="ae96e-221">Vous avez plus de chances de rencontrer des erreurs réseau temporaires quand la base de données est dans le cloud.</span><span class="sxs-lookup"><span data-stu-id="ae96e-221">Transient network errors are more likely when the database is in the cloud.</span></span> <span data-ttu-id="ae96e-222">Le `saveChangesError` paramètre est `false` lorsque la page `OnGetAsync` de suppression est appelée à partir de l’interface utilisateur.</span><span class="sxs-lookup"><span data-stu-id="ae96e-222">The `saveChangesError` parameter is `false` when the Delete page `OnGetAsync` is called from the UI.</span></span> <span data-ttu-id="ae96e-223">Lorsque `OnGetAsync` est appelé par, `OnPostAsync` car l’opération de suppression a échoué, le `saveChangesError` paramètre est `true` .</span><span class="sxs-lookup"><span data-stu-id="ae96e-223">When `OnGetAsync` is called by `OnPostAsync` because the delete operation failed, the `saveChangesError` parameter is `true`.</span></span>

<span data-ttu-id="ae96e-224">La méthode `OnPostAsync` récupère l’entité sélectionnée, puis appelle la méthode [Remove](/dotnet/api/microsoft.entityframeworkcore.dbcontext.remove#Microsoft_EntityFrameworkCore_DbContext_Remove_System_Object_) pour définir l’état de l’entité sur `Deleted`.</span><span class="sxs-lookup"><span data-stu-id="ae96e-224">The `OnPostAsync` method retrieves the selected entity, then calls the [Remove](/dotnet/api/microsoft.entityframeworkcore.dbcontext.remove#Microsoft_EntityFrameworkCore_DbContext_Remove_System_Object_) method to set the entity's status to `Deleted`.</span></span> <span data-ttu-id="ae96e-225">Lorsque `SaveChanges` la méthode est appelée, une `DELETE` commande SQL est générée.</span><span class="sxs-lookup"><span data-stu-id="ae96e-225">When `SaveChanges` is called, a SQL `DELETE` command is generated.</span></span> <span data-ttu-id="ae96e-226">Si `Remove` échoue :</span><span class="sxs-lookup"><span data-stu-id="ae96e-226">If `Remove` fails:</span></span>

* <span data-ttu-id="ae96e-227">L’exception de la base de données est interceptée.</span><span class="sxs-lookup"><span data-stu-id="ae96e-227">The database exception is caught.</span></span>
* <span data-ttu-id="ae96e-228">La méthode `OnGetAsync` des pages est appelée avec `saveChangesError=true`.</span><span class="sxs-lookup"><span data-stu-id="ae96e-228">The Delete pages `OnGetAsync` method is called with `saveChangesError=true`.</span></span>

<span data-ttu-id="ae96e-229">Ajoutez un message d’erreur à *pages/élèves/Delete. cshtml*:</span><span class="sxs-lookup"><span data-stu-id="ae96e-229">Add an error message to *Pages/Students/Delete.cshtml*:</span></span>

[!code-cshtml[Main](intro/samples/cu30/Pages/Students/Delete.cshtml?highlight=10)]

<span data-ttu-id="ae96e-230">Exécutez l’application et supprimez un étudiant pour tester la page Delete.</span><span class="sxs-lookup"><span data-stu-id="ae96e-230">Run the app and delete a student to test the Delete page.</span></span>

## <a name="next-steps"></a><span data-ttu-id="ae96e-231">Étapes suivantes</span><span class="sxs-lookup"><span data-stu-id="ae96e-231">Next steps</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="ae96e-232">[Didacticiel précédent](xref:data/ef-rp/intro) 
>  [Didacticiel suivant](xref:data/ef-rp/sort-filter-page)</span><span class="sxs-lookup"><span data-stu-id="ae96e-232">[Previous tutorial](xref:data/ef-rp/intro)
[Next tutorial](xref:data/ef-rp/sort-filter-page)</span></span>

::: moniker-end

::: moniker range=">= aspnetcore-3.0 < aspnetcore-5.0"

<span data-ttu-id="ae96e-233">Dans ce didacticiel, nous allons examiner et personnaliser le code CRUD (créer, lire, mettre à jour, supprimer) généré automatiquement.</span><span class="sxs-lookup"><span data-stu-id="ae96e-233">In this tutorial, the scaffolded CRUD (create, read, update, delete) code is reviewed and customized.</span></span>

## <a name="no-repository"></a><span data-ttu-id="ae96e-234">Aucun référentiel</span><span class="sxs-lookup"><span data-stu-id="ae96e-234">No repository</span></span>

<span data-ttu-id="ae96e-235">Certains développeurs utilisent une couche de service ou un modèle de référentiel pour créer une couche d’abstraction entre l’interface utilisateur ( Razor pages) et la couche d’accès aux données.</span><span class="sxs-lookup"><span data-stu-id="ae96e-235">Some developers use a service layer or repository pattern to create an abstraction layer between the UI (Razor Pages) and the data access layer.</span></span> <span data-ttu-id="ae96e-236">Ce n’est pas le cas de ce tutoriel.</span><span class="sxs-lookup"><span data-stu-id="ae96e-236">This tutorial doesn't do that.</span></span> <span data-ttu-id="ae96e-237">Pour que ce tutoriel soit moins complexe et traite exclusivement d’EF Core, le code EF Core est directement ajouté aux classes de modèle de page.</span><span class="sxs-lookup"><span data-stu-id="ae96e-237">To minimize complexity and keep the tutorial focused on EF Core, EF Core code is added directly to the page model classes.</span></span> 

## <a name="update-the-details-page"></a><span data-ttu-id="ae96e-238">Mettre à jour la page Details</span><span class="sxs-lookup"><span data-stu-id="ae96e-238">Update the Details page</span></span>

<span data-ttu-id="ae96e-239">Le code généré automatiquement pour les pages Students n’inclut pas les données d’inscription (« enrollment »).</span><span class="sxs-lookup"><span data-stu-id="ae96e-239">The scaffolded code for the Students pages doesn't include enrollment data.</span></span> <span data-ttu-id="ae96e-240">Dans cette section, les inscriptions sont ajoutées à la page de détails.</span><span class="sxs-lookup"><span data-stu-id="ae96e-240">In this section, enrollments are added to the Details page.</span></span>

### <a name="read-enrollments"></a><span data-ttu-id="ae96e-241">Lire les inscriptions</span><span class="sxs-lookup"><span data-stu-id="ae96e-241">Read enrollments</span></span>

<span data-ttu-id="ae96e-242">Pour afficher les données d’inscription d’un étudiant sur la page, vous devez lire les données d’inscription.</span><span class="sxs-lookup"><span data-stu-id="ae96e-242">To display a student's enrollment data on the page, the enrollement data needs to be read.</span></span> <span data-ttu-id="ae96e-243">Le code généré automatiquement dans *Pages/Students/Details.cshtml.cs* lit uniquement les données d’étudiant, sans les données d’inscription :</span><span class="sxs-lookup"><span data-stu-id="ae96e-243">The scaffolded code in *Pages/Students/Details.cshtml.cs* reads only the Student data, without the Enrollment data:</span></span>

[!code-csharp[Main](intro/samples/cu30snapshots/2-crud/Pages/Students/Details1.cshtml.cs?name=snippet_OnGetAsync&highlight=8)]

<span data-ttu-id="ae96e-244">Remplacez la méthode `OnGetAsync` par le code suivant pour lire les données d’inscription de l’étudiant sélectionné.</span><span class="sxs-lookup"><span data-stu-id="ae96e-244">Replace the `OnGetAsync` method with the following code to read enrollment data for the selected student.</span></span> <span data-ttu-id="ae96e-245">Les modifications sont mises en surbrillance.</span><span class="sxs-lookup"><span data-stu-id="ae96e-245">The changes are highlighted.</span></span>

[!code-csharp[Main](intro/samples/cu30/Pages/Students/Details.cshtml.cs?name=snippet_OnGetAsync&highlight=8-12)]

<span data-ttu-id="ae96e-246">Les méthodes [Include](/dotnet/api/microsoft.entityframeworkcore.entityframeworkqueryableextensions.include) et [ThenInclude](/dotnet/api/microsoft.entityframeworkcore.entityframeworkqueryableextensions.theninclude#Microsoft_EntityFrameworkCore_EntityFrameworkQueryableExtensions_ThenInclude__3_Microsoft_EntityFrameworkCore_Query_IIncludableQueryable___0_System_Collections_Generic_IEnumerable___1___System_Linq_Expressions_Expression_System_Func___1___2___) forcent le contexte à charger la propriété de navigation `Student.Enrollments` et, dans chaque inscription, la propriété de navigation `Enrollment.Course`.</span><span class="sxs-lookup"><span data-stu-id="ae96e-246">The [Include](/dotnet/api/microsoft.entityframeworkcore.entityframeworkqueryableextensions.include) and [ThenInclude](/dotnet/api/microsoft.entityframeworkcore.entityframeworkqueryableextensions.theninclude#Microsoft_EntityFrameworkCore_EntityFrameworkQueryableExtensions_ThenInclude__3_Microsoft_EntityFrameworkCore_Query_IIncludableQueryable___0_System_Collections_Generic_IEnumerable___1___System_Linq_Expressions_Expression_System_Func___1___2___) methods cause the context to load the `Student.Enrollments` navigation property, and within each enrollment the `Enrollment.Course` navigation property.</span></span> <span data-ttu-id="ae96e-247">Ces méthodes sont examinées en détail dans le tutoriel [Lecture de données associées](xref:data/ef-rp/read-related-data).</span><span class="sxs-lookup"><span data-stu-id="ae96e-247">These methods are examined in detail in the [Reading related data](xref:data/ef-rp/read-related-data) tutorial.</span></span>

<span data-ttu-id="ae96e-248">La méthode [AsNoTracking](/dotnet/api/microsoft.entityframeworkcore.entityframeworkqueryableextensions.asnotracking#Microsoft_EntityFrameworkCore_EntityFrameworkQueryableExtensions_AsNoTracking__1_System_Linq_IQueryable___0__) améliore les performances dans les scénarios où les entités retournées ne sont pas mises à jour dans le contexte actuel.</span><span class="sxs-lookup"><span data-stu-id="ae96e-248">The [AsNoTracking](/dotnet/api/microsoft.entityframeworkcore.entityframeworkqueryableextensions.asnotracking#Microsoft_EntityFrameworkCore_EntityFrameworkQueryableExtensions_AsNoTracking__1_System_Linq_IQueryable___0__) method improves performance in scenarios where the entities returned are not updated in the current context.</span></span> <span data-ttu-id="ae96e-249">Le sujet `AsNoTracking` est abordé plus loin dans ce didacticiel.</span><span class="sxs-lookup"><span data-stu-id="ae96e-249">`AsNoTracking` is discussed later in this tutorial.</span></span>

### <a name="display-enrollments"></a><span data-ttu-id="ae96e-250">Afficher les inscriptions</span><span class="sxs-lookup"><span data-stu-id="ae96e-250">Display enrollments</span></span>

<span data-ttu-id="ae96e-251">Remplacez le code dans *Pages/Students/Details.cshtml* par le code suivant pour afficher une liste d’inscriptions.</span><span class="sxs-lookup"><span data-stu-id="ae96e-251">Replace the code in *Pages/Students/Details.cshtml* with the following code to display a list of enrollments.</span></span> <span data-ttu-id="ae96e-252">Les modifications sont mises en surbrillance.</span><span class="sxs-lookup"><span data-stu-id="ae96e-252">The changes are highlighted.</span></span>

[!code-cshtml[Main](intro/samples/cu30/Pages/Students/Details.cshtml?highlight=32-53)]

<span data-ttu-id="ae96e-253">Le code précédent effectue une itération sur les entités dans la propriété de navigation `Enrollments`.</span><span class="sxs-lookup"><span data-stu-id="ae96e-253">The preceding code loops through the entities in the `Enrollments` navigation property.</span></span> <span data-ttu-id="ae96e-254">Pour chaque inscription, il affiche le titre du cours et le niveau.</span><span class="sxs-lookup"><span data-stu-id="ae96e-254">For each enrollment, it displays the course title and the grade.</span></span> <span data-ttu-id="ae96e-255">Le titre du cours est récupéré à partir de l’entité de cours qui est stockée dans la propriété de navigation `Course` de l’entité Enrollments.</span><span class="sxs-lookup"><span data-stu-id="ae96e-255">The course title is retrieved from the Course entity that's stored in the `Course` navigation property of the Enrollments entity.</span></span>

<span data-ttu-id="ae96e-256">Exécutez l’application, sélectionnez l’onglet **Students**, puis cliquez sur le lien **Details** pour un étudiant.</span><span class="sxs-lookup"><span data-stu-id="ae96e-256">Run the app, select the **Students** tab, and click the **Details** link for a student.</span></span> <span data-ttu-id="ae96e-257">La liste des cours et les notes de l’étudiant sélectionné s’affiche.</span><span class="sxs-lookup"><span data-stu-id="ae96e-257">The list of courses and grades for the selected student is displayed.</span></span>

### <a name="ways-to-read-one-entity"></a><span data-ttu-id="ae96e-258">Méthodes pour lire une entité</span><span class="sxs-lookup"><span data-stu-id="ae96e-258">Ways to read one entity</span></span>

<span data-ttu-id="ae96e-259">Le code généré utilise [FirstOrDefaultAsync](/dotnet/api/microsoft.entityframeworkcore.entityframeworkqueryableextensions.firstordefaultasync#Microsoft_EntityFrameworkCore_EntityFrameworkQueryableExtensions_FirstOrDefaultAsync__1_System_Linq_IQueryable___0__System_Threading_CancellationToken_) pour lire une entité.</span><span class="sxs-lookup"><span data-stu-id="ae96e-259">The generated code uses [FirstOrDefaultAsync](/dotnet/api/microsoft.entityframeworkcore.entityframeworkqueryableextensions.firstordefaultasync#Microsoft_EntityFrameworkCore_EntityFrameworkQueryableExtensions_FirstOrDefaultAsync__1_System_Linq_IQueryable___0__System_Threading_CancellationToken_) to read one entity.</span></span> <span data-ttu-id="ae96e-260">Cette méthode retourne la valeur Null si rien n’est trouvé ; sinon, elle retourne la première ligne trouvée qui répond aux critères de filtre de requête.</span><span class="sxs-lookup"><span data-stu-id="ae96e-260">This method returns null if nothing is found; otherwise, it returns the first row found that satisfies the query filter criteria.</span></span> <span data-ttu-id="ae96e-261">`FirstOrDefaultAsync` est généralement un meilleur choix que les autres solutions suivantes :</span><span class="sxs-lookup"><span data-stu-id="ae96e-261">`FirstOrDefaultAsync` is generally a better choice than the following alternatives:</span></span>

* <span data-ttu-id="ae96e-262">[SingleOrDefaultAsync](/dotnet/api/microsoft.entityframeworkcore.entityframeworkqueryableextensions.singleordefaultasync#Microsoft_EntityFrameworkCore_EntityFrameworkQueryableExtensions_SingleOrDefaultAsync__1_System_Linq_IQueryable___0__System_Linq_Expressions_Expression_System_Func___0_System_Boolean___System_Threading_CancellationToken_) – Lève une exception si plusieurs entités répondent au filtre de requête.</span><span class="sxs-lookup"><span data-stu-id="ae96e-262">[SingleOrDefaultAsync](/dotnet/api/microsoft.entityframeworkcore.entityframeworkqueryableextensions.singleordefaultasync#Microsoft_EntityFrameworkCore_EntityFrameworkQueryableExtensions_SingleOrDefaultAsync__1_System_Linq_IQueryable___0__System_Linq_Expressions_Expression_System_Func___0_System_Boolean___System_Threading_CancellationToken_) - Throws an exception if there's more than one entity that satisfies the query filter.</span></span> <span data-ttu-id="ae96e-263">Pour déterminer si plusieurs lignes peuvent être retournées par la requête, `SingleOrDefaultAsync` tente de récupérer plusieurs lignes.</span><span class="sxs-lookup"><span data-stu-id="ae96e-263">To determine if more than one row could be returned by the query, `SingleOrDefaultAsync` tries to fetch multiple rows.</span></span> <span data-ttu-id="ae96e-264">Ce travail supplémentaire est inutile si la requête ne peut retourner qu’une seule entité, comme quand elle effectue une recherche sur une clé unique.</span><span class="sxs-lookup"><span data-stu-id="ae96e-264">This extra work is unnecessary if the query can only return one entity, as when it searches on a unique key.</span></span>
* <span data-ttu-id="ae96e-265">[FindAsync](/dotnet/api/microsoft.entityframeworkcore.dbcontext.findasync#Microsoft_EntityFrameworkCore_DbContext_FindAsync_System_Type_System_Object___) – Recherche une entité avec la clé primaire.</span><span class="sxs-lookup"><span data-stu-id="ae96e-265">[FindAsync](/dotnet/api/microsoft.entityframeworkcore.dbcontext.findasync#Microsoft_EntityFrameworkCore_DbContext_FindAsync_System_Type_System_Object___) - Finds an entity with the primary key (PK).</span></span> <span data-ttu-id="ae96e-266">Si une entité avec la clé primaire est suivie par le contexte, elle est retournée sans qu’aucune requête soit envoyée à la base de données.</span><span class="sxs-lookup"><span data-stu-id="ae96e-266">If an entity with the PK is being tracked by the context, it's returned without a request to the database.</span></span> <span data-ttu-id="ae96e-267">Cette méthode est optimisée pour la recherche d’une seule entité, mais vous ne pouvez pas appeler `Include` avec `FindAsync`.</span><span class="sxs-lookup"><span data-stu-id="ae96e-267">This method is optimized to look up a single entity, but you can't call `Include` with `FindAsync`.</span></span>  <span data-ttu-id="ae96e-268">Par conséquent, si des données associées sont nécessaires, `FirstOrDefaultAsync` est le meilleur choix.</span><span class="sxs-lookup"><span data-stu-id="ae96e-268">So if related data is needed, `FirstOrDefaultAsync` is the better choice.</span></span>

### <a name="route-data-vs-query-string"></a><span data-ttu-id="ae96e-269">Données de route/chaîne de requête</span><span class="sxs-lookup"><span data-stu-id="ae96e-269">Route data vs. query string</span></span>

<span data-ttu-id="ae96e-270">L’URL de la page Details est `https://localhost:<port>/Students/Details?id=1`.</span><span class="sxs-lookup"><span data-stu-id="ae96e-270">The URL for the Details page is `https://localhost:<port>/Students/Details?id=1`.</span></span> <span data-ttu-id="ae96e-271">La valeur de clé primaire de l’entité se trouve dans la chaîne de requête.</span><span class="sxs-lookup"><span data-stu-id="ae96e-271">The entity's primary key value is in the query string.</span></span> <span data-ttu-id="ae96e-272">Certains développeurs préfèrent passer la valeur de clé dans des données de route : `https://localhost:<port>/Students/Details/1`.</span><span class="sxs-lookup"><span data-stu-id="ae96e-272">Some developers prefer to pass the key value in route data: `https://localhost:<port>/Students/Details/1`.</span></span> <span data-ttu-id="ae96e-273">Pour plus d'informations, consultez [Mettre à jour le code généré](xref:tutorials/razor-pages/da1#update-the-generated-code).</span><span class="sxs-lookup"><span data-stu-id="ae96e-273">For more information, see [Update the generated code](xref:tutorials/razor-pages/da1#update-the-generated-code).</span></span>

## <a name="update-the-create-page"></a><span data-ttu-id="ae96e-274">Mettre à jour la page Create</span><span class="sxs-lookup"><span data-stu-id="ae96e-274">Update the Create page</span></span>

<span data-ttu-id="ae96e-275">Le code `OnPostAsync` généré automatiquement pour la page Create est vulnérable aux [sur-publications](#overposting).</span><span class="sxs-lookup"><span data-stu-id="ae96e-275">The scaffolded `OnPostAsync` code for the Create page is vulnerable to [overposting](#overposting).</span></span> <span data-ttu-id="ae96e-276">Remplacez la méthode `OnPostAsync` dans *Pages/Students/Create.cshtml.cs* par le code suivant.</span><span class="sxs-lookup"><span data-stu-id="ae96e-276">Replace the `OnPostAsync` method in *Pages/Students/Create.cshtml.cs* with the following code.</span></span>

[!code-csharp[Main](intro/samples/cu30/Pages/Students/Create.cshtml.cs?name=snippet_OnPostAsync)]

<a name="TryUpdateModelAsync"></a>

### <a name="tryupdatemodelasync"></a><span data-ttu-id="ae96e-277">TryUpdateModelAsync</span><span class="sxs-lookup"><span data-stu-id="ae96e-277">TryUpdateModelAsync</span></span>

<span data-ttu-id="ae96e-278">Le code précédent crée un objet Student, puis utilise des champs de formulaire publiés pour mettre à jour les propriétés de l’objet Student.</span><span class="sxs-lookup"><span data-stu-id="ae96e-278">The preceding code creates a Student object and then uses posted form fields to update the Student object's properties.</span></span> <span data-ttu-id="ae96e-279">La méthode [TryUpdateModelAsync](/dotnet/api/microsoft.aspnetcore.mvc.controllerbase.tryupdatemodelasync#Microsoft_AspNetCore_Mvc_ControllerBase_TryUpdateModelAsync_System_Object_System_Type_System_String_) :</span><span class="sxs-lookup"><span data-stu-id="ae96e-279">The [TryUpdateModelAsync](/dotnet/api/microsoft.aspnetcore.mvc.controllerbase.tryupdatemodelasync#Microsoft_AspNetCore_Mvc_ControllerBase_TryUpdateModelAsync_System_Object_System_Type_System_String_) method:</span></span>

* <span data-ttu-id="ae96e-280">Utilise les valeurs de formulaire publiées de la propriété [PageContext](/dotnet/api/microsoft.aspnetcore.mvc.razorpages.pagemodel.pagecontext#Microsoft_AspNetCore_Mvc_RazorPages_PageModel_PageContext) de [PageModel](/dotnet/api/microsoft.aspnetcore.mvc.razorpages.pagemodel).</span><span class="sxs-lookup"><span data-stu-id="ae96e-280">Uses the posted form values from the [PageContext](/dotnet/api/microsoft.aspnetcore.mvc.razorpages.pagemodel.pagecontext#Microsoft_AspNetCore_Mvc_RazorPages_PageModel_PageContext) property in the [PageModel](/dotnet/api/microsoft.aspnetcore.mvc.razorpages.pagemodel).</span></span>
* <span data-ttu-id="ae96e-281">Met à jour uniquement les propriétés listées (`s => s.FirstMidName, s => s.LastName, s => s.EnrollmentDate`).</span><span class="sxs-lookup"><span data-stu-id="ae96e-281">Updates only the properties listed (`s => s.FirstMidName, s => s.LastName, s => s.EnrollmentDate`).</span></span>
* <span data-ttu-id="ae96e-282">Recherche les champs de formulaire dotés d’un préfixe « Student ».</span><span class="sxs-lookup"><span data-stu-id="ae96e-282">Looks for form fields with a "student" prefix.</span></span> <span data-ttu-id="ae96e-283">Par exemple : `Student.FirstMidName`.</span><span class="sxs-lookup"><span data-stu-id="ae96e-283">For example, `Student.FirstMidName`.</span></span> <span data-ttu-id="ae96e-284">Il ne respecte pas la casse.</span><span class="sxs-lookup"><span data-stu-id="ae96e-284">It's not case sensitive.</span></span>
* <span data-ttu-id="ae96e-285">Utilise le système de [liaison de modèles](xref:mvc/models/model-binding) pour convertir les valeurs de formulaire de chaînes en types dans le modèle `Student`.</span><span class="sxs-lookup"><span data-stu-id="ae96e-285">Uses the [model binding](xref:mvc/models/model-binding) system to convert form values from strings to the types in the `Student` model.</span></span> <span data-ttu-id="ae96e-286">Par exemple, `EnrollmentDate` doit être converti en DateTime.</span><span class="sxs-lookup"><span data-stu-id="ae96e-286">For example, `EnrollmentDate` has to be converted to DateTime.</span></span>

<span data-ttu-id="ae96e-287">Exécutez l’application, puis créez une entité Student pour tester la page Create.</span><span class="sxs-lookup"><span data-stu-id="ae96e-287">Run the app, and create a student entity to test the Create page.</span></span>

## <a name="overposting"></a><span data-ttu-id="ae96e-288">Sur-publication</span><span class="sxs-lookup"><span data-stu-id="ae96e-288">Overposting</span></span>

<span data-ttu-id="ae96e-289">L’utilisation de `TryUpdateModel` pour mettre à jour des champs avec des valeurs publiées est une bonne pratique de sécurité, car cela empêche la sur-publication.</span><span class="sxs-lookup"><span data-stu-id="ae96e-289">Using `TryUpdateModel` to update fields with posted values is a security best practice because it prevents overposting.</span></span> <span data-ttu-id="ae96e-290">Par exemple, supposez que l’entité Student comprend une propriété `Secret` que cette page web ne doit pas mettre à jour ou ajouter :</span><span class="sxs-lookup"><span data-stu-id="ae96e-290">For example, suppose the Student entity includes a `Secret` property that this web page shouldn't update or add:</span></span>

[!code-csharp[Main](intro/samples/cu30snapshots/2-crud/Models/StudentZsecret.cs?name=snippet_Intro&highlight=7)]

<span data-ttu-id="ae96e-291">Même si l’application n’a pas de `Secret` champ dans la page de création ou de mise à jour Razor , un pirate peut définir la `Secret` valeur par survalidation.</span><span class="sxs-lookup"><span data-stu-id="ae96e-291">Even if the app doesn't have a `Secret` field on the create or update Razor Page, a hacker could set the `Secret` value by overposting.</span></span> <span data-ttu-id="ae96e-292">Un pirate pourrait utiliser un outil tel que Fiddler, ou écrire du JavaScript, pour publier une valeur de formulaire `Secret`.</span><span class="sxs-lookup"><span data-stu-id="ae96e-292">A hacker could use a tool such as Fiddler, or write some JavaScript, to post a `Secret` form value.</span></span> <span data-ttu-id="ae96e-293">Le code d’origine ne limite pas les champs que le classeur de modèles utilise quand il crée une instance de Student.</span><span class="sxs-lookup"><span data-stu-id="ae96e-293">The original code doesn't limit the fields that the model binder uses when it creates a Student instance.</span></span>

<span data-ttu-id="ae96e-294">La valeur spécifiée par le pirate pour le champ de formulaire `Secret`, quelle qu’elle soit, est mise à jour dans la base de données.</span><span class="sxs-lookup"><span data-stu-id="ae96e-294">Whatever value the hacker specified for the `Secret` form field is updated in the database.</span></span> <span data-ttu-id="ae96e-295">L’illustration suivante montre l’outil Fiddler en train d’ajouter le champ `Secret` (avec la valeur « OverPost ») aux valeurs du formulaire envoyé.</span><span class="sxs-lookup"><span data-stu-id="ae96e-295">The following image shows the Fiddler tool adding the `Secret` field (with the value "OverPost") to the posted form values.</span></span>

![Fiddler ajoutant un champ Secret](../ef-mvc/crud/_static/fiddler.png)

<span data-ttu-id="ae96e-297">La valeur « OverPost » est ajoutée avec succès à la propriété `Secret` de la ligne insérée.</span><span class="sxs-lookup"><span data-stu-id="ae96e-297">The value "OverPost" is successfully added to the `Secret` property of the inserted row.</span></span> <span data-ttu-id="ae96e-298">Cela se produit même si le concepteur de l’application n’avait jamais prévu que la propriété `Secret` serait définie avec la page Create.</span><span class="sxs-lookup"><span data-stu-id="ae96e-298">That happens even though the app designer never intended the `Secret` property to be set with the Create page.</span></span>

### <a name="view-model"></a><span data-ttu-id="ae96e-299">Afficher le modèle</span><span class="sxs-lookup"><span data-stu-id="ae96e-299">View model</span></span>

<span data-ttu-id="ae96e-300">Les modèles d’affichage fournissent une alternative pour empêcher la sur-publication.</span><span class="sxs-lookup"><span data-stu-id="ae96e-300">View models provide an alternative way to prevent overposting.</span></span>

<span data-ttu-id="ae96e-301">Le modèle d’application est souvent appelé modèle de domaine.</span><span class="sxs-lookup"><span data-stu-id="ae96e-301">The application model is often called the domain model.</span></span> <span data-ttu-id="ae96e-302">En règle générale, le modèle de domaine contient toutes les propriétés requises par l’entité correspondante dans la base de données.</span><span class="sxs-lookup"><span data-stu-id="ae96e-302">The domain model typically contains all the properties required by the corresponding entity in the database.</span></span> <span data-ttu-id="ae96e-303">Le modèle de vue contient uniquement les propriétés nécessaires à l’interface utilisateur pour laquelle il est utilisé (par exemple, la page Create).</span><span class="sxs-lookup"><span data-stu-id="ae96e-303">The view model contains only the properties needed for the UI that it is used for (for example, the Create page).</span></span>

<span data-ttu-id="ae96e-304">Outre le modèle de vue, certaines applications utilisent un modèle de liaison ou un modèle d’entrée pour passer des données entre la Razor classe de modèle de page pages et le navigateur.</span><span class="sxs-lookup"><span data-stu-id="ae96e-304">In addition to the view model, some apps use a binding model or input model to pass data between the Razor Pages page model class and the browser.</span></span> 

<span data-ttu-id="ae96e-305">Considérez le modèle d’affichage `Student` suivant :</span><span class="sxs-lookup"><span data-stu-id="ae96e-305">Consider the following `Student` view model:</span></span>

[!code-csharp[Main](intro/samples/cu30snapshots/2-crud/Models/StudentVM.cs)]

<span data-ttu-id="ae96e-306">Le code suivant utilise le modèle d’affichage `StudentVM` pour créer un étudiant :</span><span class="sxs-lookup"><span data-stu-id="ae96e-306">The following code uses the `StudentVM` view model to create a new student:</span></span>

[!code-csharp[Main](intro/samples/cu30snapshots/2-crud/Pages/Students/CreateVM.cshtml.cs?name=snippet_OnPostAsync)]

<span data-ttu-id="ae96e-307">La méthode [SetValues](/dotnet/api/microsoft.entityframeworkcore.changetracking.propertyvalues.setvalues#Microsoft_EntityFrameworkCore_ChangeTracking_PropertyValues_SetValues_System_Object_) définit les valeurs de cet objet en lisant les valeurs d’un autre objet [PropertyValues](/dotnet/api/microsoft.entityframeworkcore.changetracking.propertyvalues).</span><span class="sxs-lookup"><span data-stu-id="ae96e-307">The [SetValues](/dotnet/api/microsoft.entityframeworkcore.changetracking.propertyvalues.setvalues#Microsoft_EntityFrameworkCore_ChangeTracking_PropertyValues_SetValues_System_Object_) method sets the values of this object by reading values from another [PropertyValues](/dotnet/api/microsoft.entityframeworkcore.changetracking.propertyvalues) object.</span></span> <span data-ttu-id="ae96e-308">`SetValues` utilise la correspondance de nom de propriété.</span><span class="sxs-lookup"><span data-stu-id="ae96e-308">`SetValues` uses property name matching.</span></span> <span data-ttu-id="ae96e-309">Le type de modèle d’affichage ne doit pas nécessairement être lié au type de modèle. Il doit simplement avoir des propriétés qui correspondent.</span><span class="sxs-lookup"><span data-stu-id="ae96e-309">The view model type doesn't need to be related to the model type, it just needs to have properties that match.</span></span>

<span data-ttu-id="ae96e-310">L’utilisation de `StudentVM` exige que [Create.cshtml](https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/data/ef-rp/intro/samples/cu30snapshots/2-crud/Pages/Students/CreateVM.cshtml) soit mis à jour pour utiliser `StudentVM` plutôt que `Student`.</span><span class="sxs-lookup"><span data-stu-id="ae96e-310">Using `StudentVM` requires [Create.cshtml](https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/data/ef-rp/intro/samples/cu30snapshots/2-crud/Pages/Students/CreateVM.cshtml) be updated to use `StudentVM` rather than `Student`.</span></span>

## <a name="update-the-edit-page"></a><span data-ttu-id="ae96e-311">Mettre à jour la page Edit</span><span class="sxs-lookup"><span data-stu-id="ae96e-311">Update the Edit page</span></span>

<span data-ttu-id="ae96e-312">Dans *Pages/Students/Edit.cshtml.cs*, remplacez les méthodes `OnGetAsync` et `OnPostAsync` par le code suivant.</span><span class="sxs-lookup"><span data-stu-id="ae96e-312">In *Pages/Students/Edit.cshtml.cs*, replace the `OnGetAsync` and `OnPostAsync` methods with the following code.</span></span>

[!code-csharp[Main](intro/samples/cu30/Pages/Students/Edit.cshtml.cs?name=snippet_OnGetPost)]

<span data-ttu-id="ae96e-313">Les modifications de code sont semblables à celles de la page Create, à quelques exceptions près :</span><span class="sxs-lookup"><span data-stu-id="ae96e-313">The code changes are similar to the Create page with a few exceptions:</span></span>

* <span data-ttu-id="ae96e-314">`FirstOrDefaultAsync` a été remplacée par [FindAsync](/dotnet/api/microsoft.entityframeworkcore.dbset-1.findasync).</span><span class="sxs-lookup"><span data-stu-id="ae96e-314">`FirstOrDefaultAsync` has been replaced with [FindAsync](/dotnet/api/microsoft.entityframeworkcore.dbset-1.findasync).</span></span> <span data-ttu-id="ae96e-315">Lorsque les données associées incluses ne sont pas nécessaires, `FindAsync` est plus efficace.</span><span class="sxs-lookup"><span data-stu-id="ae96e-315">When included related data is not needed, `FindAsync` is more efficient.</span></span>
* <span data-ttu-id="ae96e-316">`OnPostAsync` contient un paramètre `id`.</span><span class="sxs-lookup"><span data-stu-id="ae96e-316">`OnPostAsync` has an `id` parameter.</span></span>
* <span data-ttu-id="ae96e-317">Plutôt que de créer un étudiant vide, l’étudiant actuel est récupéré à partir de la base de données.</span><span class="sxs-lookup"><span data-stu-id="ae96e-317">The current student is fetched from the database, rather than creating an empty student.</span></span>

<span data-ttu-id="ae96e-318">Exécutez l’application et testez-la en créant et modifiant un étudiant.</span><span class="sxs-lookup"><span data-stu-id="ae96e-318">Run the app, and test it by creating and editing a student.</span></span>

## <a name="entity-states"></a><span data-ttu-id="ae96e-319">États des entités</span><span class="sxs-lookup"><span data-stu-id="ae96e-319">Entity States</span></span>

<span data-ttu-id="ae96e-320">Le contexte de base de données effectue un suivi pour déterminer si les entités en mémoire sont synchronisées avec les lignes correspondantes de la base de données.</span><span class="sxs-lookup"><span data-stu-id="ae96e-320">The database context keeps track of whether entities in memory are in sync with their corresponding rows in the database.</span></span> <span data-ttu-id="ae96e-321">Ces informations de suivi déterminent ce qui se passe quand [SaveChangesAsync](/dotnet/api/microsoft.entityframeworkcore.dbcontext.savechangesasync#Microsoft_EntityFrameworkCore_DbContext_SaveChangesAsync_System_Threading_CancellationToken_) est appelé.</span><span class="sxs-lookup"><span data-stu-id="ae96e-321">This tracking information determines what happens when [SaveChangesAsync](/dotnet/api/microsoft.entityframeworkcore.dbcontext.savechangesasync#Microsoft_EntityFrameworkCore_DbContext_SaveChangesAsync_System_Threading_CancellationToken_) is called.</span></span> <span data-ttu-id="ae96e-322">Par exemple, quand une nouvelle entité est passée à la méthode [AddAsync](/dotnet/api/microsoft.entityframeworkcore.dbcontext.addasync), l’état de cette entité est défini sur [Added](/dotnet/api/microsoft.entityframeworkcore.entitystate#Microsoft_EntityFrameworkCore_EntityState_Added).</span><span class="sxs-lookup"><span data-stu-id="ae96e-322">For example, when a new entity is passed to the [AddAsync](/dotnet/api/microsoft.entityframeworkcore.dbcontext.addasync) method, that entity's state is set to [Added](/dotnet/api/microsoft.entityframeworkcore.entitystate#Microsoft_EntityFrameworkCore_EntityState_Added).</span></span> <span data-ttu-id="ae96e-323">Quand `SaveChangesAsync` est appelé, le contexte de base de données émet une commande SQL INSERT.</span><span class="sxs-lookup"><span data-stu-id="ae96e-323">When `SaveChangesAsync` is called, the database context issues a SQL INSERT command.</span></span>

<span data-ttu-id="ae96e-324">Une entité peut être dans l’un des [États suivants](/dotnet/api/microsoft.entityframeworkcore.entitystate):</span><span class="sxs-lookup"><span data-stu-id="ae96e-324">An entity may be in one of the [following states](/dotnet/api/microsoft.entityframeworkcore.entitystate):</span></span>

* <span data-ttu-id="ae96e-325">`Added`: L’entité n’existe pas encore dans la base de données.</span><span class="sxs-lookup"><span data-stu-id="ae96e-325">`Added`: The entity doesn't yet exist in the database.</span></span> <span data-ttu-id="ae96e-326">La méthode `SaveChanges` émet une instruction INSERT.</span><span class="sxs-lookup"><span data-stu-id="ae96e-326">The `SaveChanges` method issues an INSERT statement.</span></span>

* <span data-ttu-id="ae96e-327">`Unchanged` : Aucune modification ne doit être enregistrée avec cette entité.</span><span class="sxs-lookup"><span data-stu-id="ae96e-327">`Unchanged`: No changes need to be saved with this entity.</span></span> <span data-ttu-id="ae96e-328">Une entité est dans cet état quand elle est lue à partir de la base de données.</span><span class="sxs-lookup"><span data-stu-id="ae96e-328">An entity has this status when it's read from the database.</span></span>

* <span data-ttu-id="ae96e-329">`Modified` : Tout ou une partie des valeurs de propriété de l’entité ont été modifiées.</span><span class="sxs-lookup"><span data-stu-id="ae96e-329">`Modified`: Some or all of the entity's property values have been modified.</span></span> <span data-ttu-id="ae96e-330">La méthode `SaveChanges` émet une instruction UPDATE.</span><span class="sxs-lookup"><span data-stu-id="ae96e-330">The `SaveChanges` method issues an UPDATE statement.</span></span>

* <span data-ttu-id="ae96e-331">`Deleted` : L’entité a été marquée pour suppression.</span><span class="sxs-lookup"><span data-stu-id="ae96e-331">`Deleted`: The entity has been marked for deletion.</span></span> <span data-ttu-id="ae96e-332">La méthode `SaveChanges` émet une instruction DELETE.</span><span class="sxs-lookup"><span data-stu-id="ae96e-332">The `SaveChanges` method issues a DELETE statement.</span></span>

* <span data-ttu-id="ae96e-333">`Detached`: L’entité n’est pas suivie par le contexte de base de données.</span><span class="sxs-lookup"><span data-stu-id="ae96e-333">`Detached`: The entity isn't being tracked by the database context.</span></span>

<span data-ttu-id="ae96e-334">Dans une application de bureau, les changements d’état sont généralement définis automatiquement.</span><span class="sxs-lookup"><span data-stu-id="ae96e-334">In a desktop app, state changes are typically set automatically.</span></span> <span data-ttu-id="ae96e-335">Une entité est lue, des modifications sont apportées et l’état d’entité passe automatiquement à `Modified`.</span><span class="sxs-lookup"><span data-stu-id="ae96e-335">An entity is read, changes are made, and the entity state is automatically changed to `Modified`.</span></span> <span data-ttu-id="ae96e-336">L’appel de `SaveChanges` génère une instruction SQL UPDATE qui met à jour uniquement les propriétés modifiées.</span><span class="sxs-lookup"><span data-stu-id="ae96e-336">Calling `SaveChanges` generates a SQL UPDATE statement that updates only the changed properties.</span></span>

<span data-ttu-id="ae96e-337">Dans une application web, le `DbContext` qui lit une entité et affiche les données est supprimé après le rendu d’une page.</span><span class="sxs-lookup"><span data-stu-id="ae96e-337">In a web app, the `DbContext` that reads an entity and displays the data is disposed after a page is rendered.</span></span> <span data-ttu-id="ae96e-338">Quand la méthode `OnPostAsync` d’une page est appelée, une nouvelle requête web est faite avec une nouvelle instance du `DbContext`.</span><span class="sxs-lookup"><span data-stu-id="ae96e-338">When a page's `OnPostAsync` method is called, a new web request is made and with a new instance of the `DbContext`.</span></span> <span data-ttu-id="ae96e-339">La relecture de l’entité dans ce nouveau contexte simule le traitement de bureau.</span><span class="sxs-lookup"><span data-stu-id="ae96e-339">Rereading the entity in that new context simulates desktop processing.</span></span>

## <a name="update-the-delete-page"></a><span data-ttu-id="ae96e-340">Mettre à jour la page Delete</span><span class="sxs-lookup"><span data-stu-id="ae96e-340">Update the Delete page</span></span>

<span data-ttu-id="ae96e-341">Dans cette section, vous allez implémenter un message d’erreur personnalisé quand l’appel à `SaveChanges` échoue.</span><span class="sxs-lookup"><span data-stu-id="ae96e-341">In this section, you implement a custom error message when the call to `SaveChanges` fails.</span></span>

<span data-ttu-id="ae96e-342">Remplacez le code dans *Pages/Students/Delete.cshtml.cs* par le code suivant.</span><span class="sxs-lookup"><span data-stu-id="ae96e-342">Replace the code in *Pages/Students/Delete.cshtml.cs* with the following code.</span></span> <span data-ttu-id="ae96e-343">Les modifications (autres que le nettoyage des instructions `using`) sont mises en surbrillance.</span><span class="sxs-lookup"><span data-stu-id="ae96e-343">The changes are highlighted (other than cleanup of `using` statements).</span></span>

[!code-csharp[Main](intro/samples/cu30/Pages/Students/Delete.cshtml.cs?name=snippet_All&highlight=20,22,30,38-41,53-71)]

<span data-ttu-id="ae96e-344">Le code précédent ajoute le paramètre facultatif `saveChangesError` à la signature de méthode `OnGetAsync`.</span><span class="sxs-lookup"><span data-stu-id="ae96e-344">The preceding code adds the optional parameter `saveChangesError` to the `OnGetAsync` method signature.</span></span> <span data-ttu-id="ae96e-345">`saveChangesError` indique si la méthode a été appelée après un échec de suppression de l’objet Student.</span><span class="sxs-lookup"><span data-stu-id="ae96e-345">`saveChangesError` indicates whether the method was called after a failure to delete the student object.</span></span> <span data-ttu-id="ae96e-346">L’opération de suppression peut échouer en raison de problèmes réseau temporaires.</span><span class="sxs-lookup"><span data-stu-id="ae96e-346">The delete operation might fail because of transient network problems.</span></span> <span data-ttu-id="ae96e-347">Vous avez plus de chances de rencontrer des erreurs réseau temporaires quand la base de données est dans le cloud.</span><span class="sxs-lookup"><span data-stu-id="ae96e-347">Transient network errors are more likely when the database is in the cloud.</span></span> <span data-ttu-id="ae96e-348">Le paramètre `saveChangesError` a la valeur false quand la méthode `OnGetAsync` de la page Delete est appelée à partir de l’interface utilisateur.</span><span class="sxs-lookup"><span data-stu-id="ae96e-348">The `saveChangesError` parameter is false when the Delete page `OnGetAsync` is called from the UI.</span></span> <span data-ttu-id="ae96e-349">Quand `OnGetAsync` est appelée par `OnPostAsync` (car l’opération de suppression a échoué), le paramètre `saveChangesError` a la valeur true.</span><span class="sxs-lookup"><span data-stu-id="ae96e-349">When `OnGetAsync` is called by `OnPostAsync` (because the delete operation failed), the `saveChangesError` parameter is true.</span></span>

<span data-ttu-id="ae96e-350">La méthode `OnPostAsync` récupère l’entité sélectionnée, puis appelle la méthode [Remove](/dotnet/api/microsoft.entityframeworkcore.dbcontext.remove#Microsoft_EntityFrameworkCore_DbContext_Remove_System_Object_) pour définir l’état de l’entité sur `Deleted`.</span><span class="sxs-lookup"><span data-stu-id="ae96e-350">The `OnPostAsync` method retrieves the selected entity, then calls the [Remove](/dotnet/api/microsoft.entityframeworkcore.dbcontext.remove#Microsoft_EntityFrameworkCore_DbContext_Remove_System_Object_) method to set the entity's status to `Deleted`.</span></span> <span data-ttu-id="ae96e-351">Lorsque `SaveChanges` est appelée, une commande SQL DELETE est générée.</span><span class="sxs-lookup"><span data-stu-id="ae96e-351">When `SaveChanges` is called, a SQL DELETE command is generated.</span></span> <span data-ttu-id="ae96e-352">Si `Remove` échoue :</span><span class="sxs-lookup"><span data-stu-id="ae96e-352">If `Remove` fails:</span></span>

* <span data-ttu-id="ae96e-353">L’exception de la base de données est interceptée.</span><span class="sxs-lookup"><span data-stu-id="ae96e-353">The database exception is caught.</span></span>
* <span data-ttu-id="ae96e-354">La méthode de la page de suppression `OnGetAsync` est appelée avec `saveChangesError=true` .</span><span class="sxs-lookup"><span data-stu-id="ae96e-354">The Delete page's `OnGetAsync` method is called with `saveChangesError=true`.</span></span>

<span data-ttu-id="ae96e-355">Ajoutez un message d’erreur à la Razor page de suppression (*pages/élèves/Delete. cshtml*) :</span><span class="sxs-lookup"><span data-stu-id="ae96e-355">Add an error message to the Delete Razor Page (*Pages/Students/Delete.cshtml*):</span></span>

[!code-cshtml[Main](intro/samples/cu30/Pages/Students/Delete.cshtml?highlight=10)]

<span data-ttu-id="ae96e-356">Exécutez l’application et supprimez un étudiant pour tester la page Delete.</span><span class="sxs-lookup"><span data-stu-id="ae96e-356">Run the app and delete a student to test the Delete page.</span></span>

## <a name="next-steps"></a><span data-ttu-id="ae96e-357">Étapes suivantes</span><span class="sxs-lookup"><span data-stu-id="ae96e-357">Next steps</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="ae96e-358">[Didacticiel précédent](xref:data/ef-rp/intro) 
>  [Didacticiel suivant](xref:data/ef-rp/sort-filter-page)</span><span class="sxs-lookup"><span data-stu-id="ae96e-358">[Previous tutorial](xref:data/ef-rp/intro)
[Next tutorial](xref:data/ef-rp/sort-filter-page)</span></span>

::: moniker-end

::: moniker range="< aspnetcore-3.0"

<span data-ttu-id="ae96e-359">Dans ce didacticiel, nous allons examiner et personnaliser le code CRUD (créer, lire, mettre à jour, supprimer) généré automatiquement.</span><span class="sxs-lookup"><span data-stu-id="ae96e-359">In this tutorial, the scaffolded CRUD (create, read, update, delete) code is reviewed and customized.</span></span>

<span data-ttu-id="ae96e-360">Pour que ces tutoriels soient moins complexes et traitent exclusivement d’EF Core, nous avons utilisé le code EF Core dans les modèles de page.</span><span class="sxs-lookup"><span data-stu-id="ae96e-360">To minimize complexity and keep these tutorials focused on EF Core, EF Core code is used in the page models.</span></span> <span data-ttu-id="ae96e-361">Certains développeurs utilisent une couche de service ou un modèle de référentiel dans pour créer une couche d’abstraction entre l’interface utilisateur ( Razor pages) et la couche d’accès aux données.</span><span class="sxs-lookup"><span data-stu-id="ae96e-361">Some developers use a service layer or repository pattern in to create an abstraction layer between the UI (Razor Pages) and the data access layer.</span></span>

<span data-ttu-id="ae96e-362">Dans ce didacticiel, les pages créer, modifier, supprimer et Détails du Razor dossier *students* sont examinées.</span><span class="sxs-lookup"><span data-stu-id="ae96e-362">In this tutorial, the Create, Edit, Delete, and Details Razor Pages in the *Students* folder are examined.</span></span>

<span data-ttu-id="ae96e-363">Le code généré automatiquement utilise le modèle suivant pour les pages Create, Edit et Delete :</span><span class="sxs-lookup"><span data-stu-id="ae96e-363">The scaffolded code uses the following pattern for Create, Edit, and Delete pages:</span></span>

* <span data-ttu-id="ae96e-364">Obtenir et afficher les données demandées avec la méthode HTTP GET `OnGetAsync`.</span><span class="sxs-lookup"><span data-stu-id="ae96e-364">Get and display the requested data with the HTTP GET method `OnGetAsync`.</span></span>
* <span data-ttu-id="ae96e-365">Enregistrer les modifications dans les données avec la méthode HTTP POST `OnPostAsync`.</span><span class="sxs-lookup"><span data-stu-id="ae96e-365">Save changes to the data with the HTTP POST method `OnPostAsync`.</span></span>

<span data-ttu-id="ae96e-366">Les pages Index et Details obtiennent et affichent les données demandées avec la méthode HTTP GET `OnGetAsync`.</span><span class="sxs-lookup"><span data-stu-id="ae96e-366">The Index and Details pages get and display the requested data with the HTTP GET method `OnGetAsync`</span></span>

## <a name="singleordefaultasync-vs-firstordefaultasync"></a><span data-ttu-id="ae96e-367">SingleOrDefaultAsync et FirstOrDefaultAsync</span><span class="sxs-lookup"><span data-stu-id="ae96e-367">SingleOrDefaultAsync vs. FirstOrDefaultAsync</span></span>

<span data-ttu-id="ae96e-368">Le code généré utilise [FirstOrDefaultAsync](/dotnet/api/microsoft.entityframeworkcore.entityframeworkqueryableextensions.firstordefaultasync#Microsoft_EntityFrameworkCore_EntityFrameworkQueryableExtensions_FirstOrDefaultAsync__1_System_Linq_IQueryable___0__System_Threading_CancellationToken_), qui est généralement préféré à [SingleOrDefaultAsync](/dotnet/api/microsoft.entityframeworkcore.entityframeworkqueryableextensions.singleordefaultasync#Microsoft_EntityFrameworkCore_EntityFrameworkQueryableExtensions_SingleOrDefaultAsync__1_System_Linq_IQueryable___0__System_Linq_Expressions_Expression_System_Func___0_System_Boolean___System_Threading_CancellationToken_).</span><span class="sxs-lookup"><span data-stu-id="ae96e-368">The generated code uses [FirstOrDefaultAsync](/dotnet/api/microsoft.entityframeworkcore.entityframeworkqueryableextensions.firstordefaultasync#Microsoft_EntityFrameworkCore_EntityFrameworkQueryableExtensions_FirstOrDefaultAsync__1_System_Linq_IQueryable___0__System_Threading_CancellationToken_), which is generally preferred over [SingleOrDefaultAsync](/dotnet/api/microsoft.entityframeworkcore.entityframeworkqueryableextensions.singleordefaultasync#Microsoft_EntityFrameworkCore_EntityFrameworkQueryableExtensions_SingleOrDefaultAsync__1_System_Linq_IQueryable___0__System_Linq_Expressions_Expression_System_Func___0_System_Boolean___System_Threading_CancellationToken_).</span></span>

 <span data-ttu-id="ae96e-369">`FirstOrDefaultAsync` est plus efficace que `SingleOrDefaultAsync` pour récupérer une entité :</span><span class="sxs-lookup"><span data-stu-id="ae96e-369">`FirstOrDefaultAsync` is more efficient than `SingleOrDefaultAsync` at fetching one entity:</span></span>

* <span data-ttu-id="ae96e-370">Sauf si le code doit vérifier que la requête ne retourne pas plusieurs entités.</span><span class="sxs-lookup"><span data-stu-id="ae96e-370">Unless the code needs to verify that there's not more than one entity returned from the query.</span></span>
* <span data-ttu-id="ae96e-371">`SingleOrDefaultAsync` récupère davantage de données et effectue un travail inutile.</span><span class="sxs-lookup"><span data-stu-id="ae96e-371">`SingleOrDefaultAsync` fetches more data and does unnecessary work.</span></span>
* <span data-ttu-id="ae96e-372">`SingleOrDefaultAsync` lève une exception si plusieurs entités correspondent à la partie filtre.</span><span class="sxs-lookup"><span data-stu-id="ae96e-372">`SingleOrDefaultAsync` throws an exception if there's more than one entity that fits the filter part.</span></span>
* <span data-ttu-id="ae96e-373">`FirstOrDefaultAsync` ne lève pas d’exception si plusieurs entités correspondent à la partie filtre.</span><span class="sxs-lookup"><span data-stu-id="ae96e-373">`FirstOrDefaultAsync` doesn't throw if there's more than one entity that fits the filter part.</span></span>

<a name="FindAsync"></a>

### <a name="findasync"></a><span data-ttu-id="ae96e-374">FindAsync</span><span class="sxs-lookup"><span data-stu-id="ae96e-374">FindAsync</span></span>

<span data-ttu-id="ae96e-375">Dans une grande partie du code généré automatiquement, vous pouvez utiliser [FindAsync](/dotnet/api/microsoft.entityframeworkcore.dbcontext.findasync#Microsoft_EntityFrameworkCore_DbContext_FindAsync_System_Type_System_Object___) à la place de `FirstOrDefaultAsync`.</span><span class="sxs-lookup"><span data-stu-id="ae96e-375">In much of the scaffolded code, [FindAsync](/dotnet/api/microsoft.entityframeworkcore.dbcontext.findasync#Microsoft_EntityFrameworkCore_DbContext_FindAsync_System_Type_System_Object___) can be used in place of `FirstOrDefaultAsync`.</span></span>

<span data-ttu-id="ae96e-376">`FindAsync`:</span><span class="sxs-lookup"><span data-stu-id="ae96e-376">`FindAsync`:</span></span>

* <span data-ttu-id="ae96e-377">Recherche une entité avec la clé primaire.</span><span class="sxs-lookup"><span data-stu-id="ae96e-377">Finds an entity with the primary key (PK).</span></span> <span data-ttu-id="ae96e-378">Si une entité avec la clé primaire est suivie par le contexte, elle est retournée sans qu’une requête soit envoyée à la base de données.</span><span class="sxs-lookup"><span data-stu-id="ae96e-378">If an entity with the PK is being tracked by the context, it's returned without a request to the DB.</span></span>
* <span data-ttu-id="ae96e-379">Est simple et concise.</span><span class="sxs-lookup"><span data-stu-id="ae96e-379">Is simple and concise.</span></span>
* <span data-ttu-id="ae96e-380">Est optimisée pour rechercher une entité unique.</span><span class="sxs-lookup"><span data-stu-id="ae96e-380">Is optimized to look up a single entity.</span></span>
* <span data-ttu-id="ae96e-381">Peut avoir des avantages de performances dans certaines situations, mais c’est rarement le cas pour les applications web standard.</span><span class="sxs-lookup"><span data-stu-id="ae96e-381">Can have perf benefits in some situations, but that rarely happens for typical web apps.</span></span>
* <span data-ttu-id="ae96e-382">Utilise implicitement [FirstAsync](/dotnet/api/microsoft.entityframeworkcore.entityframeworkqueryableextensions.firstasync#Microsoft_EntityFrameworkCore_EntityFrameworkQueryableExtensions_FirstAsync__1_System_Linq_IQueryable___0__System_Linq_Expressions_Expression_System_Func___0_System_Boolean___System_Threading_CancellationToken_) au lieu de [SingleAsync](/dotnet/api/microsoft.entityframeworkcore.entityframeworkqueryableextensions.singleasync#Microsoft_EntityFrameworkCore_EntityFrameworkQueryableExtensions_SingleAsync__1_System_Linq_IQueryable___0__System_Linq_Expressions_Expression_System_Func___0_System_Boolean___System_Threading_CancellationToken_).</span><span class="sxs-lookup"><span data-stu-id="ae96e-382">Implicitly uses [FirstAsync](/dotnet/api/microsoft.entityframeworkcore.entityframeworkqueryableextensions.firstasync#Microsoft_EntityFrameworkCore_EntityFrameworkQueryableExtensions_FirstAsync__1_System_Linq_IQueryable___0__System_Linq_Expressions_Expression_System_Func___0_System_Boolean___System_Threading_CancellationToken_) instead of [SingleAsync](/dotnet/api/microsoft.entityframeworkcore.entityframeworkqueryableextensions.singleasync#Microsoft_EntityFrameworkCore_EntityFrameworkQueryableExtensions_SingleAsync__1_System_Linq_IQueryable___0__System_Linq_Expressions_Expression_System_Func___0_System_Boolean___System_Threading_CancellationToken_).</span></span>

<span data-ttu-id="ae96e-383">Toutefois, si vous voulez exécuter `Include` sur d’autres entités, `FindAsync` n’est plus approprié.</span><span class="sxs-lookup"><span data-stu-id="ae96e-383">But if you want to `Include` other entities, then `FindAsync` is no longer appropriate.</span></span> <span data-ttu-id="ae96e-384">Cela signifie que vous devez peut-être abandonner `FindAsync` et passer à une requête à mesure que votre application progresse.</span><span class="sxs-lookup"><span data-stu-id="ae96e-384">This means that you may need to abandon `FindAsync` and move to a query as your app progresses.</span></span>

## <a name="customize-the-details-page"></a><span data-ttu-id="ae96e-385">Personnaliser la page Details</span><span class="sxs-lookup"><span data-stu-id="ae96e-385">Customize the Details page</span></span>

<span data-ttu-id="ae96e-386">Accédez à la page `Pages/Students`.</span><span class="sxs-lookup"><span data-stu-id="ae96e-386">Browse to `Pages/Students` page.</span></span> <span data-ttu-id="ae96e-387">Les liens **Edit**, **Details**, et **Delete** sont générés par le [Tag helper anchor](xref:mvc/views/tag-helpers/builtin-th/anchor-tag-helper) dans le fichier *Pages/Student/Index.cshtml*.</span><span class="sxs-lookup"><span data-stu-id="ae96e-387">The **Edit**, **Details**, and **Delete** links are generated by the [Anchor Tag Helper](xref:mvc/views/tag-helpers/builtin-th/anchor-tag-helper) in the *Pages/Students/Index.cshtml* file.</span></span>

[!code-cshtml[](intro/samples/cu21/Pages/Students/Index1.cshtml?name=snippet)]

<span data-ttu-id="ae96e-388">Exécutez l’application et sélectionnez un lien **Details**.</span><span class="sxs-lookup"><span data-stu-id="ae96e-388">Run the app and select a **Details** link.</span></span> <span data-ttu-id="ae96e-389">L’URL est au format `http://localhost:5000/Students/Details?id=2`.</span><span class="sxs-lookup"><span data-stu-id="ae96e-389">The URL is of the form `http://localhost:5000/Students/Details?id=2`.</span></span> <span data-ttu-id="ae96e-390">L’ID d’étudiant est transmis à l’aide d’une chaîne de requête (`?id=2`).</span><span class="sxs-lookup"><span data-stu-id="ae96e-390">The Student ID is passed using a query string (`?id=2`).</span></span>

<span data-ttu-id="ae96e-391">Mettez à jour les pages de modification, de détails et Razor de suppression pour utiliser le `"{id:int}"` modèle de routage.</span><span class="sxs-lookup"><span data-stu-id="ae96e-391">Update the Edit, Details, and Delete Razor Pages to use the `"{id:int}"` route template.</span></span> <span data-ttu-id="ae96e-392">Remplacez la directive de chacune de ces pages (`@page "{id:int}"`) par `@page`.</span><span class="sxs-lookup"><span data-stu-id="ae96e-392">Change the page directive for each of these pages from `@page` to `@page "{id:int}"`.</span></span>

<span data-ttu-id="ae96e-393">Une requête à la page avec le modèle de route « {id:int} » qui n’inclut **pas** une valeur de route entière retourne une erreur HTTP 404 (introuvable).</span><span class="sxs-lookup"><span data-stu-id="ae96e-393">A request to the page with the "{id:int}" route template that does **not** include a integer route value returns an HTTP 404 (not found) error.</span></span> <span data-ttu-id="ae96e-394">Par exemple, `http://localhost:5000/Students/Details` retourne une erreur 404.</span><span class="sxs-lookup"><span data-stu-id="ae96e-394">For example, `http://localhost:5000/Students/Details` returns a 404 error.</span></span> <span data-ttu-id="ae96e-395">Pour que l’ID soit facultatif, ajoutez `?` à la contrainte d’itinéraire :</span><span class="sxs-lookup"><span data-stu-id="ae96e-395">To make the ID optional, append `?` to the route constraint:</span></span>

 ```cshtml
@page "{id:int?}"
```

<span data-ttu-id="ae96e-396">Exécutez l’application, cliquez sur un lien Détails et vérifiez que l’URL passe l’ID en tant que données de route (`http://localhost:5000/Students/Details/2`).</span><span class="sxs-lookup"><span data-stu-id="ae96e-396">Run the app, click on a Details link, and verify the URL is passing the ID as route data (`http://localhost:5000/Students/Details/2`).</span></span>

<span data-ttu-id="ae96e-397">Ne changez pas `@page` en `@page "{id:int}"` globalement, cela casserait les liens vers les pages Home et Create.</span><span class="sxs-lookup"><span data-stu-id="ae96e-397">Don't globally change `@page` to `@page "{id:int}"`, doing so breaks the links to the Home and Create pages.</span></span>

<!-- See https://github.com/aspnet/Scaffolding/issues/590 -->

### <a name="add-related-data"></a><span data-ttu-id="ae96e-398">Ajouter des données associées</span><span class="sxs-lookup"><span data-stu-id="ae96e-398">Add related data</span></span>

<span data-ttu-id="ae96e-399">Le code généré automatiquement pour la page Index des étudiants n’inclut pas la propriété `Enrollments`.</span><span class="sxs-lookup"><span data-stu-id="ae96e-399">The scaffolded code for the Students Index page doesn't include the `Enrollments` property.</span></span> <span data-ttu-id="ae96e-400">Dans cette section, le contenu de la collection `Enrollments` s’affiche dans la page Details.</span><span class="sxs-lookup"><span data-stu-id="ae96e-400">In this section, the contents of the `Enrollments` collection is displayed in the Details page.</span></span>

<span data-ttu-id="ae96e-401">Le méthode `OnGetAsync` de *Pages/Students/Details.cshtml.cs* utilise la méthode `FirstOrDefaultAsync` pour récupérer une seule entité `Student`.</span><span class="sxs-lookup"><span data-stu-id="ae96e-401">The `OnGetAsync` method of *Pages/Students/Details.cshtml.cs* uses the `FirstOrDefaultAsync` method to retrieve a single `Student` entity.</span></span> <span data-ttu-id="ae96e-402">Ajoutez le code en surbrillance suivant :</span><span class="sxs-lookup"><span data-stu-id="ae96e-402">Add the following highlighted code:</span></span>

[!code-csharp[](intro/samples/cu21/Pages/Students/Details.cshtml.cs?name=snippet_Details&highlight=8-12)]

<span data-ttu-id="ae96e-403">Les méthodes [Include](/dotnet/api/microsoft.entityframeworkcore.entityframeworkqueryableextensions.include) et [ThenInclude](/dotnet/api/microsoft.entityframeworkcore.entityframeworkqueryableextensions.theninclude#Microsoft_EntityFrameworkCore_EntityFrameworkQueryableExtensions_ThenInclude__3_Microsoft_EntityFrameworkCore_Query_IIncludableQueryable___0_System_Collections_Generic_IEnumerable___1___System_Linq_Expressions_Expression_System_Func___1___2___) forcent le contexte à charger la propriété de navigation `Student.Enrollments` et, dans chaque inscription, la propriété de navigation `Enrollment.Course`.</span><span class="sxs-lookup"><span data-stu-id="ae96e-403">The [Include](/dotnet/api/microsoft.entityframeworkcore.entityframeworkqueryableextensions.include) and [ThenInclude](/dotnet/api/microsoft.entityframeworkcore.entityframeworkqueryableextensions.theninclude#Microsoft_EntityFrameworkCore_EntityFrameworkQueryableExtensions_ThenInclude__3_Microsoft_EntityFrameworkCore_Query_IIncludableQueryable___0_System_Collections_Generic_IEnumerable___1___System_Linq_Expressions_Expression_System_Func___1___2___) methods cause the context to load the `Student.Enrollments` navigation property, and within each enrollment the `Enrollment.Course` navigation property.</span></span> <span data-ttu-id="ae96e-404">Ces méthodes sont examinées en détail dans le tutoriel sur la lecture des données associées.</span><span class="sxs-lookup"><span data-stu-id="ae96e-404">These methods are examined in detail in the reading-related data tutorial.</span></span>

<span data-ttu-id="ae96e-405">La méthode [AsNoTracking](/dotnet/api/microsoft.entityframeworkcore.entityframeworkqueryableextensions.asnotracking#Microsoft_EntityFrameworkCore_EntityFrameworkQueryableExtensions_AsNoTracking__1_System_Linq_IQueryable___0__) améliore les performances dans les scénarios où les entités retournées ne sont pas mises à jour dans le contexte actuel.</span><span class="sxs-lookup"><span data-stu-id="ae96e-405">The [AsNoTracking](/dotnet/api/microsoft.entityframeworkcore.entityframeworkqueryableextensions.asnotracking#Microsoft_EntityFrameworkCore_EntityFrameworkQueryableExtensions_AsNoTracking__1_System_Linq_IQueryable___0__) method improves performance in scenarios when the entities returned are not updated in the current context.</span></span> <span data-ttu-id="ae96e-406">Le sujet `AsNoTracking` est abordé plus loin dans ce didacticiel.</span><span class="sxs-lookup"><span data-stu-id="ae96e-406">`AsNoTracking` is discussed later in this tutorial.</span></span>

### <a name="display-related-enrollments-on-the-details-page"></a><span data-ttu-id="ae96e-407">Afficher les inscriptions associées sur la page Details</span><span class="sxs-lookup"><span data-stu-id="ae96e-407">Display related enrollments on the Details page</span></span>

<span data-ttu-id="ae96e-408">Ouvrez *Pages/Students/Details.cshtml*.</span><span class="sxs-lookup"><span data-stu-id="ae96e-408">Open *Pages/Students/Details.cshtml*.</span></span> <span data-ttu-id="ae96e-409">Ajoutez le code en surbrillance suivant pour afficher la liste des inscriptions :</span><span class="sxs-lookup"><span data-stu-id="ae96e-409">Add the following highlighted code to display a list of enrollments:</span></span>

[!code-cshtml[](intro/samples/cu21/Pages/Students/Details.cshtml?highlight=32-53)]

<span data-ttu-id="ae96e-410">Si la mise en retrait du code est incorrecte, une fois que le code est collé, appuyez sur CTRL + K + D pour résoudre ce problème.</span><span class="sxs-lookup"><span data-stu-id="ae96e-410">If code indentation is wrong after the code is pasted, press CTRL-K-D to correct it.</span></span>

<span data-ttu-id="ae96e-411">Le code précédent effectue une itération sur les entités dans la propriété de navigation `Enrollments`.</span><span class="sxs-lookup"><span data-stu-id="ae96e-411">The preceding code loops through the entities in the `Enrollments` navigation property.</span></span> <span data-ttu-id="ae96e-412">Pour chaque inscription, il affiche le titre du cours et le niveau.</span><span class="sxs-lookup"><span data-stu-id="ae96e-412">For each enrollment, it displays the course title and the grade.</span></span> <span data-ttu-id="ae96e-413">Le titre du cours est récupéré à partir de l’entité de cours qui est stockée dans la propriété de navigation `Course` de l’entité Enrollments.</span><span class="sxs-lookup"><span data-stu-id="ae96e-413">The course title is retrieved from the Course entity that's stored in the `Course` navigation property of the Enrollments entity.</span></span>

<span data-ttu-id="ae96e-414">Exécutez l’application, sélectionnez l’onglet **Students**, puis cliquez sur le lien **Details** pour un étudiant.</span><span class="sxs-lookup"><span data-stu-id="ae96e-414">Run the app, select the **Students** tab, and click the **Details** link for a student.</span></span> <span data-ttu-id="ae96e-415">La liste des cours et les notes de l’étudiant sélectionné s’affiche.</span><span class="sxs-lookup"><span data-stu-id="ae96e-415">The list of courses and grades for the selected student is displayed.</span></span>

## <a name="update-the-create-page"></a><span data-ttu-id="ae96e-416">Mettre à jour la page Create</span><span class="sxs-lookup"><span data-stu-id="ae96e-416">Update the Create page</span></span>

<span data-ttu-id="ae96e-417">Mettez à jour la méthode `OnPostAsync` dans *Pages/Students/Create.cshtml.cs* avec le code suivant :</span><span class="sxs-lookup"><span data-stu-id="ae96e-417">Update the `OnPostAsync` method in *Pages/Students/Create.cshtml.cs* with the following code:</span></span>

[!code-csharp[](intro/samples/cu21/Pages/Students/Create.cshtml.cs?name=snippet_OnPostAsync)]

<a name="TryUpdateModelAsync"></a>

### <a name="tryupdatemodelasync"></a><span data-ttu-id="ae96e-418">TryUpdateModelAsync</span><span class="sxs-lookup"><span data-stu-id="ae96e-418">TryUpdateModelAsync</span></span>

<span data-ttu-id="ae96e-419">Examinez le code [TryUpdateModelAsync](/dotnet/api/microsoft.aspnetcore.mvc.controllerbase.tryupdatemodelasync#Microsoft_AspNetCore_Mvc_ControllerBase_TryUpdateModelAsync_System_Object_System_Type_System_String_) :</span><span class="sxs-lookup"><span data-stu-id="ae96e-419">Examine the [TryUpdateModelAsync](/dotnet/api/microsoft.aspnetcore.mvc.controllerbase.tryupdatemodelasync#Microsoft_AspNetCore_Mvc_ControllerBase_TryUpdateModelAsync_System_Object_System_Type_System_String_) code:</span></span>

[!code-csharp[](intro/samples/cu21/Pages/Students/Create.cshtml.cs?name=snippet_TryUpdateModelAsync)]

<span data-ttu-id="ae96e-420">Dans le code précédent, `TryUpdateModelAsync<Student>` tente de mettre à jour l’objet `emptyStudent` en utilisant les valeurs de formulaire publiées à partir de la propriété [PageContext](/dotnet/api/microsoft.aspnetcore.mvc.razorpages.pagemodel.pagecontext#Microsoft_AspNetCore_Mvc_RazorPages_PageModel_PageContext) dans le [PageModel](/dotnet/api/microsoft.aspnetcore.mvc.razorpages.pagemodel).</span><span class="sxs-lookup"><span data-stu-id="ae96e-420">In the preceding code, `TryUpdateModelAsync<Student>` tries to update the `emptyStudent` object using the posted form values from the [PageContext](/dotnet/api/microsoft.aspnetcore.mvc.razorpages.pagemodel.pagecontext#Microsoft_AspNetCore_Mvc_RazorPages_PageModel_PageContext) property in the [PageModel](/dotnet/api/microsoft.aspnetcore.mvc.razorpages.pagemodel).</span></span> <span data-ttu-id="ae96e-421">`TryUpdateModelAsync` met uniquement à jour les propriétés répertoriées (`s => s.FirstMidName, s => s.LastName, s => s.EnrollmentDate`).</span><span class="sxs-lookup"><span data-stu-id="ae96e-421">`TryUpdateModelAsync` only updates the properties listed (`s => s.FirstMidName, s => s.LastName, s => s.EnrollmentDate`).</span></span>

<span data-ttu-id="ae96e-422">Dans l’exemple précédent :</span><span class="sxs-lookup"><span data-stu-id="ae96e-422">In the preceding sample:</span></span>

* <span data-ttu-id="ae96e-423">Le deuxième argument (`"student", // Prefix`) est le préfixe utilisé pour rechercher des valeurs.</span><span class="sxs-lookup"><span data-stu-id="ae96e-423">The second argument (`"student", // Prefix`) is the prefix uses to look up values.</span></span> <span data-ttu-id="ae96e-424">Il ne respecte pas la casse.</span><span class="sxs-lookup"><span data-stu-id="ae96e-424">It's not case sensitive.</span></span>
* <span data-ttu-id="ae96e-425">Les valeurs de formulaire publiées sont converties vers les types dans le modèle `Student` à l’aide de la [liaison de modèle](xref:mvc/models/model-binding).</span><span class="sxs-lookup"><span data-stu-id="ae96e-425">The posted form values are converted to the types in the `Student` model using [model binding](xref:mvc/models/model-binding).</span></span>

<a id="overpost"></a>

### <a name="overposting"></a><span data-ttu-id="ae96e-426">Sur-publication</span><span class="sxs-lookup"><span data-stu-id="ae96e-426">Overposting</span></span>

<span data-ttu-id="ae96e-427">L’utilisation de `TryUpdateModel` pour mettre à jour des champs avec des valeurs publiées est une bonne pratique de sécurité, car cela empêche la sur-publication.</span><span class="sxs-lookup"><span data-stu-id="ae96e-427">Using `TryUpdateModel` to update fields with posted values is a security best practice because it prevents overposting.</span></span> <span data-ttu-id="ae96e-428">Par exemple, supposez que l’entité Student comprend une propriété `Secret` que cette page web ne doit pas mettre à jour ou ajouter :</span><span class="sxs-lookup"><span data-stu-id="ae96e-428">For example, suppose the Student entity includes a `Secret` property that this web page shouldn't update or add:</span></span>

[!code-csharp[](intro/samples/cu21/Models/StudentZsecret.cs?name=snippet_Intro&highlight=7)]

<span data-ttu-id="ae96e-429">Même si l’application n’a pas de `Secret` champ dans la page de création/mise à jour Razor , un pirate peut définir la `Secret` valeur par la survalidation.</span><span class="sxs-lookup"><span data-stu-id="ae96e-429">Even if the app doesn't have a `Secret` field on the create/update Razor Page, a hacker could set the `Secret` value by overposting.</span></span> <span data-ttu-id="ae96e-430">Un pirate pourrait utiliser un outil tel que Fiddler, ou écrire du JavaScript, pour publier une valeur de formulaire `Secret`.</span><span class="sxs-lookup"><span data-stu-id="ae96e-430">A hacker could use a tool such as Fiddler, or write some JavaScript, to post a `Secret` form value.</span></span> <span data-ttu-id="ae96e-431">Le code d’origine ne limite pas les champs que le classeur de modèles utilise quand il crée une instance de Student.</span><span class="sxs-lookup"><span data-stu-id="ae96e-431">The original code doesn't limit the fields that the model binder uses when it creates a Student instance.</span></span>

<span data-ttu-id="ae96e-432">La valeur spécifiée par le pirate pour le champ de formulaire `Secret`, quelle qu’elle soit, est mise à jour dans la base de données.</span><span class="sxs-lookup"><span data-stu-id="ae96e-432">Whatever value the hacker specified for the `Secret` form field is updated in the DB.</span></span> <span data-ttu-id="ae96e-433">L’illustration suivante montre l’outil Fiddler en train d’ajouter le champ `Secret` (avec la valeur « OverPost ») aux valeurs du formulaire envoyé.</span><span class="sxs-lookup"><span data-stu-id="ae96e-433">The following image shows the Fiddler tool adding the `Secret` field (with the value "OverPost") to the posted form values.</span></span>

![Fiddler ajoutant un champ Secret](../ef-mvc/crud/_static/fiddler.png)

<span data-ttu-id="ae96e-435">La valeur « OverPost » est ajoutée avec succès à la propriété `Secret` de la ligne insérée.</span><span class="sxs-lookup"><span data-stu-id="ae96e-435">The value "OverPost" is successfully added to the `Secret` property of the inserted row.</span></span> <span data-ttu-id="ae96e-436">Le concepteur de l’application n’a jamais prévu que la propriété `Secret` soit définie avec la page Create.</span><span class="sxs-lookup"><span data-stu-id="ae96e-436">The app designer never intended the `Secret` property to be set with the Create page.</span></span>

<a name="vm"></a>

### <a name="view-model"></a><span data-ttu-id="ae96e-437">Afficher le modèle</span><span class="sxs-lookup"><span data-stu-id="ae96e-437">View model</span></span>

<span data-ttu-id="ae96e-438">Un modèle d’affichage contient généralement un sous-ensemble des propriétés incluses dans le modèle utilisé par l’application.</span><span class="sxs-lookup"><span data-stu-id="ae96e-438">A view model typically contains a subset of the properties included in the model used by the application.</span></span> <span data-ttu-id="ae96e-439">Le modèle d’application est souvent appelé modèle de domaine.</span><span class="sxs-lookup"><span data-stu-id="ae96e-439">The application model is often called the domain model.</span></span> <span data-ttu-id="ae96e-440">En règle générale, le modèle de domaine contient toutes les propriétés requises par l’entité correspondante dans la base de données.</span><span class="sxs-lookup"><span data-stu-id="ae96e-440">The domain model typically contains all the properties required by the corresponding entity in the DB.</span></span> <span data-ttu-id="ae96e-441">Le modèle d’affichage contient uniquement les propriétés nécessaires pour la couche d’interface utilisateur (par exemple, la page Create).</span><span class="sxs-lookup"><span data-stu-id="ae96e-441">The view model contains only the properties needed for the UI layer (for example, the Create page).</span></span> <span data-ttu-id="ae96e-442">Outre le modèle de vue, certaines applications utilisent un modèle de liaison ou un modèle d’entrée pour passer des données entre la Razor classe de modèle de page pages et le navigateur.</span><span class="sxs-lookup"><span data-stu-id="ae96e-442">In addition to the view model, some apps use a binding model or input model to pass data between the Razor Pages page model class and the browser.</span></span> <span data-ttu-id="ae96e-443">Considérez le modèle d’affichage `Student` suivant :</span><span class="sxs-lookup"><span data-stu-id="ae96e-443">Consider the following `Student` view model:</span></span>

[!code-csharp[](intro/samples/cu21/Models/StudentVM.cs)]

<span data-ttu-id="ae96e-444">Les modèles d’affichage fournissent une alternative pour empêcher la sur-publication.</span><span class="sxs-lookup"><span data-stu-id="ae96e-444">View models provide an alternative way to prevent overposting.</span></span> <span data-ttu-id="ae96e-445">Le modèle d’affichage contient uniquement les propriétés à afficher ou à mettre à jour.</span><span class="sxs-lookup"><span data-stu-id="ae96e-445">The view model contains only the properties to view (display) or update.</span></span>

<span data-ttu-id="ae96e-446">Le code suivant utilise le modèle d’affichage `StudentVM` pour créer un étudiant :</span><span class="sxs-lookup"><span data-stu-id="ae96e-446">The following code uses the `StudentVM` view model to create a new student:</span></span>

[!code-csharp[](intro/samples/cu21/Pages/Students/CreateVM.cshtml.cs?name=snippet_OnPostAsync)]

<span data-ttu-id="ae96e-447">La méthode [SetValues](/dotnet/api/microsoft.entityframeworkcore.changetracking.propertyvalues.setvalues#Microsoft_EntityFrameworkCore_ChangeTracking_PropertyValues_SetValues_System_Object_) définit les valeurs de cet objet en lisant les valeurs d’un autre objet [PropertyValues](/dotnet/api/microsoft.entityframeworkcore.changetracking.propertyvalues).</span><span class="sxs-lookup"><span data-stu-id="ae96e-447">The [SetValues](/dotnet/api/microsoft.entityframeworkcore.changetracking.propertyvalues.setvalues#Microsoft_EntityFrameworkCore_ChangeTracking_PropertyValues_SetValues_System_Object_) method sets the values of this object by reading values from another [PropertyValues](/dotnet/api/microsoft.entityframeworkcore.changetracking.propertyvalues) object.</span></span> <span data-ttu-id="ae96e-448">`SetValues` utilise la correspondance de nom de propriété.</span><span class="sxs-lookup"><span data-stu-id="ae96e-448">`SetValues` uses property name matching.</span></span> <span data-ttu-id="ae96e-449">Le type de modèle d’affichage ne doit pas nécessairement être lié au type de modèle. Il doit simplement avoir des propriétés qui correspondent.</span><span class="sxs-lookup"><span data-stu-id="ae96e-449">The view model type doesn't need to be related to the model type, it just needs to have properties that match.</span></span>

<span data-ttu-id="ae96e-450">L’utilisation de `StudentVM` exige que [CreateVM.cshtml](https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/data/ef-rp/intro/samples/cu21/Pages/Students/CreateVM.cshtml) soit mis à jour pour utiliser `StudentVM` plutôt que `Student`.</span><span class="sxs-lookup"><span data-stu-id="ae96e-450">Using `StudentVM` requires [CreateVM.cshtml](https://github.com/dotnet/AspNetCore.Docs/tree/master/aspnetcore/data/ef-rp/intro/samples/cu21/Pages/Students/CreateVM.cshtml) be updated to use `StudentVM` rather than `Student`.</span></span>

<span data-ttu-id="ae96e-451">Dans les Razor pages, la `PageModel` classe dérivée est le modèle de vue.</span><span class="sxs-lookup"><span data-stu-id="ae96e-451">In Razor Pages, the `PageModel` derived class is the view model.</span></span>

## <a name="update-the-edit-page"></a><span data-ttu-id="ae96e-452">Mettre à jour la page Edit</span><span class="sxs-lookup"><span data-stu-id="ae96e-452">Update the Edit page</span></span>

<span data-ttu-id="ae96e-453">Mettez à jour le modèle de page pour la page Edit.</span><span class="sxs-lookup"><span data-stu-id="ae96e-453">Update the page model for the Edit page.</span></span> <span data-ttu-id="ae96e-454">Les modifications principales apparaissent en surbrillance :</span><span class="sxs-lookup"><span data-stu-id="ae96e-454">The major changes are highlighted:</span></span>

[!code-csharp[](intro/samples/cu21/Pages/Students/Edit.cshtml.cs?name=snippet_OnPostAsync&highlight=20,36)]

<span data-ttu-id="ae96e-455">Les modifications de code sont semblables à celles de la page Create, à quelques exceptions près :</span><span class="sxs-lookup"><span data-stu-id="ae96e-455">The code changes are similar to the Create page with a few exceptions:</span></span>

* <span data-ttu-id="ae96e-456">`OnPostAsync` a un paramètre facultatif `id`.</span><span class="sxs-lookup"><span data-stu-id="ae96e-456">`OnPostAsync` has an optional `id` parameter.</span></span>
* <span data-ttu-id="ae96e-457">L’étudiant actuel est récupéré à partir de la base de données (on ne crée pas un étudiant vide).</span><span class="sxs-lookup"><span data-stu-id="ae96e-457">The current student is fetched from the DB, rather than creating an empty student.</span></span>
* <span data-ttu-id="ae96e-458">`FirstOrDefaultAsync` a été remplacée par [FindAsync](/dotnet/api/microsoft.entityframeworkcore.dbset-1.findasync).</span><span class="sxs-lookup"><span data-stu-id="ae96e-458">`FirstOrDefaultAsync` has been replaced with [FindAsync](/dotnet/api/microsoft.entityframeworkcore.dbset-1.findasync).</span></span> <span data-ttu-id="ae96e-459">`FindAsync` est un bon choix lors de la sélection d’une entité à partir de la clé primaire.</span><span class="sxs-lookup"><span data-stu-id="ae96e-459">`FindAsync` is a good choice when selecting an entity from the primary key.</span></span> <span data-ttu-id="ae96e-460">Pour plus d’informations, consultez [FindAsync](#FindAsync).</span><span class="sxs-lookup"><span data-stu-id="ae96e-460">See [FindAsync](#FindAsync) for more information.</span></span>

### <a name="test-the-edit-and-create-pages"></a><span data-ttu-id="ae96e-461">Tester les pages Edit et Create</span><span class="sxs-lookup"><span data-stu-id="ae96e-461">Test the Edit and Create pages</span></span>

<span data-ttu-id="ae96e-462">Créez et modifiez quelques entités d’étudiants.</span><span class="sxs-lookup"><span data-stu-id="ae96e-462">Create and edit a few student entities.</span></span>

## <a name="entity-states"></a><span data-ttu-id="ae96e-463">États des entités</span><span class="sxs-lookup"><span data-stu-id="ae96e-463">Entity States</span></span>

<span data-ttu-id="ae96e-464">Le contexte de base de données effectue un suivi afin de savoir si les entités en mémoire sont synchronisées avec les lignes correspondantes dans la base de données.</span><span class="sxs-lookup"><span data-stu-id="ae96e-464">The DB context keeps track of whether entities in memory are in sync with their corresponding rows in the DB.</span></span> <span data-ttu-id="ae96e-465">Les informations de synchronisation du contexte de base de données déterminent ce qui se produit quand [SaveChangesAsync](/dotnet/api/microsoft.entityframeworkcore.dbcontext.savechangesasync#Microsoft_EntityFrameworkCore_DbContext_SaveChangesAsync_System_Threading_CancellationToken_) est appelé.</span><span class="sxs-lookup"><span data-stu-id="ae96e-465">The DB context sync information determines what happens when [SaveChangesAsync](/dotnet/api/microsoft.entityframeworkcore.dbcontext.savechangesasync#Microsoft_EntityFrameworkCore_DbContext_SaveChangesAsync_System_Threading_CancellationToken_) is called.</span></span> <span data-ttu-id="ae96e-466">Par exemple, quand une nouvelle entité est passée à la méthode [AddAsync](/dotnet/api/microsoft.entityframeworkcore.dbcontext.addasync), l’état de cette entité est défini sur [Added](/dotnet/api/microsoft.entityframeworkcore.entitystate#Microsoft_EntityFrameworkCore_EntityState_Added).</span><span class="sxs-lookup"><span data-stu-id="ae96e-466">For example, when a new entity is passed to the [AddAsync](/dotnet/api/microsoft.entityframeworkcore.dbcontext.addasync) method, that entity's state is set to [Added](/dotnet/api/microsoft.entityframeworkcore.entitystate#Microsoft_EntityFrameworkCore_EntityState_Added).</span></span> <span data-ttu-id="ae96e-467">Quand `SaveChangesAsync` est appelée, le contexte de base de données émet une commande SQL INSERT.</span><span class="sxs-lookup"><span data-stu-id="ae96e-467">When `SaveChangesAsync` is called, the DB context issues a SQL INSERT command.</span></span>

<span data-ttu-id="ae96e-468">Une entité peut être dans l’un des [États suivants](/dotnet/api/microsoft.entityframeworkcore.entitystate):</span><span class="sxs-lookup"><span data-stu-id="ae96e-468">An entity may be in one of the [following states](/dotnet/api/microsoft.entityframeworkcore.entitystate):</span></span>

* <span data-ttu-id="ae96e-469">`Added` : L’entité n’existe pas encore dans la base de données.</span><span class="sxs-lookup"><span data-stu-id="ae96e-469">`Added`: The entity doesn't yet exist in the DB.</span></span> <span data-ttu-id="ae96e-470">La méthode `SaveChanges` émet une instruction INSERT.</span><span class="sxs-lookup"><span data-stu-id="ae96e-470">The `SaveChanges` method issues an INSERT statement.</span></span>

* <span data-ttu-id="ae96e-471">`Unchanged` : Aucune modification ne doit être enregistrée avec cette entité.</span><span class="sxs-lookup"><span data-stu-id="ae96e-471">`Unchanged`: No changes need to be saved with this entity.</span></span> <span data-ttu-id="ae96e-472">Une entité est dans cet état quand elle est lue à partir de la base de données.</span><span class="sxs-lookup"><span data-stu-id="ae96e-472">An entity has this status when it's read from the DB.</span></span>

* <span data-ttu-id="ae96e-473">`Modified` : Tout ou une partie des valeurs de propriété de l’entité ont été modifiées.</span><span class="sxs-lookup"><span data-stu-id="ae96e-473">`Modified`: Some or all of the entity's property values have been modified.</span></span> <span data-ttu-id="ae96e-474">La méthode `SaveChanges` émet une instruction UPDATE.</span><span class="sxs-lookup"><span data-stu-id="ae96e-474">The `SaveChanges` method issues an UPDATE statement.</span></span>

* <span data-ttu-id="ae96e-475">`Deleted` : L’entité a été marquée pour suppression.</span><span class="sxs-lookup"><span data-stu-id="ae96e-475">`Deleted`: The entity has been marked for deletion.</span></span> <span data-ttu-id="ae96e-476">La méthode `SaveChanges` émet une instruction DELETE.</span><span class="sxs-lookup"><span data-stu-id="ae96e-476">The `SaveChanges` method issues a DELETE statement.</span></span>

* <span data-ttu-id="ae96e-477">`Detached` : L’entité n’est pas suivie par le contexte de base de données.</span><span class="sxs-lookup"><span data-stu-id="ae96e-477">`Detached`: The entity isn't being tracked by the DB context.</span></span>

<span data-ttu-id="ae96e-478">Dans une application de bureau, les changements d’état sont généralement définis automatiquement.</span><span class="sxs-lookup"><span data-stu-id="ae96e-478">In a desktop app, state changes are typically set automatically.</span></span> <span data-ttu-id="ae96e-479">Une entité est lue, des modifications sont apportées et l’état d’entité passe automatiquement à `Modified`.</span><span class="sxs-lookup"><span data-stu-id="ae96e-479">An entity is read, changes are made, and the entity state to automatically be changed to `Modified`.</span></span> <span data-ttu-id="ae96e-480">L’appel de `SaveChanges` génère une instruction SQL UPDATE qui met à jour uniquement les propriétés modifiées.</span><span class="sxs-lookup"><span data-stu-id="ae96e-480">Calling `SaveChanges` generates a SQL UPDATE statement that updates only the changed properties.</span></span>

<span data-ttu-id="ae96e-481">Dans une application web, le `DbContext` qui lit une entité et affiche les données est supprimé après le rendu d’une page.</span><span class="sxs-lookup"><span data-stu-id="ae96e-481">In a web app, the `DbContext` that reads an entity and displays the data is disposed after a page is rendered.</span></span> <span data-ttu-id="ae96e-482">Quand la méthode `OnPostAsync` d’une page est appelée, une nouvelle requête web est faite avec une nouvelle instance du `DbContext`.</span><span class="sxs-lookup"><span data-stu-id="ae96e-482">When a page's `OnPostAsync` method is called, a new web request is made and with a new instance of the `DbContext`.</span></span> <span data-ttu-id="ae96e-483">La relecture de l’entité dans ce nouveau contexte simule le traitement de bureau.</span><span class="sxs-lookup"><span data-stu-id="ae96e-483">Re-reading the entity in that new context simulates desktop processing.</span></span>

## <a name="update-the-delete-page"></a><span data-ttu-id="ae96e-484">Mettre à jour la page Delete</span><span class="sxs-lookup"><span data-stu-id="ae96e-484">Update the Delete page</span></span>

<span data-ttu-id="ae96e-485">Dans cette section, nous ajoutons du code pour implémenter un message d’erreur personnalisé quand l’appel à `SaveChanges` échoue.</span><span class="sxs-lookup"><span data-stu-id="ae96e-485">In this section, code is added to implement a custom error message when the call to `SaveChanges` fails.</span></span> <span data-ttu-id="ae96e-486">Ajoutez une chaîne contenant les messages d’erreur possibles :</span><span class="sxs-lookup"><span data-stu-id="ae96e-486">Add a string to contain possible error messages:</span></span>

[!code-csharp[](intro/samples/cu21/Pages/Students/Delete.cshtml.cs?name=snippet1&highlight=12)]

<span data-ttu-id="ae96e-487">Remplacez la méthode `OnGetAsync` par le code suivant :</span><span class="sxs-lookup"><span data-stu-id="ae96e-487">Replace the `OnGetAsync` method with the following code:</span></span>

[!code-csharp[](intro/samples/cu21/Pages/Students/Delete.cshtml.cs?name=snippet_OnGetAsync&highlight=1,9,17-20)]

<span data-ttu-id="ae96e-488">Le code précédent contient le paramètre facultatif `saveChangesError`.</span><span class="sxs-lookup"><span data-stu-id="ae96e-488">The preceding code contains the optional parameter `saveChangesError`.</span></span> <span data-ttu-id="ae96e-489">`saveChangesError` indique si la méthode a été appelée après un échec de suppression de l’objet Student.</span><span class="sxs-lookup"><span data-stu-id="ae96e-489">`saveChangesError` indicates whether the method was called after a failure to delete the student object.</span></span> <span data-ttu-id="ae96e-490">L’opération de suppression peut échouer en raison de problèmes réseau temporaires.</span><span class="sxs-lookup"><span data-stu-id="ae96e-490">The delete operation might fail because of transient network problems.</span></span> <span data-ttu-id="ae96e-491">Les erreurs réseau temporaires sont probablement dans le cloud.</span><span class="sxs-lookup"><span data-stu-id="ae96e-491">Transient network errors are more likely in the cloud.</span></span> <span data-ttu-id="ae96e-492">`saveChangesError` a la valeur false quand la méthode `OnGetAsync` de la page Delete est appelée à partir de l’interface utilisateur.</span><span class="sxs-lookup"><span data-stu-id="ae96e-492">`saveChangesError`is false when the Delete page `OnGetAsync` is called from the UI.</span></span> <span data-ttu-id="ae96e-493">Quand `OnGetAsync` est appelée par `OnPostAsync` (car l’opération de suppression a échoué), le paramètre `saveChangesError` a la valeur true.</span><span class="sxs-lookup"><span data-stu-id="ae96e-493">When `OnGetAsync` is called by `OnPostAsync` (because the delete operation failed), the `saveChangesError` parameter is true.</span></span>

### <a name="the-delete-pages-onpostasync-method"></a><span data-ttu-id="ae96e-494">La méthode OnPostAsync des pages Delete</span><span class="sxs-lookup"><span data-stu-id="ae96e-494">The Delete pages OnPostAsync method</span></span>

<span data-ttu-id="ae96e-495">Remplacez `OnPostAsync` par le code suivant :</span><span class="sxs-lookup"><span data-stu-id="ae96e-495">Replace the `OnPostAsync` with the following code:</span></span>

[!code-csharp[](intro/samples/cu21/Pages/Students/Delete.cshtml.cs?name=snippet_OnPostAsync)]

<span data-ttu-id="ae96e-496">Le code précédent récupère l’entité sélectionnée, puis appelle la méthode [Remove](/dotnet/api/microsoft.entityframeworkcore.dbcontext.remove#Microsoft_EntityFrameworkCore_DbContext_Remove_System_Object_) pour définir l’état de l’entité sur `Deleted`.</span><span class="sxs-lookup"><span data-stu-id="ae96e-496">The preceding code retrieves the selected entity, then calls the [Remove](/dotnet/api/microsoft.entityframeworkcore.dbcontext.remove#Microsoft_EntityFrameworkCore_DbContext_Remove_System_Object_) method to set the entity's status to `Deleted`.</span></span> <span data-ttu-id="ae96e-497">Lorsque `SaveChanges` est appelée, une commande SQL DELETE est générée.</span><span class="sxs-lookup"><span data-stu-id="ae96e-497">When `SaveChanges` is called, a SQL DELETE command is generated.</span></span> <span data-ttu-id="ae96e-498">Si `Remove` échoue :</span><span class="sxs-lookup"><span data-stu-id="ae96e-498">If `Remove` fails:</span></span>

* <span data-ttu-id="ae96e-499">L’exception de la base de données est interceptée.</span><span class="sxs-lookup"><span data-stu-id="ae96e-499">The DB exception is caught.</span></span>
* <span data-ttu-id="ae96e-500">La méthode `OnGetAsync` des pages est appelée avec `saveChangesError=true`.</span><span class="sxs-lookup"><span data-stu-id="ae96e-500">The Delete pages `OnGetAsync` method is called with `saveChangesError=true`.</span></span>

### <a name="update-the-delete-no-locrazor-page"></a><span data-ttu-id="ae96e-501">Mettre à jour la page de suppression Razor</span><span class="sxs-lookup"><span data-stu-id="ae96e-501">Update the Delete Razor Page</span></span>

<span data-ttu-id="ae96e-502">Ajoutez le message d’erreur en surbrillance suivant à la page de suppression Razor .</span><span class="sxs-lookup"><span data-stu-id="ae96e-502">Add the following highlighted error message to the Delete Razor Page.</span></span>
<!--
[!code-cshtml[](intro/samples/cu21/Pages/Students/Delete.cshtml?name=snippet&highlight=11)]
-->
[!code-cshtml[](intro/samples/cu21/Pages/Students/Delete.cshtml?range=1-13&highlight=10)]

<span data-ttu-id="ae96e-503">Testez la suppression.</span><span class="sxs-lookup"><span data-stu-id="ae96e-503">Test Delete.</span></span>

## <a name="common-errors"></a><span data-ttu-id="ae96e-504">Erreurs courantes</span><span class="sxs-lookup"><span data-stu-id="ae96e-504">Common errors</span></span>

<span data-ttu-id="ae96e-505">Students/Index ou d’autres liens ne fonctionnent pas :</span><span class="sxs-lookup"><span data-stu-id="ae96e-505">Students/Index or other links don't work:</span></span>

<span data-ttu-id="ae96e-506">Vérifiez que la Razor page contient la `@page` directive correcte.</span><span class="sxs-lookup"><span data-stu-id="ae96e-506">Verify the Razor Page contains the correct `@page` directive.</span></span> <span data-ttu-id="ae96e-507">Par exemple, la page Students/index ne Razor doit **pas** contenir de modèle de routage :</span><span class="sxs-lookup"><span data-stu-id="ae96e-507">For example, The Students/Index Razor Page should **not** contain a route template:</span></span>

```cshtml
@page "{id:int}"
```

<span data-ttu-id="ae96e-508">Chaque Razor page doit inclure la `@page` directive.</span><span class="sxs-lookup"><span data-stu-id="ae96e-508">Each Razor Page must include the `@page` directive.</span></span>



## <a name="additional-resources"></a><span data-ttu-id="ae96e-509">Ressources supplémentaires</span><span class="sxs-lookup"><span data-stu-id="ae96e-509">Additional resources</span></span>

* [<span data-ttu-id="ae96e-510">Version YouTube de ce tutoriel</span><span class="sxs-lookup"><span data-stu-id="ae96e-510">YouTube version of this tutorial</span></span>](https://www.youtube.com/watch?v=K4X1MT2jt6o)

> [!div class="step-by-step"]
> <span data-ttu-id="ae96e-511">[Précédent](xref:data/ef-rp/intro) 
>  [Suivant](xref:data/ef-rp/sort-filter-page)</span><span class="sxs-lookup"><span data-stu-id="ae96e-511">[Previous](xref:data/ef-rp/intro)
[Next](xref:data/ef-rp/sort-filter-page)</span></span>

::: moniker-end
